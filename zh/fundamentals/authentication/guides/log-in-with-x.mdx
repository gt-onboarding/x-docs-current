---
title: 使用 X 登录
keywords: ["使用 X 登录", "通过 X 登录", "X 登录", "OAuth 登录", "社交登录", "X 身份验证", "登录集成"]
---

import { Button } from "/snippets/zh/button.mdx";

使用 Log in with X（也称为 Sign in with X），在您的网站或应用中添加一个按钮，使 X 用户只需点击一次即可享受注册用户账户的各项功能和优势。此功能适用于网站、iOS、移动端和桌面应用程序。

<div id="features">
  ## 功能
</div>

* 易于使用：首次访问你网站的用户只需点击两次即可完成首次登录。
* 与 X 集成：Log in with X 流程可以授予你代表用户使用 X API 的授权。
* 基于 OAuth：大量客户端库和示例代码都兼容 Log in with X API。

<div id="available-for">
  ## 适用范围
</div>

* 浏览器 - 如果你的用户可以使用浏览器，就可以集成 Log in with X。了解浏览器登录流程。
* 移动设备 - 任何可联网的移动设备都可以使用 Log in with X。了解移动端登录流程。

<div id="implementing-log-in-with-x">
  ## 实现使用 X 登录
</div>

在浏览器和移动网页上的“使用 X 登录”功能是基于 OAuth 实现的。本页演示在登录流程中获取访问令牌所需发送的请求。

要使用“使用 X 登录”流程，请前往你的 [X 应用设置](/zh/resources/fundamentals/developer-apps)，并确保已启用 *&quot;Allow this app to be used to Sign in with X?*” 选项。

本页假定读者已经了解如何使用 OAuth 1.0a 协议对请求进行签名。如果你想了解如何对请求进行签名，请阅读 [Authorizing a request](/zh/resources/fundamentals/authentication/oauth-1-0a/authorizing-a-request) 页面。

如果你想检查本页中请求的签名，所使用的 consumer secret 为：L8qq9PZyRg6ieKGEKhZolGC0vJWLw8iEJ88DRdyOg。该值仅用于测试目的，不能用于真实请求。

实现“使用 X 登录”包含三个步骤：获取请求令牌、重定向用户，以及将请求令牌转换为访问令牌。

<Tabs>
  <Tab title="步骤 1">
    ### 步骤 1：获取请求令牌

    要启动登录流程，你的 [X 应用](/zh/resources/fundamentals/developer-apps) 必须通过向 [POST oauth/request&#95;token](/zh/resources/fundamentals/authentication/api-reference#post-oauth-request-token) 发送已签名的消息来获取请求令牌。此请求中唯一的特殊参数是 oauth&#95;callback，它必须是你希望用户在完成步骤 2 后被重定向到的 URL 的 URL 编码版本。其余参数由 OAuth 签名流程添加。

    <Note>
      **注意：**你在 [POST oauth/request&#95;token](/zh/resources/fundamentals/authentication/api-reference#post-oauth-request-token) 端点中使用的任何 [回调 URL](/zh/resources/fundamentals/developer-apps#callback-urls) 都必须先在 [开发者门户](/zh/resources/fundamentals/developer-portal) 的 [X 应用设置](/zh/resources/fundamentals/developer-apps) 中注册。
    </Note>

    <Frame>
      <img src="/images/auth-4.png.twimg.1920.png" alt="" />
    </Frame>

    **示例请求（Authorization 头部已换行以便展示）：**

    ```
    POST /oauth/request_token HTTP/1.1
    User-Agent: themattharris' HTTP Client
    Host: api.x.com
    Accept: */*
    Authorization:
            OAuth oauth_callback="http%3A%2F%2Flocalhost%2Fsign-in-with-twitter%2F",
                  oauth_consumer_key="cChZNFj6T5R0TigYB9yd1w",
                  oauth_nonce="ea9ec8429b68d6b77cd5600adbbb0456",
                  oauth_signature="F1Li3tvehgcraF8DMJ7OyxO4w9Y%3D",
                  oauth_signature_method="HMAC-SHA1",
                  oauth_timestamp="1318467427",
                  oauth_version="1.0"
    ```

    你的应用应检查响应的 HTTP 状态码。任何非 200 的状态码都表示失败。响应主体中将包含 oauth&#95;token、oauth&#95;token&#95;secret 和 oauth&#95;callback&#95;confirmed 参数。你的应用应验证 oauth&#95;callback&#95;confirmed 是否为 true，并为后续步骤存储另外两个值。

    **示例响应（响应主体已换行显示）：**

    ```
    HTTP/1.1 200 OK
    Date: Thu, 13 Oct 2011 00:57:06 GMT
    Status: 200 OK
    Content-Type: text/html; charset=utf-8
    Content-Length: 146
    Pragma: no-cache
    Expires: Tue, 31 Mar 1981 05:00:00 GMT
    Cache-Control: no-cache, no-store, must-revalidate, pre-check=0, post-check=0
    Vary: Accept-Encoding
    Server: tfe

    oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0&
    oauth_token_secret=veNRnAWe6inFuo8o2u8SLLZLjolYDmDP7SzL0YfYI&
    oauth_callback_confirmed=true

    ```
  </Tab>

  <Tab title="第 2 步">
    ### 步骤 2：重定向用户

    下一步是将用户引导到 X，以便他们可以按照下文的“浏览器登录流程”完成相应流程。将用户重定向到 [GET oauth/authenticate](/zh/resources/fundamentals/authentication/api-reference#get-oauth-authenticate)，并将第 1 步中获取的请求 token 作为 oauth&#95;token 参数传递。

    网站实现这一点最无缝的方式，是在原始“登录”请求的响应中返回 HTTP 302 重定向。移动端和桌面端应用应打开一个新的浏览器窗口，或通过内嵌 web 视图跳转到该 URL。

    **要重定向到的示例 URL：**

    [https://api.x.com/oauth/authenticate?oauth&#95;token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0](https://api.x.com/oauth/authenticate?oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0)

    登录端点会根据用户的状态，以以下三种方式之一进行响应：

    1. **已登录且已授权**：如果用户已在 x.com 登录，并且已经授权调用的应用，他们会被立即完成认证，并被重定向回回调 URL，同时附带一个有效的 OAuth 请求 token。对用户来说，重定向到 x.com 几乎不可察觉。
    2. **已登录但未授权**：如果用户已在 x.com 登录，但尚未授权调用的应用，则会显示一个请求，要求用户将访问权限共享给调用的应用。在接受授权请求后，用户会被重定向到回调 URL，并附带一个有效的 OAuth 请求 token。
    3. **未登录**：如果用户尚未在 x.com 登录，会在同一页面被提示输入其凭据，并授予应用访问其信息的权限。登录完成后，用户会被重定向回回调 URL，并附带一个有效的 OAuth 请求 token。

    在认证成功后，你的 callback&#95;url 将收到一个请求，其中包含 oauth&#95;token 和 oauth&#95;verifier 参数。你的应用应验证该 token 是否与第 1 步中收到的请求 token 匹配。

    **来自客户端重定向的请求（查询字符串参数已括起）：**

    ```
    GET /sign-in-with-twitter/?
            oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0&
            oauth_verifier=uw7NjWHT6OJ1MpJOXsHfNxoAhPKpgI8BlYDhxEjIBY HTTP/1.1
    Host: localhost
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/535.5 (KHTML, like Gecko) Chrome/16.0.891.1 Safari/535.5
    Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
    Referer: http://localhost/sign-in-with-twitter/
    Accept-Encoding: gzip,deflate,sdch
    Accept-Language: en-US,en;q=0.8
    Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.3
    ```
  </Tab>

  <Tab title="第 3 步">
    ### 步骤 3：将 request token 转换为 access token

    要将 request token 转换为可用的 access token，你的应用必须向 [POST oauth/access&#95;token](/zh/resources/fundamentals/authentication/api-reference#post-oauth-access-token) 端点发起请求，其中包含在步骤 2 中获得的 oauth&#95;verifier 值。request token 也会通过请求头中的 oauth&#95;token 字段传递，但这一部分会由签名过程自动添加。

    **示例请求（Authorization 请求头已换行展示）：**

    ```
    POST /oauth/access_token HTTP/1.1
    User-Agent: themattharris' HTTP Client
    Host: api.x.com
    Accept: */*
    Authorization: OAuth oauth_consumer_key="cChZNFj6T5R0TigYB9yd1w",
                          oauth_nonce="a9900fe68e2573b27a37f10fbad6a755",
                          oauth_signature="39cipBtIOHEEnybAR4sATQTpl2I%3D",
                          oauth_signature_method="HMAC-SHA1",
                          oauth_timestamp="1318467427",
                          oauth_token="NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0",
                          oauth_version="1.0"
    Content-Length: 57
    Content-Type: application/x-www-form-urlencoded

    oauth_verifier=uw7NjWHT6OJ1MpJOXsHfNxoAhPKpgI8BlYDhxEjIBY
    ```

    成功的响应包含 oauth&#95;token 和 oauth&#95;token&#95;secret 参数。应当存储该 token 和 token secret，并在后续对 X API 的已认证请求中使用。要确定用户的身份，请使用 [GET account/verify&#95;credentials](https://dev.x.com/rest/reference/get/account/verify_credentials)。

    **示例响应（响应正文已做换行处理）：**

    ```
    HTTP/1.1 200 OK
    Date: Thu, 13 Oct 2011 00:57:08 GMT
    Status: 200 OK
    Content-Type: text/html; charset=utf-8
    Content-Length: 157
    Pragma: no-cache
    Expires: Tue, 31 Mar 1981 05:00:00 GMT
    Cache-Control: no-cache, no-store, must-revalidate, pre-check=0, post-check=0
    Vary: Accept-Encoding
    Server: tfe

    oauth_token=7588892-kagSNqWge8gB1WwE3plnFsJHAZVfxWD7Vb57p0b4&
    oauth_token_secret=PbKfYqSryyeKDWz4ebtY3o5ogNLG11WJuZBc9fQrQo
    ```
  </Tab>
</Tabs>

<Tabs>
  <Tab title="更多资源">
    ### 使用 X 登录相关资源

    #### 客户端库

    [X libraries](/zh/resources/tools-and-libraries) 中列出的客户端库将帮助你实现“使用 X 登录”（Log in with X）功能。请按照前述步骤所述，使用 `/oauth/authenticate` 端点。

    #### 品牌工具包

    X 建议你的应用使用官方的 [X Brand Toolkit](https://about.x.com/en/who-we-are/brand-toolkit) 以保持品牌一致性。请保存这些素材，并在创建 “Log in with X” 按钮时使用它们。
  </Tab>

  <Tab title="浏览器登录流程">
    浏览器登录流程适用于能够打开或嵌入 Web 浏览器的网站和应用。从整体上来看：

    * 应用显示一个 “Sign in with X” 链接或按钮。
    * 用户点击登录按钮。
    * 当前 Web 浏览器被重定向到 X（或打开一个新的浏览器并跳转到 X）。
    * 如有需要，用户在 X 上完成登录和授权步骤。
    * X 重定向回应用控制下的一个 URL，并为该用户传递授权信息。

    X 会跟踪授权情况，因此，对于已经在 X.com 登录并授权过该应用的用户，不会显示任何界面——而是会自动将他们重定向回应用。

    ### 桌面端流程

    <Frame>
      <img src="/images/browser_111.png" alt="" />
    </Frame>

    为演示这些流程，假设上图中的网站（“The greatest website ever created”）已经实现了此 API，这可以从其登录页上的 Sign in with X 按钮看出。

    当用户点击 Sign in 按钮时，他们看到的页面取决于是否已登录，以及是否曾允许该应用访问其账户。

    当用户已登录 x.com 但尚未授予访问权限时，会显示一个所请求权限的列表，以及 Sign In 和 Cancel 按钮。

    当用户尚未登录 x.com 时，会显示用户名和密码输入字段。请注意，即使用户已经向应用授予过访问权限，权限列表仍然会显示。

    <Frame>
      <img src="/images/browser_2.png" alt="" />
    </Frame>

    <Frame>
      <img src="/images/browser_3.png" alt="" />
    </Frame>

    <Frame>
      <img src="/images/browser_4.png" alt="" />
    </Frame>

    在用户输入有效凭证（如有需要）并点击 “Sign In” 之后，X 会将用户重定向回发起登录流程的网站。

    如果用户已经登录 x.com 并已向该网站授予访问权限，则会立即进行此重定向。
  </Tab>

  <Tab title="移动端登录流程">
    移动 Web 浏览器的 UI 流程与浏览器登录流程完全相同，但针对移动浏览器进行了优化。

    下面是已登录、未登录以及重定向页面的截图：

    <Frame>
      <img src="/images/authorize-login-screenshot.png" alt="" />
    </Frame>

    <Frame>
      <img src="/images/authorize-logged-in" alt="" />
    </Frame>

    <Frame>
      <img src="/images/redirect-application.png" alt="" />
    </Frame>
  </Tab>
</Tabs>