---
title: 为请求授权
sidebarTitle: 为请求授权
keywords: ["为请求授权", "OAuth 授权", "请求授权", "OAuth 1.0a 授权", "API 请求授权"]
---

import { Button } from "/snippets/zh/button.mdx";

<div id="authorizing-a-request">
  ### 授权请求
</div>

本文档旨在向你展示如何修改 HTTP 请求，从而向 X API 发送授权请求。

X 的所有 API 都基于 HTTP 协议。这意味着，你编写的任何使用 X API 的软件，都会向 X 的服务器发送一系列结构化消息。比如，一个将文本 “**Hello Ladies + Gentlemen, a signed OAuth request!**” 作为帖子发布的请求，大致会是下面这样的形式：

```
POST /1.1/statuses/update.json?include_entities=true HTTP/1.1
Accept: */*
Connection: close
User-Agent: OAuth gem v0.4.4
Content-Type: application/x-www-form-urlencoded
Content-Length: 76
Host: api.x.com

status=Hello%20Ladies%20%2b%20Gentlemen%2c%20a%20signed%20OAuth%20request%21
```

任何 HTTP 库都应该能够较为轻松地生成并发送上述请求。不过，由于无法获知以下信息，上述请求被视为无效：

1. 是哪个应用在发出请求
2. 该请求代表的是哪位用户发帖
3. 该用户是否已授予该应用代表其发帖的授权
4. 该请求在传输过程中是否被第三方篡改

为了让应用能够提供这些信息，X 的 API 依赖于 [OAuth 1.0a 协议](http://tools.ietf.org/html/rfc5849)。简单来说，X 的实现要求所有需要授权的请求都必须包含一个额外的 HTTP Authorization 头，其中包含足够的信息来回答上述问题。下面是前面展示的 HTTP 请求的一个版本，它被修改为包含这个头（通常 Authorization 头需要写在同一行，这里为了便于阅读进行了换行展示）：

```
POST /1.1/statuses/update.json?include_entities=true HTTP/1.1
Accept: */*
Connection: close
User-Agent: OAuth gem v0.4.4
Content-Type: application/x-www-form-urlencoded
Authorization:
OAuth oauth\_consumer\_key="xvz1evFS4wEEPTGEFPHBog",
oauth_nonce="kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg",
oauth_signature="tnnArxj06cWHq44gCs1OSKk%2FjLY%3D",
oauth\_signature\_method="HMAC-SHA1",
oauth_timestamp="1318622958",
oauth_token="370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb",
oauth_version="1.0"
Content-Length: 76
Host: api.x.com

status=Hello%20Ladies%20%2b%20Gentlemen%2c%20a%20signed%20OAuth%20request%21
```

在创建此请求时，X API 会将其视为有效请求并予以接受。

如果这个签名过程看起来超出了你的集成实现范围，可以考虑使用 [Web Intents](https://dev.x.com/web/intents)，它在与 X API 交互时不需要使用 OAuth。
 

**收集参数**

你应该能看到该 header 包含 7 个键值对，并且这些键都以字符串 “oauth&#95;” 开头。对于任意一次 X API 请求，只要收集这 7 个值并创建一个类似的 header，就可以为该请求完成授权。每个值是如何生成的，将在下面进行说明：

**Consumer key**

`oauth&#95;consumer&#95;key` 用于标识是哪一个应用正在发出请求。你可以在 [开发者门户](/zh/resources/fundamentals/developer-portal) 中所使用的 [X app](/zh/resources/fundamentals/developer-apps) 的设置页面获取这个值。

|                            |                        |
| :------------------------- | :--------------------- |
| oauth&#95;consumer&#95;key | xvz1evFS4wEEPTGEFPHBog |

**Nonce**

`oauth&#95;nonce` 参数是你的应用应为每个唯一请求生成的唯一令牌。X 会使用该值来判断一个请求是否被多次提交。此请求中的值是通过对 32 字节的随机数据进行 base64 编码，并去除所有非单词字符生成的，但任何能产生相对随机的字母数字字符串的方法在这里都可以接受。

|                 |                                            |
| :-------------- | :----------------------------------------- |
| oauth&#95;nonce | kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg |

**Signature**

`oauth_signature` 参数包含一个通过签名算法生成的值，该值由所有其他请求参数以及两个密钥值共同参与计算得出。签名的目的在于让 X 能够验证请求在传输过程中未被篡改、验证发送请求的应用，以及验证该应用是否有权与用户的账户进行交互。

针对本次请求计算 `oauth_signature` 的过程在 [Creating a signature](/zh/resources/fundamentals/authentication/oauth-1-0a/creating-a-signature) 中有详细说明。

|     |     |
| :--- | :--- |
| oauth&#95;signature | tnnArxj06cWHq44gCs1OSKk/jLY= |

**Signature method**

X 使用的 `oauth_signature_method` 为 HMAC-SHA1。对于发送到 X API 的任何已授权请求，都应使用该值。

|     |     |
| :--- | :--- |
| oauth&#95;signature&#95;method | HMAC-SHA1 |

**Timestamp**

`oauth_timestamp` 参数表示请求创建的时间。该值应为生成请求时自 Unix 纪元（Unix epoch）起经过的秒数，在大多数编程语言中都可以方便地生成。X 会拒绝创建时间过早的请求，因此务必确保发出请求的计算机时间与 NTP 保持同步。

|     |     |
| :--- | :--- |
| oauth&#95;timestamp | 1318622958 |

**Token**

`oauth_token` 参数通常表示用户授权你的应用共享其账户访问权限。在少数几种身份验证请求中，此值不会传递，或采用不同形式的 token，但这些情况在 [Obtaining access tokens](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens) 中有详细说明。对于大多数通用请求，你将使用所谓的 **access token（访问令牌）**。

你可以在 [开发者门户](/zh/resources/fundamentals/developer-portal) 中的 [X app](/zh/resources/fundamentals/developer-apps) 设置页面，为你的账户生成一个有效的 [access token](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)。

|     |     |
| :--- | :--- |
| oauth&#95;token | 370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb |

**Version**

对于发送到 X API 的任何请求，`oauth_version` 参数都应始终为 1.0。

|     |     |
| :--- | :--- |
| oauth&#95;version | 1.0 |

<div id="building-the-header-string">
  #### 构建 header 字符串
</div>

要构建 header 字符串，可以想象你在向一个名为 DST 的字符串写入内容。

1. 将字符串 “OAuth ”（包括末尾的空格）追加到 DST。
2. 对于上述列出的 7 个参数的每个键值对：
   1. 将键进行[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)，然后追加到 DST。
   2. 向 DST 追加等号字符 ‘=’。
   3. 向 DST 追加双引号 ‘”’。
   4. 将值进行[百分号编码](/zh/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)，然后追加到 DST。
   5. 向 DST 追加双引号 ‘”’。
   6. 如果还有剩余的键值对，向 DST 追加逗号 ‘,’ 和一个空格 ‘ ‘。

在构建该字符串时，要特别注意对值进行百分号编码。例如，oauth&#95;signature 的值 tnnArxj06cWHq44gCs1OSKk/jLY= 必须编码为 tnnArxj06cWHq44gCs1OSKk%2FjLY%3D。

对上面收集到的参数执行这些步骤后，将得到如下字符串：

```
OAuth oauth\_consumer\_key="xvz1evFS4wEEPTGEFPHBog", oauth\_nonce="kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg", oauth\_signature="tnnArxj06cWHq44gCs1OSKk%2FjLY%3D", oauth\_signature\_method="HMAC-SHA1", oauth\_timestamp="1318622958", oauth\_token="370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb", oauth_version="1.0"
```

应将该值设置为请求的 Authorization 头部。
