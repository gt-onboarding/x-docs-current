---
title: 集成指南
sidebarTitle: 集成指南
keywords: ["私信集成", "DM 集成", "DM 查询集成", "私信集成指南", "DM 设置"]
---

import { Button } from '/snippets/zh/button.mdx';

Direct Messages v2 端点将会话和会话事件作为核心 X API 对象引入，并区分 1-1 会话和群组会话。1-1 会话始终只有两个且仅有两个参与者，而群组会话可以有两个或更多参与者，且成员可以变更。   

本页包含一些在你将 Direct Messages 查询端点集成到系统时需要了解的工具和关键概念。我们将本页分为两个部分：

* 关键概念
  * [Direct Message 会话](#direct-message-conversations)
  * [在 v1.1 和 v2 之间共享的会话和事件 ID](#shared-conversation-and-event-ids)
  * [Direct Message 事件字段和扩展字段](#direct-message-event-fields-and-expansions)
  * [会话事件类型](#conversation-event-types)
  * [身份验证](#authentication)
  * [开发者门户、项目和应用](#developer-portal-projects-and-apps)
  * [速率限制](#rate-limits)
  * [分页](#pagination)
* [实用工具](#helpful-tools)

<div id="key-concepts">
  ### 关键概念
</div>

<div id="direct-message-conversations">
  ### 私信会话
</div>

所有私信（Direct Message）都属于某个私信会话。会话可以是一对一会话，也可以是群组会话。本次发布提供了创建私信以及检索与私信会话相关事件所需的基础端点。所有会话都有唯一的 `dm_conversation_id`，构成该会话的所有事件都有唯一的 `dm_event_id`。  

私信查找端点提供了检索与会话相关事件的方法。这些 GET 端点用于检索构成某个会话的消息；对于群组会话，还可以用来了解是谁加入和离开了群组会话。

本次 Direct Messages 查找功能的初始版本包含三个 GET 方法：

* **GET /2/dm&#95;conversations/with/:participant&#95;id/dm&#95;events** - 检索与一对一会话相关的私信事件。`:participant_id` 路径参数是与发起此请求的已认证用户进行会话的账户的数字用户 id。  

* **GET /2/dm&#95;conversations/:dm&#95;conversation&#95;id/dm&#95;events** - 检索与特定会话 ID 相关的私信事件，由 `:dm_conversation_id` 路径参数指定。支持一对一会话和群组会话的会话 ID。  

* **GET /2/dm&#95;events** - 检索与已认证用户相关的私信事件，包括一对一和群组会话。最多可获取过去 30 天内的事件。  

这些 GET 端点都支持通过事件类型来检索 `dm_events`，使用 `event_types` 请求查询参数。目前支持三种会话事件类型：

* **MessageCreate** - 在创建新的私信时生成。此事件对象可以包含消息的时间和文本、发送消息的账户 ID，以及会话和事件 ID。 

* **ParticipantsJoin** - 当新参与者加入群组会话时生成。此 `dm_event` 对象包含加入者的 ID、`created_at` 时间，以及“邀请”事件的 `sender_id`。 

* **ParticipantsLeave** - 当参与者离开会话时生成。此事件对象包含离开者的 ID 以及事件发生的时间。 

更多信息请参见 [Direct Messages 查找 API 参考](/zh/x-api/direct-messages/get-dm-events-for-a-dm-conversation)。

<div id="shared-conversation-and-event-ids-across-v11-and-v2">
  ### 在 v1.1 和 v2 中共享的会话和事件 ID
</div>

一个重要的概念是，会话和事件 ID 在 X 平台的 v1.1 和 v2 版本之间是共享的。这意味着你可以同时使用这两个版本。例如，Direct Messages v1.1 端点提供了返回单个事件和删除事件的方法，而这些方法在 v2 中尚不可用。由于 ID 在 v1.1 和 v2 之间是通用的，你可以基于 v2 提供的 ID 发起 v1.1 请求，或者引用 X 应用中会话 URL 里显示的会话 ID 来发起 v1.1 请求。  

<div id="direct-message-event-fields-and-expansions">
  ### 私信事件字段和扩展字段
</div>

X API v2 允许用户使用一组称为字段和扩展字段的工具，精确选择希望从 API 返回的具体数据。例如，私信查询端点支持以下 dm&#95;events 字段： 

* id、event&#95;type 和 text 是 MessageCreate 事件的默认字段。 

* id、event&#95;type 和 participant&#95;ids 是 ParticipantsJoin 和 ParticipantsLeave 事件的默认字段。

* dm&#95;conversation&#95;id 和 created&#95;at 适用于所有事件。

* attachments 和 referenced&#95;tweets 适用于 MessageCreate 事件。 

* sender&#95;id 适用于 MessageCreate 和 ParticipantsJoin 事件。 

* participant&#95;ids 适用于 ParticipantsJoin 和 ParticipantsLeave 事件。 

此外，私信查询端点还支持以下[扩展字段](/zh/x-api/fundamentals/expansions)：

* sender&#95;id - 将扩展为与发送消息或邀请他人加入会话的用户关联的 User 对象。 

* referenced&#95;tweets.id - 如果私信文本中包含指向某个帖子（Post）的链接，则会扩展为该 Post 对象。 

* attachments.media&#95;keys - 如果私信中包含媒体附件，则会扩展为相应的 Media 对象。 

* participant&#95;ids - 将扩展为与加入或离开群组会话的用户关联的 User 对象。

由于扩展字段会返回帖子、用户和媒体对象，你还可以使用 tweet.fields、user.fields 和 media.fields 查询参数。更多信息请参阅我们的[如何使用字段和扩展字段](/zh/x-api/fundamentals/data-dictionary#how-to-use-fields-and-expansions)指南。

<div id="conversation-event-types">
  ### 会话事件类型
</div>

下面是 Direct Message 中 MessageCreate、ParticipantsJoin 和 ParticipantsLeave 事件类型的示例 JSON 对象。 

可用的 dm&#95;event 对象字段：id、text、event&#95;type、dm&#95;conversation&#95;id、created&#95;at、sender&#95;id、attachments、referenced&#95;tweets、participant&#95;ids。有关在请求中选择这些字段的更多详情，请参见 Fields and Expansion 部分。 

MessageCreate 事件示例： 

在指定了所有 dm&#95;event 字段的情况下，下面是一条简单文本 Direct Message 的响应： 

`{
    "text": "Hi everyone.",
    "sender_id": "944480690",
    "dm_conversation_id": "1578398451921985538",
    "id": "1582838499983564806",
    "event_type": "MessageCreate",
    "created_at": "2022-10-19T20:58:00.000Z"
}`

ParticipantsJoin 事件示例：

在指定了所有 dm&#95;event 字段的情况下，下面是一个参与者加入会话时的响应：

`{
    "participant_ids": [
        "944480690"
    ],
    "sender_id": "17200003",
    "dm_conversation_id": "1578398451921985538",
    "id": "1582835469712138240",
    "event_type": "ParticipantsJoin",
    "created_at": "2022-10-19T20:45:58.000Z"
}`

ParticipantsLeave 事件示例：

在指定了所有 dm&#95;event 字段的情况下，下面是一个参与者离开会话时的响应：

`{
    "participant_ids": [
        "944480690"
    ],
    "dm_conversation_id": "1578398451921985538",
    "id": "1582838535115067392",
    "event_type": "ParticipantsLeave",
    "created_at": "2022-10-19T20:58:09.000Z"
    }`

<div id="authentication">
  ### 认证
</div>

所有 X API v2 端点都要求你使用一组凭证（也称为密钥和令牌）对请求进行认证。所有私信（Direct Messages）都是私密的，需要用户授权才能访问。 

这些私信相关端点需要使用 [OAuth 2.0 Authorization Flow with PKCE](/zh/x-api/posts/manage-tweets) 或 [1.0a User Context](/zh/resources/fundamentals/authentication)，这意味着你必须使用一组 API 密钥和用户访问令牌来发起成功的请求。访问令牌必须与你代表其发起请求的用户关联。如果你希望为其他用户生成一组访问令牌，他们必须通过 [三方 OAuth 流程](/zh/resources/fundamentals/authentication#obtaining-access-tokens-using-3-legged-oauth-flow) 授权或认证你的应用。

请注意，带用户上下文的 OAuth 使用起来可能比较复杂。如果你对这种认证方式不熟悉，建议使用一个[库](/zh/x-api/tools-and-libraries/overview)或 Postman 等工具来正确完成请求认证。 

[OAuth 2.0 Authorization Code with PKCE](resources/fundamentals/authentication#oauth-2-0-authorization-code-flow-with-pkce-2) 允许对应用的作用域以及跨多设备的授权流程进行更精细的控制。OAuth 2.0 允许你选择特定的细粒度作用域，从而代表用户获取特定权限。私信查询端点需要以下作用域：dm.read、post.read、user.read

要在你的应用中启用 OAuth 2.0，你必须在开发者门户中该应用“应用设置”部分的认证设置里将其启用。

<div id="developer-portal-projects-and-developer-apps">
  ### 开发者门户、项目和开发者应用
</div>

要获取一组可用于 X API v2 端点的身份验证凭证，你必须拥有一个已获批准的开发者账号，在该账号下创建一个项目，并在该项目中创建一个开发者应用。然后你可以在该开发者应用中找到你的密钥和令牌。 

<div id="rate-limits">
  ### 速率限制
</div>

每天有成千上万的开发者向 X API 发起请求。为了管理如此庞大的请求量，我们对每个端点都设置了速率限制，用于限制你代表应用或代表已通过身份验证的用户所能发起的请求数量。 

Direct Message 查询类端点在用户级别实施速率限制，这意味着你代表其发起请求的已认证用户，在通过你的 X 应用访问这些端点时，在一定时间内只能发起限定数量的请求。对于 GET 方法，用户级速率限制为每 15 分钟 300 次请求。这些速率限制在所有 GET 端点之间共享。 

<div id="pagination">
  ### 分页
</div>

这些端点使用分页机制，以便快速返回响应。当结果数量超过单个响应可返回的上限（最多 100 个事件）时，你就需要进行分页。使用 `max_results` 参数来指定每页返回多少结果，并使用 `pagination_token` 参数来获取下一页的结果。你可以通过查阅我们的[分页指南](/zh/x-api/fundamentals/pagination)了解更多信息。

**实用工具**

在使用 Direct Messages 查询端点时，我们鼓励你探索以下这些实用工具： 

****Postman****

Postman 是一个非常适合用于测试端点的工具。每个 Postman 请求都包含所有路径和请求体参数，帮助你快速了解有哪些可用的参数和选项。要进一步了解我们的 Postman 集合，请访问我们的[使用 Postman](/zh/tutorials/postman-getting-started)页面。 

****代码示例****

适用于 v2 Direct Messages 端点的 Python 示例代码可在我们的 [X API v2 示例代码 GitHub](https://github.com/xdevplatform/Twitter-API-v2-sample-code) 仓库中找到。&quot;Manage-Direct-Messages&quot; 文件夹包含 POST 方法的示例，而 &quot;Direct-Messages-lookup&quot; 文件夹包含 GET 方法的示例。

****XDev 软件开发工具包 (SDK)****

这些[库](/zh/x-api/tools-and-libraries/overview)正在针对 v2 Direct Messages 端点进行更新，很快就会准备就绪：

* [X API Java SDK](https://github.com/xdevplatform/twitter-api-java-sdk) - X API v2 的官方 Java SDK
* [X API TypeScript/JavaScript SDK](https://github.com/xdevplatform/twitter-api-typescript-sdk) - X API v2 的官方 TS/JS SDK

**第三方库**

我们的社区开发了数量不断增长的[第三方库](/zh/x-api/tools-and-libraries/overview#community-tools-and-libraries-for-v2)。这些库旨在帮助你快速上手，并且预计很快会有多个库支持 v2 Direct Messages 端点。你可以通过查看相应的版本标签来找到适用于 v2 端点的库。