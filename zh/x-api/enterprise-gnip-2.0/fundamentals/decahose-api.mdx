---
title: Decahose API
keywords: ["Decahose", "10% 流", "decahose API", "enterprise decahose", "10% 抽样流", "enterprise 流式数据"]
---

<Note>
  此端点已更新，现在包含帖子编辑元数据。要了解这些元数据的更多信息，请参阅[“编辑帖子”基础知识页面](/zh/x-api/enterprise-gnip-2.0/fundamentals/edit-tweets)。
</Note>

<div id="decahose-stream">
  ### Decahose 流
</div>

[Enterprise](https://developer.x.com/en/products/x-api/enterprise)

*这是仅在我们的托管访问级别中提供的 Enterprise API。要使用此 API，您必须先通过我们的 Enterprise 销售团队开通账户。[了解更多](https://developer.x.com/en/products/x-api/enterprise)*

Decahose 通过流式连接提供 X 实时 Firehose 的 10% 随机样本。这是通过实时采样算法实现的，该算法随机选择数据，同时在 X 将数据通过 Firehose 发送时，仍然可以按预期实现低延迟的数据传输。

以下是 Decahose 提供的一些特性：

* **扩展和增强的 URL：** - 可完全展开缩短的 URL，并提供额外的元数据（页面标题和描述）
* **流分区** - 2 个分区，每个分区包含 Decahose 整体流量的 50%
* **增强的可靠性** - 后端系统具备地域多样性部署

注意：此数据以批量方式交付，不支持额外过滤（例如按关键字）。

`ENTERPRISE`

<div id="streaming-likes">
  ### 点赞流式传输
</div>

*这是一项仅在我们的托管访问级别中提供的 Enterprise API。若要使用此 API，必须先通过我们的 Enterprise 销售团队开设账户。[了解更多](https://developer.x.com/en/products/x-api/enterprise)*

点赞可以帮助你了解是谁点赞了帖子，并提供准确的点赞计数。Gnip 的 Firehose 和 Decahose 可以传送与通过 Gnip 传送的帖子相关的公开点赞。这会生成与某条帖子相关的实时公开互动和受众指标。
 

**开始使用点赞流**

在准备使用点赞数据时，你应当了解：

* 点赞通过独立的数据流传送
* 点赞过去通常被称为“Favorites（收藏）”。增强型原生格式有效负载保留了这一命名方式
* 流中仅包含公开点赞
  * 公开是指点赞用户、帖子创建者和帖子在平台上都是公开的
* 点赞与转发非常相似，代表着一种公开的互动信号
* 有效负载元素包括：
  * 原始 Post 对象
  * 创建原始 Post 的参与者（Actor）对象
  * 执行点赞操作的参与者（Actor）对象
* 只有原创内容可以被点赞
  * 转发不能被点赞。对转发的点赞会应用到原始帖子上
  * 引用推文 *可以* 被点赞
* 点赞活动会包含适用的 Gnip Enrichments（在购买/应用的情况下）
* 支持的产品 / 功能
  * 点赞流支持 Backfill（在购买/应用的情况下）
  * 点赞流不支持 Replay
  * 点赞不支持 Search 或 Historical
  * 当前没有将点赞支持添加到 PowerTrack 的计划

**Decahose**

* 对于在 Decahose 中传送的 10% 抽样帖子，流中会包含 100% 的适用公开点赞
* **分区数：** 2
* **URL 结构**
  * https://gnip-stream.x.com/stream/sample10-likes/accounts/&lt;accountName&gt;/publishers/twitter/&lt;streamLabel&gt;.json?partition=1

**原生增强格式有效负载**

```json
{
   "id":"43560406e0ad9f68374445f5f30c33fc",
   "created_at":"Thu Dec 01 22:27:39 +0000 2016",
   "timestamp_ms":1480631259353,
   "favorited_status":{
      "created_at":"Thu Dec 01 22:27:16 +0000 2016",
      "id":804451830033948672,
      "id_str":"804451830033948672",
      "text":"@kafammheppduman",
      "source":"\u003ca href=\"http:\/\/x.com\/download\/android\" rel=\"nofollow\"\u003eX Android 版\u003c\/a\u003e",
      "truncated":false,
      "in_reply_to_status_id":803694205163814912,
      "in_reply_to_status_id_str":"803694205163814912",
      "in_reply_to_user_id":2855759795,
      "in_reply_to_user_id_str":"2855759795",
      "in_reply_to_screen_name":"kafammheppduman",
      "user":{
         "id":2855759795,
         "id_str":"2855759795",
         "name":"delirdim kanka",
         "screen_name":"kafammheppduman",
         "location":"sanane",
         "url":"http:\/\/instagram.com\/kafammheppduman",
         "description":"Manit @GalatasaraySk \ud83d\udc9e",
         "translator_type":"none",
         "protected":false,
         "verified":false,
         "followers_count":3702,
         "friends_count":607,
         "listed_count":1,
         "favourites_count":113338,
         "statuses_count":389,
         "created_at":"Sat Nov 01 22:38:25 +0000 2014",
         "utc_offset":null,
         "time_zone":null,
         "geo_enabled":true,
         "lang":"tr",
         "contributors_enabled":false,
         "is_translator":false,
         "profile_background_color":"C0DEED",
         "profile_background_image_url":"",
         "profile_background_image_url_https":"",
         "profile_background_tile":false,
         "profile_link_color":"1DA1F2",
         "profile_sidebar_border_color":"C0DEED",
         "profile_sidebar_fill_color":"DDEEF6",
         "profile_text_color":"333333",
         "profile_use_background_image":true,
       "Profile_image_url": "http:\/\/pbs.twimg.com\/profile_images\/804421763945861121\/v3bp9pnq_normal.jpg",
         "Profile_image_url_https": "https:\/\/pbs.twimg.com\/profile_images\/804421763945861121\/v3bp9pnq_normal.jpg",
         "profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/2855759795\/1480630085",
         "default_profile":true,
         "default_profile_image":false,
         "following":null,
         "follow_request_sent":null,
         "notifications":null
      },
      "geo":null,
      "coordinates":null,
      "place":null,
      "contributors":null,
      "is_quote_status":false,
      "retweet_count":0,
      "favorite_count":0,
      "entities":{
         "hashtags":[],
         "urls":[],
         "user_mentions":[
            {
               "screen_name":"kafammheppduman",
               "name":"delirdim kanka",
               "id":2855759795,
               "id_str":"2855759795",
               "indices":[
                  0,
                  16
               ]
            }
         ],
         "symbols":[]
      },
      "favorited":false,
      "retweeted":false,
      "filter_level":"low",
      "lang":"und"
   },
   "user":{
      "id":774146932365070336,
      "id_str":"774146932365070336",
      "name":"Uyuyan Adam",
      "screen_name":"saykoMenn",
      "location":"Tarsus, T\u00fcrkiye",
      "url":"http:\/\/connected2.me\/pmc1i",
      "description":null,
      "translator_type":"none",
      "protected":false,
      "verified":false,
      "followers_count":414,
      "friends_count":393,
      "listed_count":0,
      "favourites_count":9868,
      "statuses_count":370,
      "created_at":"Fri Sep 09 07:26:26 +0000 2016",
      "utc_offset":null,
      "time_zone":null,
      "geo_enabled":false,
      "lang":"tr",
      "contributors_enabled":false,
      "is_translator":false,
      "profile_background_color":"F5F8FA",
      "profile_background_image_url":"",
      "profile_background_image_url_https":"",
      "profile_background_tile":false,
      "profile_link_color":"1DA1F2",
      "profile_sidebar_border_color":"C0DEED",
      "profile_sidebar_fill_color":"DDEEF6",
      "profile_text_color":"333333",
      "profile_use_background_image":true,
      "Profile_image_url": "http:\/\/pbs.twimg.com\/profile_images\/802992813424201728\/VMzcTL3x_normal.jpg",
      "Profile_image_url_https": "https:\/\/pbs.twimg.com\/profile_images\/802992813424201728\/VMzcTL3x_normal.jpg",
      "profile_banner_url":"https:\/\/pbs.twimg.com\/profile_banners\/774146932365070336\/1480283382",
      "default_profile":true,
      "default_profile_image":false,
      "following":null,
      "follow_request_sent":null,
      "notifications":null
   }
}
```

**删除点赞 / “取消点赞” 负载**

```json
{
   "delete":{
      "favorite":{
         "tweet_id":696615514970279937,
         "tweet_id_str":"696615514970279937",
         "user_id":2510287578,
         "user_id_str":"2510287578"
      },
      "timestamp_ms":"1480437031205"
   }
}
```

<div id="guides">
  ## 指南
</div>

<div id="recovery-and-redundency">
  ### Recovery and Redundency
</div>

**简介** 

在高吞吐量实时帖子流式传输的场景下，有一系列最佳实践可以提升数据可靠性并确保数据的完整保真度。在消费实时数据时，最大化连接持续时间是一个基本目标。当发生断连时，自动检测并重连非常重要。重连之后，还需要评估是否存在需要回补数据的时间段。负责管理这些细节并消费实时帖子的组件，只是一个更大系统中的一部分，该系统还涉及网络、数据存储、服务器和存储等方面。鉴于这些系统的复杂性，另一项最佳实践是使用不同的流式环境，至少要为开发/测试和生产环境分别配置独立的流。

Decahose 提供了一组有助于实现这些目标的功能。

1. 为支持多个环境，我们可以为你的账户部署 [Additional Streams](#AdditionalStreams)。这些流彼此独立，并具有不同的 stream&#95;label，以便加以区分。
2. 为了帮助维持连接，每个 Decahose 流都支持[冗余连接](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#additional-streams)。最常见的架构是，一个流拥有两个连接，而在客户端有两个相互独立的消费者——理想情况下运行在不同的网络上。通过这种设计，可以在客户端网络、服务器和数据存储路径之间实现冗余。请注意，每个连接都会提供一份完整的数据副本，因此客户端必须能够容忍并处理重复数据。
3. 每 10 秒会提供一次“**心跳**”；然而，对于 Decahose 流来说，其数据量足够大，以至于即便是一个很短的时间段（例如几秒钟）内没有帖子，都可能表明存在连接问题。因此，既可以通过“数据静默”，也可以通过缺少心跳来检测断连。

由于断连不可避免，Decahose 流提供了专门的[恢复](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#overview)和[回补](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#backfill)功能，用于帮助恢复因断连和其他运维问题而遗漏的数据。

<div id="additional-streams">
  #### 额外的流
</div>

增加额外的 Decahose 流是将可靠性构建到解决方案中的另一种方式。任何额外的流都是完全独立的，并拥有其唯一的 endpoint。每个流都会被分配自己的 stream&#95;label，该标签会与您的账户名称一起，构成该流 URL 的一部分。请参见下面的示例：

https://gnip-stream.x.com/stream/sample10/accounts/:account&#95;name/publishers/twitter/:stream&#95;label.json

最常见的做法是：为生产系统专门提供一个实时流，并额外提供一个用于开发和测试的流。拥有一个测试/开发流，使 Decahose 客户可以使用该流来测试客户端消费者（consumer）的更新。虽然任何（唯一的）标签都可以分配给一个流，但一种惯例是对生产流使用 “prod”，而对额外的开发流使用 “dev” 或 “sandbox”。

流的数量及其唯一标签可以由您的客户经理进行配置。

**冗余连接**

冗余连接允许您对同一数据流建立多个并发连接。这样，您可以使用两个独立的消费者（consumer）连接到同一个流，并通过这两个连接接收相同的数据，从而提供冗余。因此，您的应用在多种情况下具备热故障切换能力，例如当其中一个流断开连接，或应用的主服务器发生故障时。

对于任何给定的流，允许的连接数量可以由您的客户经理进行配置。要使用冗余流，只需连接到用于主连接的相同 URL。您的流数据会通过两个连接发送，并且这两个流连接都会在流仪表板上显示。

请注意，就计费而言，我们会对您通过多个连接接收到的 activity 计数进行去重，这样您只会为每个唯一的 activity 支付一次费用。鉴于 Decahose 具有两个分区，下面是连接计数如何工作的示例：

连接到 decahose partition=1\
连接到 decahose partition=1\
连接到 decahose partition=2

上述情况总共产生三个连接——两个连接到 partition=1，一个连接到 partition=2。通常，您会希望每个分区的连接数量相同，因此该示例突显了一种情况：对 partition=2 的冗余连接已掉线，您需要进一步排查。

**恢复**

<div id="overview">
  #### 概述
</div>

Recovery 是一款数据恢复工具（不应用作主要数据采集手段），可提供对最近 5 天 X 历史数据滚动时间窗口的流式访问。它应在以下场景中用于恢复数据：当你的消费端应用在实时流中漏接数据时，无论是因为短时间断开连接，还是出于任何其他导致你在一段时间内未能接收实时数据的原因。

<div id="using-recovery">
  #### 使用 Recovery
</div>

通过 Recovery 流，你的应用可以向其发出请求，其行为方式与向实时流发起的请求相同。不过，你的应用必须在 URL 中指定参数来表明你请求的时间窗口。换句话说，一个 Recovery 请求会向 API 请求“从时间 A 到时间 B 的帖子（Post）”。这些帖子随后会通过你的流式连接被发送，其方式模仿实时流，但速率会略慢于实时。示例如下：

&quot;https://stream-data-api.x.com/stream/powertrack/accounts/someAccountName/publishers/twitter/powertrack.json?startTime=2023-07-05T17:09:12.070Z&quot;

帖子会从指定时间段中最早的一分钟开始投递，并按时间顺序持续投递，直到最后一分钟的数据被投递完成。届时，会通过连接发送一条 Recovery Request Completed 消息，然后服务器会关闭该连接。如果你的请求从某个匹配结果很少甚至没有的时间点开始，那么在首次结果被投递之前，很可能会有一段等待时间——当 Recovery 在其当时正在处理的归档分段中遇到匹配结果时，数据才会被投递。当暂时没有可投递的结果时，流会持续通过连接发送回车符，或“心跳”消息，以防止你的连接超时。

Recovery 旨在作为一个工具，用于轻松恢复因短暂断线而错过的数据，而不是用于恢复诸如整天这样非常长时间段的数据。如果需要恢复长时间段的数据，我们建议将较长的请求拆分为较短的时间窗口（例如两小时），以降低由于网络波动或其他原因在请求中途断开连接的可能性，并让你对长时间请求的处理进度有更清晰的掌握。

<div id="data-availability">
  #### 数据可用性
</div>

如果你无法在 5 分钟回填窗口内重新连接，可以使用 Recovery 功能在过去 24 小时内恢复遗漏的数据。

流式恢复功能允许你将回填窗口扩展到 24 小时。Recovery 使你能够“恢复”遗漏数据的这段时间区间。当你在连接请求中使用 `start_time` 和 `end_time` 请求参数时，就会启动一个恢复流。连接成功后，Recovery 会重新流式传输指定时间段的数据，然后断开连接。  

你可以同时向 Recovery 发起 2 个并发请求，即“两项恢复作业”。在技术实现上，Recovery 与回填的工作方式相同，只是额外定义了开始时间和结束时间。一次恢复周期只对应单一的时间范围。

<div id="backfill">
  #### 补数
</div>

要请求补数，你需要在连接请求中添加一个 `backfillMinutes=N` 参数，其中 N 是在建立连接时需要补数的分钟数（1–5，只能为整数）。例如，如果你断开了 90 秒，那么你应在连接请求中添加 `backfillMinutes=2`。由于该请求会提供 2 分钟的补数，其中包括你断开连接前 30 秒的时间段，因此你的 *consumer app 必须能够容忍重复数据*。

一个示例 Decahose 连接请求 URL，请求对分区 1 进行 5 分钟补数，如下所示：

https://gnip-stream.x.com/stream/sample10/accounts/:account&#95;name/publishers/twitter/:stream&#95;label.json?partition=1&amp;backfillMinutes=5

**注意：**

* 你可以选择在连接时始终使用 `backfillMinutes=5`，然后在你的端处理任何提供的重复数据。

* 如果断开连接时间超过 5 分钟，你可以使用 Recovery 来恢复数据。

**从断开中恢复**

重启并从断开中恢复涉及以下几个步骤：

* 确定断开时间长度。
  * 5 分钟或更短？
    * 如果你为流启用了 Backfill，为连接请求准备带有适当 `backfillMinutes` 参数的请求。
  * 超过 5 分钟？
    * 如果你有 Recovery 流，请针对断开时间段发起 Recovery 请求（理想情况下使用你当前的实时规则集，如有必要可使用 Rules API）。

* 请求一个新的连接。

当你遇到断开连接或停机时，可以使用以下策略来缓解影响并进行恢复：

1. **实现 Backfill**\
   Backfill 允许你从流连接断开前的某个时间点重新连接，并覆盖最长 5 分钟的断开时间。通过在连接请求中包含一个参数来启用该功能。

2. **从其他位置消费冗余流**\
   如果冗余流可以流式传输到同一个实时环境，并在其中进行数据去重，则除非正常流和冗余流同时发生停机或断开，否则你将无需进行恢复。如果冗余流无法实时流入生产环境，则可以将其写入单独的“应急”数据存储。然后，在主流连接发生断开或停机时，你的系统将有现成的数据，用于填补主数据库在该时间段内缺失的数据。

3. **实现 Recovery**\
   当断开连接或停机同时影响主流和冗余流时，使用 Decahose Recovery 来恢复任何遗漏的数据。该 API 提供一个覆盖 5 天归档数据的滚动窗口，最佳实践是每次请求不超过其中 1 小时的时间段，并以流式方式拉取。这是与实时流并行完成的。请注意，我们没有解决方案来恢复 Recovery 所提供的 5 天窗口之外的 Decahose 数据，因此，当你这边发生重大停机时，利用冗余流来确保你在自己这边拥有完整的数据副本非常重要。

当你检测到异常的存储数据量时——\
在没有发生断开或停机的情况下，你可以通过以下方式检测是否存在数据缺失……

1. 统计入站帖子\
   你的系统应在数据摄取应用的最前端统计你接收到的原始帖子数量，然后提供一种方式，将这些数字与最终写入数据存储的帖子数量进行比较。任何差异都可以被监控，并提醒你的团队注意导致数据在接收后被丢弃的问题。

2. 分析异常的存储量\
   你也可以分析最终数据库中存储数据的量，以查找是否存在异常下降。这同样可以表明系统存在问题，尽管在某些情况下，数据量下降是正常的（例如，如果 X 平台不可用，用户在一段时间内无法创建帖子）。

<div id="api-reference">
  ## API 参考
</div>

<div id="decahose-stream">
  ### Decahose 流
</div>

跳转到本页章节

[方法](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#methods)

[身份验证](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#authentication)

[GET /&#123;stream-type&#125;/:stream](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#get-stream-type-stream)

[重放 API](/zh/x-api/enterprise-gnip-2.0/fundamentals/decahose-api#replay-api)

<div id="methods">
  #### 方法
</div>

| 方法 | 描述 |
| :--- | :--- |
| [GET /&#123;stream-type&#125;/:stream](#Stream) | 连接数据流 |

<div id="authentication">
  #### 身份验证[](#authentication- "Permalink to this headline")
</div>

对 Volume Stream API 的所有请求都必须使用 HTTP 基本身份验证，该身份验证由在 console.gnip.com 登录你的账户时使用的有效电子邮件地址和密码组合构成。凭证必须作为每个请求的 Authorization 头传递。因此，请确认你的客户端正在为所有 API 请求添加带有编码凭证且通过 HTTPS 发送的 &quot;Authorization: Basic&quot; HTTP 头。

#### GET {stream-type}:stream

建立与 Firehose 流的持久连接，通过该连接传输实时数据。

<div id="request-specifications">
  #### 请求规范
</div>

|     |     |
| :--- | :--- |
| **Request Method** | HTTP GET |
| **Connection Type** | Keep-Alive  <br />  <br />应在请求头中进行指定。 |
| **URL** | 可在控制面板中该流的 API Help 页面找到，使用以下结构：  <br />  <br />Decahose:<br /><br />[https://gnip-stream.x.com/stream/sample10/accounts/:account&#95;name/publishers/twitter/:stream&#95;label.json?partition=1](https://gnip-stream.x.com/stream/sample10/accounts/:account_name/publishers/twitter/:stream_label.json?partition=1) |
| **Partition (required)** | `partition=\{#}` - 现在必须使用分区才能消费完整的数据流。你需要在连接到流时指定 partition 参数。下面是每个流的分区数量：<br /><br />* Decahose：2 个分区 |
| **Compression** | Gzip。要使用 Gzip 压缩方式连接流，只需在连接请求中发送 Accept-Encoding 头。该头应如下所示：  <br />  <br />Accept-Encoding: gzip |
| **Character Encoding** | UTF-8 |
| **Response Format** | JSON。你的请求头中应指定响应使用 JSON 格式。 |
| **Rate Limit** | 每 60 秒最多 10 个请求。 |
| **Backfill Parameter** | 如果你购买的流启用了 Backfill 功能，则需要在 GET 请求中添加 &quot;backfillMinutes&quot; 参数以启用该功能。 |
| **Read Timeout** | 在你的客户端上设置读取超时时间，并确保其值大于 30 秒。 |
| **Support for Tweet edits** | 所有帖子对象都会包含描述该帖子编辑历史的帖子编辑元数据。更多详情参见 [&quot;Edit Tweets&quot; 基础介绍页面](/zh/x-api/enterprise-gnip-2.0/fundamentals/edit-tweets)。 |

<div id="responses">
  #### 响应
</div>

对于这些请求，API 可能返回以下响应。大多数错误代码会在响应体中附带一个包含更多细节的字符串。对于非 200 响应，客户端应尝试重新连接。

| Status | Text | Description |
| :--- | :--- | :--- |
| 200 | Success | 连接已成功打开，新的活动会在到达时通过该连接发送。 |
| 401 | Unauthorized | 由于凭证无效导致 HTTP 身份验证失败。使用你的凭证登录 console.gnip.com，以确保在请求中正确使用了这些凭证。 |
| 406 | Not Acceptable | 通常发生在你的客户端未正确在请求头中声明接受来自流的 gzip 编码时，但在其他情况下也可能发生。  <br />  <br />将包含类似于 “此连接需要启用压缩。要启用压缩，请在请求中发送 ‘Accept-Encoding: gzip’ 头，并确保客户端在读取流时可以对其进行解压。” 的 JSON 消息。 |
| 429 | Rate Limited | 你的应用已超出连接请求限制。 |
| 503 | Service Unavailable | Twitter 服务器问题。请使用指数退避策略重新连接。如果在 [X API Status Page](https://api.twitterstat.us/) 上没有关于此问题的公告，并且在 10 分钟后仍无法连接，请联系支持或紧急支持渠道。 |

<div id="example-curl-request">
  #### 示例 curl 请求
</div>

以下示例请求是在命令行中使用 cURL 发起的。不过请注意，你也可以使用任意编程语言来发送这些请求：

```
curl --compressed -v -uexample@customer.com "https://gnip-stream.x.com/stream/firehose/accounts/:account\_name/publishers/twitter/:stream\_label.json?partition={#}"
```

<div id="replay-api">
  #### Replay API
</div>

Replay API 是对实时 Volume 流的重要补充。Replay 是一种数据恢复工具，可提供对 X 近期历史数据滚动窗口的流式访问。