---
title: 合规 Firehose API
keywords: ["合规 firehose", "firehose API", "合规 API", "Enterprise firehose", "合规流", "firehose"]
---

> **请注意**
>
> 我们已经在 X API v2 中发布了一款名为 [batch compliance](/zh/x-api/compliance/batch-compliance) 的新合规工具。这个新工具允许你上传大规模的帖子或用户 ID 数据集，以获取它们的合规状态，从而确定哪些数据需要采取措施，使你的数据集满足合规要求。

> 此外，batch compliance 和 compliance firehose 都已更新以支持编辑帖子。对于 compliance firehose，新增了一个名为 &#39;tweet&#95;edit&#39; 的事件类型。有关更多详情，请参阅 [Compliance Data Objects](/zh/x-api/enterprise-gnip-2.0/fundamentals/firehouse#compliance-data-objects) 文档。要了解编辑帖子元数据的工作方式，请参阅 [Edit Posts fundamentals](/zh/x-api/fundamentals/edit-posts) 页面。

<div id="overview">
  ## 概述
</div>

`Enterprise`

X 的核心价值之一是捍卫并尊重用户的声音。这包括在用户删除、修改或编辑他们选择在 X 上分享的内容时，尊重他们的期望和意图。我们认为，这对维护作为全球最大公共实时信息平台之一的长期健康至关重要。X 将控制权交到用户手中，让个人能够掌控自己的 X 使用体验。我们认为，通过 API 接收 X 数据的企业用户有责任尊重终端用户的期望和意图。

有关 X 平台上可能发生的各类合规相关事件的更多信息，请参阅我们的文章：[在 X 上尊重用户意图](/zh/x-api/enterprise-gnip-2.0/fundamentals/firehouse#honoring-user-intent-on-twitter)。

任何通过 API 使用 X 数据的开发者或公司，都有义务尽一切合理努力来遵守用户对其内容所做的更改。这一义务扩展至用户事件，如删除、修改以及分享选项的变更（例如内容变为受保护或被限制展示）。这也包括用户编辑其帖子时的情况。请参阅[开发者政策](https://developer.x.com/en/developer-terms/policy)和/或您的 X 数据协议中的具体条款，以了解此义务将如何影响您对 X 数据的使用。

X 提供了以下解决方案，用于提供这些与用户相关的合规事件的信息，以及某条特定帖子或某个用户当前是否公开可见。下面将简要概述这些解决方案及其通用集成模式：

<div id="get-statuseslookup-and-get-userslookup">
  #### GET statuses/lookup 和 GET users/lookup
</div>

* 格式：REST API，参见：[GET statuses/lookup](https://developer.x.com/en/docs/x-api/v1/tweets/post-and-engage/api-reference/get-statuses-lookup) 和 [GET users/lookup](https://developer.x.com/en/docs/x-api/v1/accounts-and-users/follow-search-get-users/api-reference/get-users-lookup)。

* 这些端点始终返回任何帖子被编辑后的最新版本。所有在编辑功能推出之后创建的帖子所对应的 Post 对象都会包含帖子编辑元数据，即使这些帖子实际上从未被编辑。

* 对于所有帖子，在其创建后超过 30 分钟才发起的请求，将返回这些帖子的最终状态。

* 按调用方在 API 请求中的定义，提供特定帖子或用户的可用性信息。

* 可用于按需对特定帖子 / 用户组的当前可用性状态进行抽查。

* 适合需要在某一特定时间点检查某个特定帖子或用户当前状态的客户。

* 这些 API 提供了一种实用机制，供需要检查某条内容可用性的客户在以下场景中使用，例如：
  1. 展示帖子
  2. 以一对一方式与帖子或用户进行互动
  3. 通过允许的文件下载向第三方分发 X 内容
  4. 长期存储帖子

<div id="compliance-firehose-enterprise-only">
  #### Compliance Firehose（仅限 Enterprise）
</div>

* 格式：Streaming API。详见：[Compliance Firehose](/zh/x-api/enterprise-gnip-2.0/fundamentals/firehouse#api-reference)。
* 提供 X 上[合规活动](/zh/x-api/enterprise-gnip-2.0/fundamentals/firehouse#compliance-data-objects)的实时流。这些活动包括帖子被编辑时产生的事件。 
* 可用于在平台上出现新的合规事件时，维护一组已存储数据的合规状态。
* 非常适合需要在较长时间内持续获取并存储大量 X 数据的客户。

<div id="guides">
  ## 指南
</div>

<div id="compliance-best-practices">
  ### **合规性最佳实践**
</div>

<div id="recommendations-best-practices">
  #### **建议与最佳实践**
</div>

* **构建存储数值型 Post ID 和 User ID 的数据存储模式（schema）**：合规处理通常要求对某个 User 下的所有帖子执行相应操作。因此，由于所有合规消息仅通过数值型 ID 进行传递，设计数据存储模式时必须确保能够基于数值型 ID 维护 Post 与 User 之间的关联关系。数据使用方需要同时基于 Post ID 和 User ID 监控合规事件，并能够相应地更新本地数据存储。

* **构建涵盖所有合规状态的模式（schema）**：根据在各类应用中处理合规活动的方式，可能需要在数据存储中添加其他元数据。例如，数据使用方可能会决定在现有数据库中添加元数据，以便在收到 status&#95;withheld 消息时，能够限制在受影响国家/地区显示相应内容。

* **处理 Retweet 删除**：Retweet 是一种特殊类型的 Post，其中原始消息作为对象嵌套在 Retweet 内。在这种情况下，Retweet 中会涉及两个 Post ID——一个是 Retweet 本身的 ID，另一个是原始消息的 ID（包含在嵌套对象中）。当原始消息被删除时，会针对该原始 ID 发出 Post 删除消息。Post 删除事件通常会触发针对所有 Retweet 的删除事件。然而，在某些情况下，可能不会发送所有这些事件，客户端系统应能够容忍 Retweet 删除不完整的情况。删除原始 ID 通常就足以删除所有后续的 Retweet。最佳实践是在存储 Retweet 时引用原始 Post ID，并在接收到 Post 删除事件时删除所有被引用的 Retweet。

<div id="compliance-data-objects">
  ### 合规数据对象
</div>

<div id="compliance-firehose-api">
  #### **合规 Firehose API**
</div>

可能的合规事件类型包括帖子（或“status”）事件和用户事件，下面将分别介绍其多种类型。  

请注意：

* 在[这里](https://support.x.com/articles/14016)了解更多关于用户状态的信息，在[这里](https://dev.x.com/overview/terms/policy#3.Update_Respect_Users_Control_and_Privacy)了解我们关于已删除帖子的开发者政策。
* 合规 Firehose 已更新以提供 `tweet_edit` 事件。 
* 若干用户删除、保护和封禁事件不一定是永久性的，可以在不同状态之间无限次切换。这些包括：user&#95;delete、user&#95;undelete、user&#95;protect、user&#95;unprotect 以及 user&#95;suspend、user&#95;unsuspend。
* 只有当用户没有选择执行 user&#95;undelete 来恢复其帐号时，user&#95;delete 事件之后才会在 30 天后触发 status&#95;delete。用户有可能撤销 user&#95;delete 操作，这样一来，在 30 天后就不会对其全部帖子执行删除。
* user&#95;suspend 是一个在用户收到 user&#95;unsuspend 事件前始终保持为真的操作。这些事件不受 30 天期限内任何更改的影响。

请参考 “Recommended Action”（推荐操作）列，了解应如何处理每种事件类型，从而尊重终端用户的隐私和意图。

| Original Message Type | Object | Permanent (Yes/No) | Recommended Action |
| :--- | :--- | :--- | :--- |
| delete | Status | Yes | 删除关联的帖子。 |
| status&#95;withheld | Status | Yes | 在 status&#95;withheld 消息中列出的特定国家/地区屏蔽关联帖子。 |
| drop | Status | No  | 将该帖子从公开视图中移除。 |
| undrop | Status | No  | 该 Status 可以再次显示并视为公开内容。 |
| tweet&#95;edit | Status | Yes | 遵从并在相关场景下展示新的编辑内容。 |
| user&#95;delete | User | No  | 屏蔽或删除该关联用户的全部帖子。 |
| user&#95;undelete | User | No  | 该关联用户的全部帖子可以再次显示并视为公开内容。 |
| user&#95;protect | User | No  | 屏蔽或删除该关联用户的全部帖子。 |
| user&#95;unprotect | User | No  | 该关联用户的全部帖子可以再次显示并视为公开内容。 |
| user&#95;suspend | User | No  | 屏蔽或删除该关联用户的全部帖子。 |
| user&#95;unsuspend | User | No  | 该关联用户的全部帖子可以再次显示并视为公开内容。 |
| scrub&#95;geo | User | Yes | 删除 X 为该用户在 scrub&#95;geo 消息中指定帖子之前所发布的全部帖子所提供的地理数据。请注意，该用户后续帖子所含地理数据仍可使用。 |
| user&#95;withheld | User | Yes | 在 user&#95;withheld 消息中列出的特定国家/地区屏蔽该关联用户的帖子。 |
| delete | Favorite | Yes | 删除关联的点赞/收藏。 |

<div id="payload-examples">
  #### **负载示例**
</div>

请参阅下方针对上表中每种合规事件的负载示例。

**帖子编辑**

```json
{"tweet_edit":
   {
     "id": "1557445923210514432"
     "initial_tweet_id": "1557433858676740098",
     "edit_tweet_ids": ["1557433858676740098", "1557445923210514432"],
     "timestamp_ms": "1660155761384"
   }
 }
```

<div id="post-delete">
  ##### 帖子删除
</div>

```json
{
  "delete": {
    "status": {
      "id": 601430178305220600,
      "id_str": "601430178305220608",
      "user_id": 3198576760,
      "user_id_str": "3198576760"
    },
    "timestamp_ms": "1432228155593"
  }
}
```

<div id="post-withheld">
  ##### 被屏蔽的帖子
</div>

```json
{
  "status_withheld": {
    "status": {
      "id": 601430178305220600,
      "id_str": "601430178305220608",
      "user_id": 3198576760,
      "user_id_str": "3198576760"
    },
    "withheld_in_countries": [
      "XY"
    ],
    "timestamp_ms": "1432228155593"
  }
}
```

<div id="drop">
  ##### 移除
</div>

```json
{
  "drop": {
    "status": {
      "id": 601430178305220600,
      "id_str": "601430178305220600",
      "user_id": 3198576760,
      "user_id_str": "3198576760"
    },
    "timestamp_ms": "1432228155593"
  }
}
```

<div id="undrop">
  ##### 取消删除
</div>

```json
{
  "undrop": {
    "status": {
      "id": 601430178305220600,
      "id_str": "601430178305220600",
      "user_id": 3198576760,
      "user_id_str": "3198576760"
    },
    "timestamp_ms": "1432228155593"
  }
}
```

<div id="scrub-geo">
  #### 清除位置信息
</div>

```json
{
  "scrub_geo": {
    "user_id": 519761961,
    "up_to_status_id": 411552403083628540,
    "up_to_status_id_str": "411552403083628544",
    "user_id_str": "519761961",
    "timestamp_ms": "1432228180345"
  }
}
```

<div id="user-delete">
  ##### 用户删除
</div>

```json
{
  "user_delete": {
    "id": 771136850,
    "timestamp_ms": "1432228153548"
  }
}
```

<div id="user-undelete">
  ##### 用户撤销删除
</div>

```json
{
  "user_undelete": {
    "id": 796250066,
    "timestamp_ms": "1432228149062"
  }
}
```

<div id="user-withheld">
  ##### 用户屏蔽
</div>

```json
{
  "user_withheld": {
    "user": {
      "id": 1375036644,
      "id_str": "1375036644"
    },
    "withheld_in_countries": [
      "XY"
    ],
    "timestampMs": "2014-08-27T23:49:41.839+00:00"
  }
}
```

<div id="user-protect">
  ##### 设置用户保护
</div>

```json
{
  "user_protect": {
    "id": 3182003550,
    "timestamp_ms": "1432228177137"
  }
}
```

<div id="user-unprotect">
  ##### 取消用户保护
</div>

```json
{
  "user_unprotect": {
    "id": 2911076065,
    "timestamp_ms": "1432228180113"
  }
}
```

<div id="user-suspend">
  ##### 用户停用
</div>

```json
{
  "user_suspend": {
    "id": 3120539094,
    "timestamp_ms": "1432228194217"
  }
}
```

<div id="user-unsuspend">
  ##### 用户解封
</div>

```json
{
  "user_unsuspend": {
    "id": 3293130873,
    "timestamp_ms": "1432228193828"
  }
}
```

<div id="integrating-compliance-firehose">
  ### 集成 Compliance Firehose
</div>

Compliance Firehose 是一个实时流式 API，用于传递在 X 平台上发生的合规事件。若要了解合规事件是什么以及它们如何在 X 上生成，请参阅我们的文章：[在 X 上尊重用户意图](/zh/x-api/enterprise-gnip-2.0/fundamentals/firehouse#honoring-user-intent-on-twitter)。

需要特别注意的是，Post 和 User 事件是分别推送的，并且每类事件都应独立处理（即，某个 Post 被删除并不意味着会产生 User 事件，反之亦然）。有几类 User 事件并不一定是永久性的，可以在不同状态之间无限切换。这些事件包括：user&#95;delete、user&#95;undelete、user&#95;protect、user&#95;unprotect 以及 user&#95;suspend、user&#95;unsuspend。

仅当用户在 30 天内没有选择执行 user&#95;undelete 操作恢复其账号时，user&#95;delete 事件才会在 30 天后伴随 status&#95;deletes 事件出现。用户有可能撤销某次 user&#95;delete，导致其所有帖子的删除在 30 天后并不会发生。

User&#95;suspend 是一个在发生后始终保持为真（有效）的动作，除非该用户发生了 user&#95;unsuspend 事件。这些事件不受任何 30 天时间周期内变更的影响。

绝不应当将合规事件直接展示给你的软件用户，或以其他方式将其整合进你的产品或客户体验中。它们仅用于维护合规性并尊重 X 用户的行为。

<div id="integrating-with-the-compliance-firehose">
  #### **集成 Compliance Firehose**
</div>

要将 Compliance Firehose 集成到你的系统中，你需要构建一套集成方案，使其能够完成以下工作：

1. 为 Compliance Firehose 的每个流式 API 分区建立流式连接
2. 处理大规模数据量——使用异步机制将流式数据摄取与后续处理解耦
3. 在因任何原因断开连接时，自动重新连接到各个流式分区
4. 按照上文提供的指导，处理与您已存储的帖子和用户数据相关的合规事件

<div id="honoring-user-intent-on-twitter">
  ### 在 Twitter 上尊重用户意图
</div>

我们认为，尊重 X 用户的隐私和意图，对这个世界上最大规模的公共、实时信息平台之一的长期健康发展至关重要。X 将隐私控制权交到用户手中，使个人能够掌控自己在 X 上的体验。作为 X 数据的商业用户，我们肩负着共同的责任，必须尊重终端用户的隐私和行为，从而维护这种信任与尊重的环境。

在平台上，可以针对帖子和用户账号采取多种操作，这些操作会影响它们的展示方式。影响隐私和意图的操作在 Status（Post）和 User 两个层级上都有定义。这些操作包括：

<div id="user">
  #### 用户
</div>

| 操作 | 说明 |
| :--- | :--- |
| Protect Account | X 用户可以随时将其帐户设置为受保护或取消保护。受保护帐户需要用户手动批准每一位被允许查看其帐户帖子的用户。<br />如需了解更多信息，请参阅 [About Public and Protected Posts](https://support.x.com/articles/14016-about-public-and-protected-tweets)。 |
| Delete Account | X 用户可以随时决定删除其帐户及所有关联的状态消息。X 会在删除后保留帐户信息 30 天，以防用户决定撤销删除并重新激活其帐户。 |
| Scrub Geo | X 用户可以随时从以往的帖子中移除全部位置数据。这称为 “scrub geo”。 |
| Suspend Account | 如帐户违反 X 规则，或被怀疑遭到黑客攻击或被入侵，X 保留暂停该帐户的权利。帐户暂停只能由 X 撤销（解除暂停）。 |
| Withhold Account | X 保留不时在特定国家/地区内根据需要限制访问某些内容的权利。被限制的帐户只能由 X 解除限制。<br />如需了解更多信息，请参阅 [Country Withheld Content](https://support.x.com/articles/20169222-country-withheld-content)。 |

<div id="status">
  #### 状态
</div>

| 操作 | 说明 |
| :--- | :--- |
| 删除状态 | X 用户可以随时删除某条状态。删除后无法恢复，并会被永久删除。 |
| 限制状态 | X 保留根据需要在特定国家/地区对某些内容的访问进行被动限制的权利。被限制的状态只能由 X 取消限制。   <br />更多信息，请参见 [按国家/地区受限的内容](https://support.x.com/articles/20169222-country-withheld-content)。 |

<div id="keeping-track-of-user-and-status-changes">
  #### 跟踪用户和状态变更
</div>

由于上述任一操作，用户或状态的当前状态可能在任何时间发生变化，这会影响 X 数据使用方应如何处理所有关联内容的可用性和隐私性。当这些操作发生时，系统会发送相应的合规消息，以表明某个状态或用户的状态已发生变化。

<div id="api-reference">
  ## API 参考
</div>

<div id="get-compliancefirehose">
  ### **GET compliance/firehose**
</div>

<div id="methods">
  #### 方法
</div>

| 方法 | 描述 |
| :--- | :--- |
| [GET /compliance/:stream](#Connect) | 连接数据流 |

<div id="authentication">
  #### 身份验证
</div>

对 Compliance Firehose API 的所有请求都必须使用 HTTP 基本身份验证，其凭据由你在 console.gnip.com 上登录账号时使用的有效电子邮件地址和密码组合构成。每个请求都必须在 Authorization 标头中携带这些凭据。

<div id="get-compliancestream">
  #### GET /compliance/:stream
</div>

建立到 Compliance Firehose 数据流的持久连接，合规事件将通过该连接传送。

|                             |                                                                                                                                                                                                                                                                                                                                                                                                          |
| :-------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Request Method**          | HTTP GET                                                                                                                                                                                                                                                                                                                                                                                                 |
| **Connection Type**         | Keep-Alive                                                                                                                                                                                                                                                                                                                                                                                               |
| **URL**                     | 可在控制面板中该流的 API Help 页面找到，URL 结构类似如下：  <br />  <br /><br />[https://gnip-stream.x.com/stream/compliance/accounts/:account&#95;name/publishers/twitter/:stream&#95;label.json?partition=1](https://gnip-stream.x.com/stream/compliance/accounts/:account_name/publishers/twitter/:stream_label.json?partition=1)<br /><br />**注意：**必须包含 &quot;partition&quot; 参数。你需要连接全部 8 个分区，每个分区包含总量的 12.5%，才能获取完整的数据流。 |
| **Compression**             | Gzip。要使用 Gzip 压缩连接到数据流，只需在连接请求中发送 Accept-Encoding 头。该头应类似如下：  <br />  <br />Accept-Encoding: gzip                                                                                                                                                                                                                                                                                                        |
| **Character Encoding**      | UTF-8                                                                                                                                                                                                                                                                                                                                                                                                    |
| **Response Format**         | JSON。你的请求头应指定响应格式为 JSON。                                                                                                                                                                                                                                                                                                                                                                                 |
| **Rate Limit**              | 10 次请求 / 60 秒。                                                                                                                                                                                                                                                                                                                                                                                           |
| **Read Timeout**            | 在你的客户端上设置读取超时时间，并确保该值大于 30 秒。                                                                                                                                                                                                                                                                                                                                                                            |
| **Support for Tweet edits** | 所有帖子编辑都会触发一个 &quot;tweet&#95;edit&quot; 合规事件。更多详情参见 [Compliance Data Objects](/zh/x-api/enterprise-gnip-2.0/fundamentals/firehouse#compliance-data-objects) 文档。                                                                                                                                                                                                                                             |

**Example Curl Request**

下面的示例请求是在命令行中使用 cURL 完成的：

```bash
curl --compressed -v -uexample@customer.com "https://gnip-stream.x.com/stream/compliance/accounts/:account_name/publishers/twitter/:stream_label.json?partition=1"
```

*注意：* 上述请求仅连接到了 Compliance firehose 的 `partition=1`，你需要连接全部 8 个分区才能消费整个流的数据。

<div id="response-codes">
  #### 响应代码
</div>

API 在处理这些请求时可能返回以下响应。大多数错误代码会在响应体中包含一个带有更多详细信息的字符串。对于非 200 响应，客户端应尝试重新连接。

| Status | Text | Definition |
| :--- | :--- | :--- |
| 200 | Success | 连接已成功打开，新的活动数据将在到达时通过该连接发送。 |
| 401 | Unauthorized | 由于凭证无效导致 HTTP 身份验证失败。使用你的凭证登录 console.gnip.com，确保你在请求中正确使用了这些凭证。 |
| 406 | Not Acceptable | 通常发生在你的客户端未能在请求头中正确声明接受来自流的 gzip 编码时，但在其他情况下也可能发生。响应中会包含类似以下内容的 JSON 消息：“此连接要求使用压缩。若要启用压缩，请在请求中发送 &#39;Accept-Encoding: gzip&#39; 标头，并在客户端读取流时准备好对其进行解压。” |
| 429 | Rate Limited | 你的应用已超出连接请求的限制。 |
| 503 | Service Unavailable | Twitter 服务器问题。使用指数退避模式重新连接。如果在 [X API Status Page](https://api.twitterstat.us/) 上没有关于该问题的公告，请联系支持。 |

<div id="other-recommendations-best-practices">
  #### 其他建议与最佳实践
</div>

* **构建可存储数值型 Tweet ID 和 User ID 的数据存储模式**：针对用户的合规消息要求对该用户的所有帖子采取相应操作。因此，由于所有合规消息仅通过数值型 ID 进行传递，设计数据存储模式时必须维护基于数值型 ID 的帖子与用户之间的关联关系。数据使用方需要同时基于帖子 ID 和用户 ID 监控合规事件，并能够相应地更新本地数据存储。

* **构建涵盖所有合规状态的模式**：根据在各类应用中处理合规活动的方式，可能需要向数据存储中添加其他元数据。例如，数据使用方可能会决定在现有数据库中添加元数据，以便在收到 `status_withheld` 消息时，更便捷地限制在受影响国家/地区显示相应内容。

* **处理转帖删除**：转帖是一种特殊类型的帖子，其中原始消息嵌套在转帖内部的一个对象中。在这种情况下，一个转帖中会引用两个帖子 ID——一个是转帖本身的 ID，另一个是原始消息的 ID（包含在嵌套对象中）。当原始消息被删除时，会针对原始 ID 发出帖子删除消息。不会为所有转帖分别再次发出删除消息。删除原始 ID 的操作应足以删除所有后续的转帖。