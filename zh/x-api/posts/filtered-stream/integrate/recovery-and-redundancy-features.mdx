---
title: 恢复与冗余
sidebarTitle: 恢复与冗余
keywords: ["恢复", "冗余", "流恢复", "重连", "容错", "流冗余", "错误恢复"]
---

<div id="introduction">
  #### 介绍
</div>

在消费流式数据时，尽可能延长连接持续时间并确保接收所有匹配到的数据是一个基本目标。这意味着，充分利用冗余连接、自动检测连接中断、快速重连，以及提前规划如何恢复丢失的数据，都非常重要。

在本集成指南中，我们将讨论不同的恢复和冗余功能：冗余连接、回填（backfill）和恢复。
 

**冗余连接**

冗余连接指可以同时与 Filtered stream 建立多个连接。通过使用两个独立的消费者连接到同一个流，并在两个连接中接收相同的数据，从而实现冗余。这样，你的应用在多种情况下都具备热故障转移能力，例如其中一个流断开连接，或者你的应用主服务器发生故障。

当前，Filtered stream 只允许具有 Enterprise 访问权限的项目最多使用两个冗余连接。要使用冗余流，只需连接到与你的主连接相同的 URL。你的流数据将通过这两个连接同时发送。

<div id="recovering-missed-data-after-a-disconnection-backfill">
  #### 断开连接后恢复遗漏数据：回填（Backfill）
</div>

在检测到断开连接后，你的系统应具备自动重新连接到流的能力。如果可能，你的系统还应记录断开连接持续了多长时间，以便你可以使用合适的恢复机制来回填数据。 

如果你在使用具有 Enterprise 访问权限的项目，并确定断开连接持续时间为五分钟或更短，则可以使用回填参数 `backfill_minutes`。如果你在 [GET /tweets/search/stream](/zh/x-api/posts/filtered-stream#get-2-tweets-search-stream) 请求中传递此参数，你会收到过去一到五分钟内与你的规则匹配的帖子。我们通常会先发送这些较早的帖子，然后再发送任何新匹配到的帖子，并且不会对帖子进行去重。这意味着，如果你断开连接 90 秒，但请求两分钟的回填数据，你将会收到 30 秒的重复帖子，你的系统应当能够容忍这些重复。下面是一个带有回填参数的请求示例：

`curl 'https://api.x.com/2/tweets/search/stream?backfill_minutes=5' -H "Authorization: Bearer $ACCESS_TOKEN"`

如果你没有 Enterprise 访问权限，或者确定断开连接时间超过五分钟，你可以使用 [recent search endpoint](/zh/x-api/posts/search/introduction) 或恢复功能来请求遗漏的数据。不过请注意，搜索帖子端点不支持 `sample:`、`bio:`、`bio_name:` 或 `bio_location:` 运算符，并且在使用带重音符号和变音符号的关键字以及 `#hashtag` 运算符时，其匹配行为也存在一些差异。这些差异可能意味着，你无法完全恢复那些本可以通过过滤流端点接收到的所有帖子。 

**断开连接后恢复遗漏数据：恢复（Recovery）**

如果你在使用具有 Enterprise 访问权限的项目，并且无法在 5 分钟回填窗口内重新连接，你可以使用 Recovery 功能在过去 24 小时内恢复遗漏的数据。

流式恢复功能允许你将回填窗口扩展到 24 小时。Recovery 使你能够“重放”遗漏数据的这段时间区间。当你在连接请求中使用 `start_time` 和 `end_time` 请求参数时，将启动一个恢复流。一旦连接成功，Recovery 会重新推送指定时间段的数据，然后断开连接。  

你可以同时向 Recovery 发起 2 个并发请求，即“两项恢复作业”。Recovery 在技术上与回填的工作方式相同，只是需要定义开始时间和结束时间。一个恢复周期对应一个单一的时间区间。

|     |     |     |
| :--- | :--- | :--- |
| **Name** | **Type** | **Description** |
| start&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />以 UTC 表示的日期时间，标志恢复开始的时间点。 |
| end&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />以 UTC 表示的日期时间，标志恢复结束的时间点。 |

示例请求 URL： [https://api.x.com/2/tweets/search/stream?start&#95;time=2022-07-12T15:10:00Z&amp;end&#95;time=2022-07-12T15:20:00Z](https://api.x.com/2/tweets/search/stream?start_time=1985-04-12T23:20:50.52Z\&end_time=1985-04-13T00:20:50.52Z)