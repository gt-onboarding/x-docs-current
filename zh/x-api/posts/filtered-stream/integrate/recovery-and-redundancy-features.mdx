---
title: 恢复与冗余
sidebarTitle: 恢复与冗余
keywords: ["恢复", "冗余", "流恢复", "重新连接", "容错", "流冗余", "错误恢复"]
---

<div id="introduction">
  #### 介绍
</div>

在消费流式数据时，最大化连接时长并接收所有匹配的数据是一个基本目标。这意味着，充分利用冗余连接、自动检测断线并快速重连，以及提前规划如何恢复丢失的数据，都非常重要。

在本集成指南中，我们将讨论不同的恢复和冗余特性：冗余连接、回填（backfill）和恢复。
 

**冗余连接**

冗余连接就是允许你同时与 filtered stream 建立多个连接。这样，你可以用两个独立的消费端连接到同一个流，并通过两条连接接收相同的数据，从而提供冗余能力。因此，你的应用在多种情况下都具备热切换能力，例如某个流断开，或你的应用主服务器发生故障。

目前 filtered stream 只允许具有 Enterprise 访问权限的项目最多建立两条冗余连接。要使用冗余流，只需连接与你的主连接相同的 URL。你的流数据将通过这两条连接同时发送。

<div id="recovering-missed-data-after-a-disconnection-backfill">
  #### 在断开连接后恢复遗漏数据：回填（Backfill）
</div>

检测到断开连接后，你的系统应足够智能，能够重新连接到流。如果可能，你的系统应记录断开连接持续的时间，以便你可以使用合适的恢复功能来回填数据。 

如果你使用的是具有 Enterprise 访问权限的项目，并确认断开连接持续时间为 5 分钟或更短，则可以使用回填参数 `backfill_minutes`。如果你在 [GET /tweets/search/stream](/zh/x-api/posts/filtered-stream#get-2-tweets-search-stream) 请求中传入该参数，你将收到过去 1 到 5 分钟内符合你规则的帖子。通常我们会先发送这些较早的帖子，再发送任何新匹配的帖子，并且不会对帖子进行去重。这意味着，如果你断开连接 90 秒，但请求 2 分钟的回填数据，你会收到 30 秒的重复帖子，你的系统应对此具有容错能力。下面是一个带有回填参数的请求示例：

`curl 'https://api.x.com/2/tweets/search/stream?backfill_minutes=5' -H "Authorization: Bearer $ACCESS_TOKEN"`

如果你没有 Enterprise 访问权限，或者确认断开连接时间超过 5 分钟，你可以使用 [recent search endpoint](/zh/x-api/posts/search/introduction) 或恢复功能来请求遗漏的数据。但请注意，搜索帖子端点不包含 `sample:`、`bio:`、`bio_name:` 或 `bio_location:` 运算符，并且在使用带重音和变音符号的关键字和 `#hashtag` 运算符时，其匹配行为存在某些差异。这些差异可能意味着你无法完全恢复通过过滤流端点本应接收到的所有帖子。 

**在断开连接后恢复遗漏数据：Recovery**

如果你使用的是具有 Enterprise 访问权限的项目，但无法在 5 分钟回填窗口内重新连接，则可以使用 Recovery 功能在过去 24 小时内恢复遗漏的数据。

流恢复功能允许你拥有最长 24 小时的扩展回填窗口。Recovery 使你能够“重放”遗漏数据的时间区间。当你使用 `start_time` 和 `end_time` 请求参数发起连接请求时，就会启动一个恢复流。一旦连接成功，Recovery 将重新流式传输指定时间段的数据，然后断开连接。  

你可以同时向 Recovery 发起 2 个并发请求，即“两项恢复作业”。从技术上讲，Recovery 的工作方式与回填相同，只是需要定义开始时间和结束时间。每个恢复周期对应一个单独的时间范围。

|     |     |     |
| :--- | :--- | :--- |
| **Name** | **Type** | **Description** |
| start&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />以 UTC 表示的日期时间，表示恢复开始的时间。 |
| end&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />以 UTC 表示的日期时间，表示恢复结束的时间。 |

请求 URL 示例： [https://api.x.com/2/tweets/search/stream?start&#95;time=2022-07-12T15:10:00Z&amp;end&#95;time=2022-07-12T15:20:00Z](https://api.x.com/2/tweets/search/stream?start_time=1985-04-12T23:20:50.52Z\&end_time=1985-04-13T00:20:50.52Z)