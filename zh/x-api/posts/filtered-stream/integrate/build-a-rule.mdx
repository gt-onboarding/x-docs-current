---
title: 创建规则
sidebarTitle: 创建规则
keywords: ["创建规则", "构建规则", "过滤规则", "流规则", "规则构建器", "过滤流规则", "规则指南"]
---

<div id="building-rules-for-filtered-stream">
  ## 为过滤流构建规则
</div>

过滤流端点会根据应用到该流的一组规则，为你传递经过过滤的帖子。规则由一系列运算符组成，用于匹配帖子的各种属性。

你可以使用 [POST /tweets/search/stream/rules](/zh/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) 端点向一个流应用多条规则。一旦你添加了规则，并使用 [GET /tweets/search/stream](/zh/x-api/posts/filtered-stream#get-2-tweets-search-stream) 端点连接到你的流，只有符合你规则的帖子才会通过持久的流式连接发送给你。你无需从流中断开连接即可添加或移除规则。 

<div id="table-of-contents">
  ### 目录
</div>

* [构建规则](#building-a-rule)
  * [规则限制](#rule-limitations)
  * [运算符适用范围](#operator-availability)
  * [运算符类型：可独立使用与需合并使用](#operator-types-standalone-and-conjunction-required)
  * [布尔运算符与分组](#boolean-operators-and-grouping)
  * [运算顺序](#order-of-operations)
  * [标点符号、变音符号与大小写敏感性](#punctuation-diacritics-and-case-sensitivity)
  * [规则特异性与效率](#specificity-and-efficiency)
  * [迭代构建规则](#iteratively-building-a-rule)
  * [添加和删除规则](#adding-and-removing-rules)
  * [规则示例](#rule-examples)

<div id="building-a-rule">
  ### 创建规则
</div>

<div id="rule-limitations">
  #### 规则限制
</div>

规则数量的限制取决于应用到你的[项目](/zh/resources/fundamentals/projects)的[访问级别](/zh/x-api/getting-started/about-x-api)。

你可以在 [filtered stream 简介](/zh/x-api/posts/filtered-stream) 页面了解这些限制是如何生效的。

<div id="operator-types-standalone-and-conjunction-required">
  #### 运算符类型：独立运算符与需搭配使用的运算符
</div>

**独立运算符（Standalone operators）** 可以单独使用，也可以与任意其他运算符（包括那些需要搭配使用的运算符）组合使用。

例如，下面的规则是有效的，因为它使用了 `#hashtag` 运算符，而该运算符是独立运算符：

`#xapiv2`

**需搭配使用（Conjunction required）** 的运算符不能在规则中单独使用；只有在规则中至少包含一个独立运算符时，才可以使用这些运算符。这是因为单独使用这些运算符会导致条件过于宽泛，从而匹配到数量极其庞大的帖子。

例如，下面这些规则不受支持，因为它们只包含需搭配使用的运算符：

`has:media`

`has:links OR is:retweet`

如果我们加入一个独立运算符，比如短语 `"X data"`，那么该规则就可以正常工作。 

`"X data" has:mentions (has:media OR has:links)`

<div id="boolean-operators-and-grouping">
  #### 布尔运算符和分组
</div>

如果你想在单个规则中串联多个运算符，可以使用以下方式：

|     |     |
| :--- | :--- |
| **AND 逻辑** | 连续的运算符**之间用空格分隔**会产生布尔 “AND” 逻辑，这意味着只有在两个条件都满足时，帖子才会匹配。例如，`snow day #NoSchool` 会匹配同时包含 snow 和 day 这两个词以及话题标签 #NoSchool 的帖子。 |
| **OR 逻辑** | 连续的运算符之间使用 OR 会产生 OR 逻辑，这意味着只要任一条件满足，帖子就会匹配。例如，指定 `grumpy OR cat OR #meme` 会匹配任何至少包含 grumpy 或 cat 这两个词，或包含话题标签 #meme 的帖子。 |
| **NOT 逻辑与取反** | 在关键字（或任意运算符）前加上连字符 (-) 即可将其取反（NOT）。例如，`cat #meme -grumpy` 会匹配包含话题标签 #meme 和单词 cat 的帖子，但前提是它们不包含单词 grumpy。一个常见的规则子句是 `-is:retweet`，它不会匹配转发（Retweets），因此只匹配原始帖子、引用帖子和回复。所有运算符都可以被取反，但被取反的运算符不能单独使用。 |
| **分组** | 你可以使用括号将运算符分组。例如，`(grumpy cat) OR (#meme has:images)` 将返回要么包含 grumpy 和 cat 这两个词的帖子，要么是带有图片且包含话题标签 #meme 的帖子。注意会先应用 AND，再应用 OR。 |

<Note>
  **关于取反的说明**

  除 `sample:` 外，所有运算符都可以被取反，并且 `-is:nullcast` 必须始终以前缀 - 的取反形式使用。被取反的运算符不能单独使用。

  不要对一组用括号括起来的运算符整体取反。相反，应对每个单独的运算符分别取反。

  例如，与其使用 `skiing -(snow OR day OR noschool)`，我们建议你使用 `skiing -snow -day -noschool`。
</Note>

<div id="order-of-operations">
  #### 运算顺序
</div>

在同时使用 AND 和 OR 逻辑时，规则的解析方式将由以下运算顺序决定。

1. 先组合由 AND 逻辑连接的运算符
2. 然后应用由 OR 逻辑连接的运算符

例如：

* `apple OR iphone ipad` 会被解析为 `apple OR (iphone ipad)`
* `ipad iphone OR android` 会被解析为 `(iphone ipad) OR android`

为消除不确定性并确保规则按预期进行解析，请在合适的地方使用括号将条件分组。

例如：

* `(apple OR iphone) ipad`
* `iphone (ipad OR android)`

<div id="punctuation-diacritics-and-case-sensitivity">
  #### 标点符号、变音符号和大小写敏感
</div>

如果你在规则中指定带有重音或变音符号的关键词或话题标签，该规则只会匹配包含带有相应重音或变音符号的该词的帖子，而不会匹配只包含相同字母但没有重音或变音符号的帖子。 

例如，包含关键词 `diacrítica` 或话题标签 `#cumpleaños` 的规则，会匹配包含 *diacrítica* 或 *#cumpleaños* 的帖子，因为这些帖子中包含重音或变音符号。但是，这些规则不会匹配包含 *Diacritica* 或 *#cumpleanos*（没有重音 í 或 eñe）的帖子。

带有重音或变音符号的字符与普通字符一样处理，不会被视为单词边界。例如，包含关键词 *cumpleaños* 的规则，只会匹配包含单词 *cumpleaños* 的帖子，而不会匹配包含 *cumplea*、*cumplean* 或 *os* 的帖子。

所有运算符在评估时都不区分大小写。例如，规则 cat 会匹配以下所有内容：*cat*、*CAT*、*Cat*。

<Note>
  [Search Posts](/zh/x-api/posts/search/introduction) 的匹配行为与 filtered stream 不同。当你[构建 Search Posts 查询](/zh/x-api/posts/search/integrate/build-a-query)时，需要注意：包含重音或变音符号的关键词和话题标签，既会匹配带有重音和变音符号的词，也会匹配对应的不带重音或变音符号的普通字符形式。 

  例如，包含关键词 `Diacrítica` 或话题标签 `#cumpleaños` 的 Search Posts 查询，既会匹配 *Diacrítica* 和 *#cumpleaños*，也会匹配不带重音 í 或 eñe 的 *Diacritica* 或 *#cumpleanos*。
</Note>

<div id="specificity-and-efficiency">
  #### 精准度和效率
</div>

在开始构建规则时，需要牢记以下几点。

* 通常不建议在规则中只使用宽泛、独立的运算符，例如单个关键词或 #hashtag，因为这很可能会匹配到海量的帖子。创建更健壮的规则可以得到一组更精确的匹配帖子，并有望减少负载中的噪音，从而减少你为寻找有价值洞察而需要筛选的内容。 
  * 例如，如果你的规则仅是关键词 `happy`，你每天可能会获得 200,000 - 300,000 条帖子。
  * 添加更多条件运算符可以缩小搜索结果范围，例如 `(happy OR happiness) place_country:GB -birthday -is:retweet`
* 编写高效的规则还有助于保持在规则字符长度限制范围内。字符数包括整个规则字符串中的所有字符，包括空格和运算符。
  * 例如，以下规则长度为 59 个字符：`(happy OR happiness) place_country:GB -birthday -is:retweet`

<div id="quote-tweet-matching-behavior">
  #### 引用帖子匹配行为
</div>

在使用 filtered stream 端点时，运算符会同时匹配被引用的原始帖子内容，以及引用帖子本身所包含的内容。

但是，请注意，[Search Posts](/zh/x-api/posts/search/introduction) 端点不会根据被引用的原始帖子中的内容进行匹配，而只会匹配引用帖子本身的内容。

<div id="iteratively-building-a-rule">
  #### 迭代式构建规则
</div>

<div id="test-your-rule-early-and-often">
  ##### 及早且频繁地测试你的规则
</div>

第一次就让某条规则返回“正确”的结果是很少见的。X 上有非常多的内容，很多一开始并不明显，而上文描述的规则语法也可能难以与你期望的搜索精确匹配。在你构建规则的过程中，定期使用流式端点来测试规则、查看它返回了哪些数据非常重要。你也可以使用某个 [Search Post](/zh/x-api/posts/search/introduction) 端点进行测试，前提是你使用的运算符也能通过该端点使用。 

在本节中，我们将从下面这条规则开始，并根据测试过程中得到的结果对其进行调整： 

`happy OR happiness`

<div id="use-results-to-narrow-the-rule">
  ##### 使用测试结果来缩小规则范围
</div>

在测试规则时，你应该查看返回的帖子，确认它们是否包含你期望接收的数据。先从一个范围较宽、匹配帖子较多的规则开始，可以先审查结果，再逐步收窄规则，以过滤掉不需要的结果。  

当我们测试示例规则时，注意到返回了多种不同语言的帖子。在这种情况下，我们只想接收英文帖子，因此将添加 `lang:` 运算符：

`(happy OR happiness) lang:en`

测试结果中包含了许多祝别人生日快乐的帖子，所以我们要添加 `-birthday` 作为一个否定关键字运算符。我们还只想接收原始帖子，因此又添加了否定运算符 `-is:retweet`：

`(happy OR happiness) lang:en -birthday -is:retweet`

<div id="adjust-for-inclusion-where-needed">
  ##### 在需要时放宽筛选条件
</div>

如果你发现没有收到预期的数据，并且确定存在一些本应被返回的帖子，那么你可能需要通过移除某些可能过滤掉目标数据的运算符来放宽你的规则范围。 

在我们的示例中，我们注意到在个人时间线中还有其他同样表达我们所寻找情绪的帖子，但它们没有包含在测试结果中。为了提高覆盖范围，我们将把关键词 `excited` 和 `elated` 也加进去。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet`

<div id="adjust-for-popular-trendsbursts-over-the-time-period">
  ##### 针对一段时间内的流行趋势/爆发进行调整
</div>

在 X 上，趋势变化非常迅速。维护你的规则应当是一个持续进行的过程。如果你打算在较长一段时间内使用单一规则，我们建议你定期检查自己接收到的数据，看看是否需要做出任何调整。

在我们的示例中，我们注意到开始接收到一些祝福他人“节日快乐”的帖子。由于我们不希望这些帖子被包含在结果中，因此要添加一个用于排除的 `-holidays` 关键词。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet -holidays`

<div id="adding-and-removing-rules">
  #### 添加和删除规则
</div>

当你在流中添加或删除规则时，需要使用 [POST /2/tweets/search/stream/rules](/zh/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) 这个 endpoint。

要向流中添加一个或多个规则，请提交一个带有 `add` JSON body 的请求，body 中包含一个数组。该数组中包括带有规则的 `value` 参数，以及可选的 `tag` 参数。`tag` 参数可以包含任意文本，你可以用它来[识别哪些返回的帖子匹配此规则](/zh/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule)。 

例如，如果你想向流中添加一组规则，你的 cURL 命令可能如下所示：

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
-H "Content-type: application/json" \
-H "Authorization: Bearer $ACCESS_TOKEN" -d \
'{
  "add": [
    {"value": "cat has:media", "tag": "cats with media"},
    {"value": "cat has:media -grumpy", "tag": "带媒体的开心猫"},
    {"value": "meme", "tag": "funny things"},
    {"value": "meme has:images"}
  ]
}'
```

类似地，要从流中移除一个或多个规则，请提交一个名为 `delete` 的 JSON 请求体，其中的数组应包含带有 `id` 参数的对象，这些 `id` 是你希望删除的规则 ID。

例如，如果你想从流中移除一组规则，你的 cURL 命令可能如下所示：

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
  -H "Content-type: application/json" \
  -H "Authorization: Bearer $ACCESS_TOKEN" -d \
  '{
    "delete": {
      "ids": [
        "1165037377523306498",
        "1165037377523306499"
      ]
    }
  }'
```

我们提供了多种编程语言的示例代码，可通过我们的 [GitHub](https://github.com/xdevplatform/Twitter-API-v2-sample-code/tree/master/Filtered-Stream) 获取。

<div id="rule-examples">
  #### 规则示例
</div>

<div id="tracking-a-natural-disaster">
  ##### 追踪自然灾害
</div>

下面的规则会匹配来自气象机构和监测站、讨论 2017 年袭击休斯敦的飓风 Harvey 的帖子。请注意这里使用了 [matching rules](/zh/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule) 标签，以及在向 [POST /2/tweets/search/stream/rules endpoint](/zh/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) 提交规则时所需的 JSON 格式。

```json
{
    "value": "-is:retweet has:geo (from:NWSNHC OR from:NHC_Atlantic OR from:NWSHouston OR from:NWSSanAntonio OR from:USGS_TexasRain OR from:USGS_TexasFlood OR from:JeffLindner1)",
    "tag": "theme:info has:geo original from weather agencies and gauges"
}
```

<div id="reviewing-the-sentiment-of-a-conversation">
  ##### 审视对话的情感倾向
</div>

下面这条规则可用于更好地理解围绕话题标签 *#nowplaying* 展开的对话情感，但只包含在北美地区发布的帖子。

```json
{
    "value": "#nowplaying (happy OR exciting OR excited OR favorite OR fav OR amazing OR lovely OR incredible) (place_country:US OR place_country:MX OR place_country:CA) -horrible -worst -sucks -bad -disappointing",
    "tag": "#nowplaying positive"
},
{
    "value": "#nowplaying (horrible OR worst OR sucks OR bad OR disappointing) (place_country:US OR place_country:MX OR place_country:CA) -happy -exciting -excited -favorite -fav -amazing -lovely -incredible",
    "tag": "#nowplaying negative"
}
```

<div id="find-posts-that-relate-to-a-specific-post-annotation">
  ##### 查找与特定帖子注解相关的帖子
</div>

此规则用于搜索包含宠物（但不是猫）图片的原帖，并且该帖子识别出的语言为日语。为实现这一点，我们使用了 `context:` 运算符来利用[帖子注解](/zh/x-api/fundamentals/post-annotations)功能。我们首先使用了 [帖子查找](/zh/x-api/posts/lookup/introduction) 端点以及 `tweet.fields=context_annotations` 字段参数，以确定在查询中需要使用哪些 domain.entity ID：

* 与猫相关的帖子会返回 `domain` 66（兴趣和爱好类别），其中 `entity` 为 852262932607926273（Cats）。
* 与宠物相关的帖子会返回 `domain` 65（兴趣和爱好垂直分类），其中 `entity` 为 852262932607926273（Pets）。
   

规则如下所示：

```json
{
    "value": "context:65.852262932607926273 -context:66.852262932607926273 -is:retweet has:images lang:ja",
    "tag": "Japanese pets with images - no cats"
}
```
