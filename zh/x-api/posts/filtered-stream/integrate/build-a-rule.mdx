---
title: 创建规则
sidebarTitle: 创建规则
keywords: ["创建规则", "构建规则", "过滤规则", "流规则", "规则构建器", "filtered stream 规则", "规则指南"]
---

<div id="building-rules-for-filtered-stream">
  ## 为过滤流构建规则
</div>

过滤流端点会根据应用到流上的一组规则，向你传递经过过滤的帖子。这些规则由一系列运算符组成，用于匹配多种帖子属性。

可以使用 [POST /tweets/search/stream/rules](/zh/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) 端点向一个流应用多条规则。一旦你添加了规则，并通过 [GET /tweets/search/stream](/zh/x-api/posts/filtered-stream#get-2-tweets-search-stream) 端点连接到你的流，只有符合你规则的帖子才会通过持久的流连接被投递。你无需断开与流的连接就可以添加或移除规则。 

<div id="table-of-contents">
  ### 目录
</div>

* [构建规则](#building-a-rule)
  * [规则限制](#rule-limitations)
  * [运算符可用性](#operator-availability)
  * [运算符类型：可独立使用与需搭配连接词](#operator-types-standalone-and-conjunction-required)
  * [布尔运算符与分组](#boolean-operators-and-grouping)
  * [运算顺序](#order-of-operations)
  * [标点符号、变音符号和大小写敏感](#punctuation-diacritics-and-case-sensitivity)
  * [精确度与效率](#specificity-and-efficiency)
  * [迭代式构建规则](#iteratively-building-a-rule)
  * [添加和删除规则](#adding-and-removing-rules)
  * [规则示例](#rule-examples)

<div id="building-a-rule">
  ### 创建规则
</div>

<div id="rule-limitations">
  #### 规则限制
</div>

规则数量的上限取决于为你的[项目](/zh/resources/fundamentals/projects)设置的[访问级别](/zh/x-api/getting-started/about-x-api)。

你可以在 [filtered stream 简介](/zh/x-api/posts/filtered-stream) 页面查看这些限制的具体适用情况。

<div id="operator-types-standalone-and-conjunction-required">
  #### 运算符类型：独立运算符和必须搭配使用的运算符
</div>

**独立运算符（standalone operators）** 可以单独使用，也可以与任何其他运算符（包括那些必须搭配使用的运算符）一起使用。

例如，下面的规则可以生效，因为它使用了 `#hashtag` 运算符，这是一个独立运算符：

`#xapiv2`

**必须搭配使用（conjunction required）** 的运算符不能在规则中单独使用；只有在规则中至少包含一个独立运算符时，它们才可以使用。因为如果单独使用这些运算符，条件会过于宽泛，可能匹配到极其大量的帖子。

例如，下面的规则不受支持，因为它们只包含必须搭配使用的运算符：

`has:media`

`has:links OR is:retweet`

如果我们加入一个独立运算符，例如短语 `"X data"`，该规则就可以正常生效。 

`"X data" has:mentions (has:media OR has:links)`

<div id="boolean-operators-and-grouping">
  #### 布尔运算符和分组
</div>

如果你希望在单条规则中串联多个运算符，可以使用以下方式：

|     |     |
| :--- | :--- |
| **AND 逻辑** | 连续的运算符**之间以空格分隔**时，会使用布尔 “AND” 逻辑，这意味着只有在两个条件都满足时，帖子才会匹配。例如，`snow day #NoSchool` 将匹配包含词语 snow 和 day 以及话题标签 #NoSchool 的帖子。 |
| **OR 逻辑** | 连续的运算符之间使用 OR 时，会使用 OR 逻辑，这意味着只要任一条件满足，帖子就会匹配。例如，指定 `grumpy OR cat OR #meme` 将匹配任何至少包含 grumpy 或 cat 之一，或话题标签 #meme 的帖子。 |
| **NOT 逻辑，取反** | 在关键字（或任意运算符）前加上短横线 (-) 即可对其取反（NOT）。例如，`cat #meme -grumpy` 将匹配包含话题标签 #meme 且包含词语 cat 的帖子，但前提是这些帖子不包含词语 grumpy。一个常见的规则子句是 `-is:retweet`，它不会匹配转帖（Retweet），从而只匹配原始帖子、引用帖子（Quote Tweets）以及回复。所有运算符都可以被取反，但被取反的运算符不能单独使用。 |
| **分组** | 你可以使用圆括号将运算符分组。例如，`(grumpy cat) OR (#meme has:images)` 将返回：要么是包含词语 grumpy 和 cat 的帖子，要么是带有图片且包含话题标签 #meme 的帖子。注意，系统会先应用 AND 逻辑，然后再应用 OR 逻辑。 |

<Note>
  **关于取反的说明**

  除 `sample:` 之外，所有运算符都可以被取反，并且 `-is:nullcast` 必须始终以取反形式使用。被取反的运算符不能单独使用。

  不要对一组被圆括号括起来的运算符整体取反。相反，应分别对每个运算符单独取反。

  例如，不要使用 `skiing -(snow OR day OR noschool)`，我们建议你使用 `skiing -snow -day -noschool`。 
</Note>

<div id="order-of-operations">
  #### 运算顺序
</div>

在同时使用 AND 和 OR 逻辑时，以下运算顺序将决定你的规则是如何被评估的。

1. 优先组合由 AND 逻辑连接的运算符
2. 然后再应用由 OR 逻辑连接的运算符

例如：

* `apple OR iphone ipad` 会被评估为 `apple OR (iphone ipad)`
* `ipad iphone OR android` 会被评估为 `(iphone ipad) OR android`

为消除不确定性并确保规则按预期被评估，请在合适的地方使用括号将词项进行分组。 

例如：

* `(apple OR iphone) ipad`
* `iphone (ipad OR android)`

<div id="punctuation-diacritics-and-case-sensitivity">
  #### 标点符号、变音符号以及大小写敏感性
</div>

如果你在规则中指定了带有字母重音或变音符号的关键词或话题标签，它只会匹配包含带有正确重音或变音符号的完整单词的帖子，而不会匹配那些虽然字母相同但缺少重音或变音符号的帖子。 

例如，包含关键词 `diacrítica` 或话题标签 `#cumpleaños` 的规则，会匹配包含 *diacrítica* 或 *#cumpleaños* 的帖子，因为它们包含相应的重音或变音符号。但这些规则不会匹配包含 *Diacritica* 或 *#cumpleanos* 的帖子，因为其中缺少重音 í 或字母 ñ。

带有重音或变音符号的字符与普通字符一样处理，并不会被视为单词分隔符。例如，一个包含关键词 *cumpleaños* 的规则，只会匹配包含单词 *cumpleaños* 的帖子，而不会匹配包含 *cumplea*、*cumplean* 或 *os* 的帖子。

所有运算符的评估都不区分大小写。例如，规则 cat 将匹配以下所有内容：*cat*、*CAT*、*Cat*。

<Note>
  [Search Posts](/zh/x-api/posts/search/introduction) 的匹配行为与 filtered stream 不同。在[构建 Search Posts 查询](/zh/x-api/posts/search/integrate/build-a-query)时，需要了解：包含重音或变音符号的关键词和话题标签，将同时匹配带有这些重音和变音符号的形式，以及对应的普通字符形式。 

  例如，包含关键词 `Diacrítica` 或话题标签 `#cumpleaños` 的 Search Posts 查询，会同时匹配 *Diacrítica* 和 *#cumpleaños*，以及不带重音 í 或字母 ñ 的 *Diacritica* 或 *#cumpleanos*。
</Note>

<div id="specificity-and-efficiency">
  #### 精准性与效率
</div>

当你开始构建规则时，有几件事情需要牢记。

* 通常不建议在规则中仅使用单一关键词或 #hashtag 之类宽泛、独立的运算符，因为这很可能会匹配到海量帖子。构建更为健壮的规则可以得到更精准的一组匹配帖子，并有望减少响应负载中的噪音，从而降低你在从中筛选出有价值洞见时的工作量。 
  * 例如，如果你的规则只是关键词 `happy`，你每天很可能会收到 200,000 - 300,000 条帖子。
  * 添加更多条件运算符会缩小搜索结果范围，例如 `(happy OR happiness) place_country:GB -birthday -is:retweet`
* 编写高效的规则还有助于保持在规则字符长度限制之内。字符计数包含整个规则字符串中的所有字符，包括空格和运算符。
  * 例如，下列规则的长度为 59 个字符：`(happy OR happiness) place_country:GB -birthday -is:retweet`

<div id="quote-tweet-matching-behavior">
  #### 引用帖子匹配行为
</div>

在使用 filtered stream 端点时，运算符会同时匹配被引用的原始帖子中的内容，以及引用帖子本身包含的内容。

但请注意，[Search Posts](/zh/x-api/posts/search/introduction) 端点不会匹配被引用的原始帖子中的内容，只会匹配引用帖子本身的内容。

<div id="iteratively-building-a-rule">
  #### 逐步构建规则
</div>

<div id="test-your-rule-early-and-often">
  ##### 及早且频繁地测试你的规则
</div>

要让一条规则在第一次尝试时就返回“正确”的结果是很少见的。X 上有海量内容，其中很多一开始可能并不显而易见，而上文描述的规则语法也可能不容易与你想要的搜索精确匹配。在你构建规则的过程中，定期使用流式端点对其进行测试，以查看它返回了什么数据，这一点非常重要。你也可以使用其中一个 [Search Post](/zh/x-api/posts/search/introduction) 端点进行测试，前提是你使用的运算符在该端点中同样可用。 

在本节中，我们将从以下规则开始，并根据测试过程中得到的结果对其进行调整： 

`happy OR happiness`

<div id="use-results-to-narrow-the-rule">
  ##### 使用结果来缩小规则范围
</div>

在测试规则时，你应当检查返回的帖子，确认其中是否包含你期望获取的数据。先从一个范围较宽、匹配结果较多的规则开始，可以先审查结果，再逐步收紧规则，以过滤掉不需要的结果。  

在我们测试示例规则时，我们注意到返回的帖子包含多种不同语言。在这种情况下，我们只想接收英文帖子，因此要添加 `lang:` 运算符：

`(happy OR happiness) lang:en`

测试返回了许多祝人生日快乐的帖子，因此我们要添加 `-birthday` 作为否定关键词运算符。我们还只希望接收原创帖子，所以再添加否定形式的 `-is:retweet` 运算符：

`(happy OR happiness) lang:en -birthday -is:retweet`

<div id="adjust-for-inclusion-where-needed">
  ##### 在需要时调整包含范围
</div>

如果你发现没有收到预期的数据，并且确定已经存在本应被返回的帖子，那么你可能需要通过移除某些会过滤掉目标数据的运算符来放宽规则范围。 

在我们的示例中，我们注意到，在我们的个人时间线上还有其他表达我们所寻找情绪的帖子，但并未被包含在测试结果中。为确保有更高的覆盖率，我们将添加关键词 `excited` 和 `elated`。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet`

<div id="adjust-for-popular-trendsbursts-over-the-time-period">
  ##### 针对时间范围内的热门趋势/突发情况进行调整
</div>

在 X 上，热门趋势来得快去得也快。维护规则应该是一个持续的过程。如果你计划在一段时间内使用同一个规则，我们建议你定期检查自己接收到的数据，看看是否需要做出任何调整。

在我们的示例中，我们注意到开始收到一些祝人们“节日快乐”的帖子。由于我们不希望这些帖子出现在结果中，我们将添加一个用于排除的 `-holidays` 关键字。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet -holidays`

<div id="adding-and-removing-rules">
  #### 添加和删除规则
</div>

当你向流中添加或删除规则时，需要使用 [POST /2/tweets/search/stream/rules](/zh/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) 这个端点。

要向你的流中添加一个或多个规则，请提交一个包含 `add` 字段的 JSON 请求体，其中 `add` 字段为一个数组，数组中包含带有规则的 value 参数，以及可选的 `tag` 参数。`tag` 参数可以包含任意自定义文本，用来 [标识哪些返回的帖子匹配此规则](/zh/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule)。 

例如，如果你要向流中添加一组规则，你的 cURL 命令可能如下所示：

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
-H "Content-type: application/json" \
-H "Authorization: Bearer $ACCESS_TOKEN" -d \
'{
  "add": [
    {"value": "cat has:media", "tag": "cats with media"},
    {"value": "cat has:media -grumpy", "tag": "带媒体的开心猫"},
    {"value": "meme", "tag": "funny things"},
    {"value": "meme has:images"}
  ]
}'
```

类似地，要从流中移除一条或多条规则，请提交一个 `delete` JSON 请求体，其中的数组应包含带有规则 `id` 参数的对象，这些 `id` 即为你想要删除的规则 ID。

例如，如果你要从流中移除一组规则，你的 cURL 命令可能如下所示：

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
  -H "Content-type: application/json" \
  -H "Authorization: Bearer $ACCESS_TOKEN" -d \
  '{
    "delete": {
      "ids": [
        "1165037377523306498",
        "1165037377523306499"
      ]
    }
  }'
```

我们提供了支持多种编程语言的示例代码，可通过我们的 [GitHub](https://github.com/xdevplatform/Twitter-API-v2-sample-code/tree/master/Filtered-Stream) 获取。

<div id="rule-examples">
  #### 规则示例
</div>

<div id="tracking-a-natural-disaster">
  ##### 跟踪自然灾害
</div>

以下规则会匹配来自气象机构和监测站、讨论 2017 年袭击休斯敦的飓风 Harvey 的帖子。请注意使用 [matching rules](/zh/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule) 标记，以及在向 [POST /2/tweets/search/stream/rules endpoint](/zh/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) 提交规则时需要使用的 JSON 格式。

```json
{
    "value": "-is:retweet has:geo (from:NWSNHC OR from:NHC_Atlantic OR from:NWSHouston OR from:NWSSanAntonio OR from:USGS_TexasRain OR from:USGS_TexasFlood OR from:JeffLindner1)",
    "tag": "theme:info has:geo original from weather agencies and gauges"
}
```

<div id="reviewing-the-sentiment-of-a-conversation">
  ##### 分析一段讨论的情绪倾向
</div>

下面这个规则可用于更好地理解围绕 *#nowplaying* 这一话题标签展开的讨论情绪，但仅限于北美地区发布的帖子。

```json
{
    "value": "#nowplaying (happy OR exciting OR excited OR favorite OR fav OR amazing OR lovely OR incredible) (place_country:US OR place_country:MX OR place_country:CA) -horrible -worst -sucks -bad -disappointing",
    "tag": "#nowplaying positive"
},
{
    "value": "#nowplaying (horrible OR worst OR sucks OR bad OR disappointing) (place_country:US OR place_country:MX OR place_country:CA) -happy -exciting -excited -favorite -fav -amazing -lovely -incredible",
    "tag": "#nowplaying negative"
}
```

<div id="find-posts-that-relate-to-a-specific-post-annotation">
  ##### 查找与特定帖子注释相关的帖子
</div>

此规则用于搜索包含宠物（但不是猫）图片的原始帖子，并且该帖子检测到的语言为日语。为此，我们使用了 `context:` 运算符来利用[帖子注释](/zh/x-api/fundamentals/post-annotations)功能。我们首先使用 [Post lookup](/zh/x-api/posts/lookup/introduction) 端点和 `tweet.fields=context_annotations` 字段参数，以确定在查询中需要使用哪些 domain.entity ID：

* 与猫相关的帖子会返回 `domain` 66（Interests and Hobbies 分类）以及 `entity` 852262932607926273（Cats）。
* 与宠物相关的帖子会返回 `domain` 65（Interests and Hobbies 垂直领域）以及 `entity` 852262932607926273（Pets）。
   

该规则将如下所示：

```json
{
    "value": "context:65.852262932607926273 -context:66.852262932607926273 -is:retweet has:images lang:ja",
    "tag": "Japanese pets with images - no cats"
}
```
