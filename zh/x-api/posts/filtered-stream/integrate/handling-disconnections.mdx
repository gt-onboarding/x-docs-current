---
title: 处理断开连接
sidebarTitle: 处理断开连接
keywords: ["流式连接中断", "处理连接中断", "重新连接流", "流重连", "连接中断处理", "流错误"]
---

<div id="what-is-a-disconnection">
  ### 什么是连接中断？
</div>

与流式 API 建立连接意味着发起一个持续时间很长的 HTTPS 请求，并且对响应进行增量解析。当连接到 filtered stream 端点时，你应当构造一个 HTTPS 请求，并在实际可行的情况下尽可能长时间持续消费返回的流数据。除非出现服务器端错误、严重的客户端延迟、网络问题、例行的服务器维护或重复登录等情况，我们的服务器会无限期保持该连接处于打开状态。对于与流式端点的连接，连接中断是很常见且应当预期的情况，因此需要构建相应的重连逻辑。
 

<div id="why-a-streaming-connection-might-be-disconnected">
  #### 流式连接可能被断开的原因
</div>

你的流可能会因为多种原因而断开。检查流返回的错误信息，以了解失败的原因。可能的断开原因包括：

* 认证错误（例如使用了错误的令牌或错误的认证方式）。
* X 端的流式服务器被重启。这通常与代码部署有关，应当视为正常情况，并在设计中加以考虑。
* 你的客户端跟不上流中传递的帖子量，或者读取数据太慢。每个流式连接背后都有一个要发送给客户端的消息队列。如果这个队列随着时间推移变得过大，连接就会被关闭。
* 你的账号超出了每日/每月的帖子配额。
* 你有过多冗余的活动连接。
* 客户端突然停止读取数据。如果从流中读取帖子的速率突然下降，连接将被关闭。
* 服务器与客户端之间可能存在网络问题。
* 临时的服务器端问题、计划中的维护和更新。（请查看[状态页面](https://api.twitterstat.us/)）
   

<div id="common-disconnection-errors-include">
  #### 常见的断开连接错误包括：
</div>

```{
	"errors": [{
		"title": "operational-disconnect",
		"disconnect_type": "UpstreamOperationalDisconnect",
		"detail": "此流因操作原因已在上游断开连接。",
		"type": "https://api.x.com/2/problems/operational-disconnect"
	}]
}
```

```
{
	"title": "ConnectionException",
	"detail": "This stream is currently at the maximum allowed connection limit.",
	"connection_issue": "TooManyConnections",
	"type": "https://api.x.com/2/problems/streaming-connection"
}
```

<div id="anticipating-disconnects-and-reconnecting">
  #### 预判断连并进行重连
</div>

在流式获取帖子时，目标是尽可能长时间保持连接，同时要意识到可能会发生断连。该 endpoint 会提供一个 20 秒的保活心跳（它表现为一个换行符）。使用该信号来检测你是否已被断开连接。

1. 你的代码应检测新内容和心跳何时不再到达。
2. 如果发生这种情况，你的代码应触发重连逻辑。某些客户端和编程语言允许你指定读取超时时长，你可以将其设置为 20 秒。
3. 你的服务应检测到这些断连，并尽快重新连接。

一旦已建立的连接中断，应立即尝试重连。如果重连失败，应根据遇到的错误类型放慢重连尝试的频率：

* 对于 TCP/IP 级别的网络错误，采用线性退避。这类问题通常是暂时的，并且往往会很快消除。每次重连尝试将延迟增加 250ms，最多增加到 16 秒。
* 对于适合重连的 HTTP 错误，采用指数退避。初始等待 5 秒，每次尝试将等待时间加倍，最多到 320 秒。
* 对于 HTTP 429 错误（超出速率限制），采用指数退避。初始等待 1 分钟，每次尝试将等待时间加倍。请注意，每收到一次 HTTP 429，都会增加你必须等待的时间，直到你的账号不再受到速率限制为止。
   

<div id="recovering-lost-data">
  #### 恢复丢失的数据
</div>

如果你确实遇到断连，可以采用多种不同的策略，来确保拿回你可能错过的所有数据。我们在集成指南中的[数据恢复](/zh/x-api/posts/filtered-stream/integrate/recovery-and-redundancy-features)部分介绍了一些可用于恢复遗漏数据的关键步骤。 
 

<div id="rate-limits-and-usage">
  #### 速率限制和使用情况
</div>

要检查连接限制，响应会返回三个 header。这有助于你了解可以使用规则端点的次数，以及流端点允许的重连尝试次数。

* x-rate-limit-limit 表示在 15 分钟时间窗口内，你的客户端被允许发起的最大请求次数。

* x-rate-limit-remaining 表示在当前 15 分钟时间窗口内，剩余可用的请求次数。

* x-rate-limit-reset 是一个 UNIX 时间戳，表示 15 分钟时间窗口将于何时重置，并把 x-rate-limit-remaining 重置为 0。

过滤流端点目前不会报告使用数据。要检查已经传递了多少条帖子，你的代码可以实现一个计量逻辑，以便可以测量消费量，并在需要时暂停。 

在客户端承载流的代码只需将接收到的帖子插入到一个先进先出（FIFO）队列或类似的内存结构中；应由单独的进程/线程从该队列中取出帖子，对其进行解析并准备好内容以进行存储。采用这种设计后，当传入帖子量发生剧烈变化时，你就可以实现一个能够高效扩展的服务。从概念上讲，你可以把它看作通过 HTTP 下载一个无限长的文件。

<div id="reconnection-best-practices">
  #### 重新连接最佳实践
</div>

**测试退避策略**

测试退避实现的一个好方法是使用无效的授权凭证，并检查重连尝试情况。良好的实现不应收到任何 429 响应。

**为多次重新连接发出告警**

如果客户端在两次重新连接之间的时间达到了其预设的上限阈值，则应向你发送通知，方便你排查影响连接的问题。

**处理 DNS 变更**

测试你的客户端进程是否遵循 DNS 生存时间（TTL，Time To Live）。某些技术栈会在进程整个生命周期内缓存解析得到的地址，并不会在规定的 TTL 内感知 DNS 变更。如此激进的缓存会在 X 在不同 IP 地址之间进行负载切换时导致你的客户端出现服务中断。

**User Agent**

确保你的 user-agent HTTP 头中包含客户端的版本信息。这对于诊断 X 端的问题至关重要。如果你的运行环境无法设置 user-agent 字段，则请设置一个 x-user-agent 头。