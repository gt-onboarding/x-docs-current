---
title: 处理断开连接
sidebarTitle: 处理断开连接
keywords: ["powerstream 断开连接", "处理断开连接", "重新连接 powerstream", "流中断", "powerstream 错误"]
---

<div id="what-is-a-disconnection">
  ## 什么是连接中断？
</div>

与流式 API 建立连接意味着发起一个会长时间保持打开的 HTTPS 请求，并以增量方式解析响应。连接到 powerstream 端点时，你应当发起一个 HTTPS 请求，并在实际可行的情况下尽可能长时间地消费返回的流。除非发生服务器端错误、客户端严重延迟、网络问题、常规服务器维护或重复登录等情况，我们的服务器会无限期保持该连接处于打开状态。对于连接到流式端点的场景，很有可能（也应当预期）会发生连接中断，因此需要构建重连逻辑。

<div id="why-a-streaming-connection-might-be-disconnected">
  ## 流式连接可能被断开的原因
</div>

你的流式连接可能因为多种原因而断开。检查流返回的错误信息以了解失败的原因。可能的断开原因包括：

* 身份验证错误（例如使用了错误的 token 或错误的身份验证方法）。
* X 端的流式服务器被重启。这通常与代码部署有关，应当预期到并在设计中加以考虑。
* 你的客户端无法跟上流中传递的帖子量，或读取数据的速度太慢。每个流式连接背后都有一个要发送给客户端的消息队列。如果该队列随着时间推移变得过大，连接将被关闭。
* 你的账号超出了每日或每月的帖子配额。
* 你有太多处于活动状态的冗余连接。
* 客户端突然停止读取数据。如果从流中读取帖子的速率突然下降，连接将被关闭。
* 服务器与客户端之间可能存在网络问题。
* 服务器端的临时问题、计划维护或更新（请查看 [状态页](/zh/status)）。

<div id="anticipating-disconnects-and-reconnecting">
  ## 预期连接中断与重连
</div>

在流式获取帖子时，目标是尽可能长时间保持连接，同时要认识到连接可能会中断。该 endpoint 提供一个 20 秒的 keep alive 心跳信号（表现为一个换行符）。使用该信号来检测你是否已被断开连接。

1. 你的代码应检测新内容和心跳何时不再到达。
2. 如果发生这种情况，你的代码应触发重连逻辑。一些客户端和语言允许你指定读取超时时间，你可以将其设置为 20 秒。
3. 你的服务应检测到这些断开连接，并尽快重新连接。

一旦已建立的连接中断，应立即尝试重连。如果重连失败，应根据遇到的错误类型放慢重连尝试的频率：

* 对 TCP/IP 层面的网络错误使用线性退避。这类问题通常是暂时的，并且往往会很快恢复。每次重连尝试将延迟增加 250ms，最多增加到 16 秒。
* 对适合重连的 HTTP 错误使用指数退避。从等待 5 秒开始，每次尝试将等待时间加倍，最长到 320 秒。
* 对 HTTP 429（超出速率限制）错误使用指数退避。从等待 1 分钟开始，每次尝试将等待时间加倍。请注意，每次收到 HTTP 429 都会增加你必须等待的时间，直到你的账号不再受速率限制影响为止。
   

<div id="recovering-lost-data">
  ## 恢复丢失的数据
</div>

如果你确实遇到了断连，可以采用多种策略来确保获取到所有可能错过的数据。我们在集成指南的[数据恢复](/zh/x-api/powerstream/recovery-and-redundancy)一节中列出了一些关键步骤，帮助你恢复遗漏的数据。 
 

<div id="rate-limits-and-usage">
  ## 速率限制和使用情况
</div>

要检查速率限制，响应会返回三个 header。这有助于了解你可以多少次使用规则端点，以及流式端点允许多少次重新连接尝试。

* x-rate-limit-limit 表示在 15 分钟窗口内，允许你的客户端发起的请求配额数量。

* x-rate-limit-remaining 表示在当前 15 分钟窗口内，剩余可用的请求数量。

* x-rate-limit-reset 是一个 UNIX 时间戳，表示 15 分钟窗口何时重置，并将 x-rate-limit-remaining 重置为 0。

过滤流端点目前不会报告使用数据。要检查已传递了多少条帖子，你的代码可以实现计量逻辑，这样就可以在需要时对消费进行统计并暂停。 

在负责流式客户端的代码中，只需将接收的帖子插入一个先进先出（FIFO）队列或类似的内存结构；另一个独立的进程/线程应从该队列中取出帖子，以解析并准备内容进行存储。采用这种设计，当传入帖子量大幅变化时，你可以实现一个能够高效扩展的服务。从概念上，你可以将其视为通过 HTTP 下载一个无限长的文件。

<div id="reconnection-best-practices">
  ## 重连最佳实践
</div>

<div id="test-backoff-strategies">
  ### 测试退避策略
</div>

测试退避实现的一种有效方法是使用无效的授权凭据，并观察重连尝试情况。良好的实现不应收到任何 429 响应。

<div id="issue-alerts-for-multiple-reconnects">
  ### 多次重连的问题告警
</div>

如果某个 Client 的重连间隔时间达到你设定的阈值上限，它应向你发送通知，以便你对影响连接的问题进行排查和处理。

<div id="handle-dns-changes">
  ### 处理 DNS 变更
</div>

测试你的客户端进程是否遵守 DNS 的生存时间（TTL，Time To Live）。某些技术栈会在整个进程生命周期内缓存解析得到的地址，而不会在规定的 TTL 内响应 DNS 变更。这种激进的缓存策略会在 X 在不同 IP 地址之间切换负载时，导致你的客户端出现服务中断。

<div id="user-agent">
  ### User Agent
</div>

请确保你的 `user-agent` HTTP 请求头中包含客户端的版本信息。这对于 X 端诊断问题至关重要。如果你的环境无法设置 `user-agent` 字段，请改为设置 `x-user-agent` 请求头。