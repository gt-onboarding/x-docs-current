---
title: 处理断开连接
sidebarTitle: 处理断开连接
keywords: ["powerstream 断开连接", "处理断开连接", "重新连接 powerstream", "流连接中断", "powerstream 错误"]
---

<div id="what-is-a-disconnection">
  ## 什么是断开连接？
</div>

与流式 API 建立连接意味着发起一个持续时间很长的 HTTPS 请求，并以增量方式解析响应。当连接到 powerstream 端点时，你应当发起一个 HTTPS 请求，并在实际可行的情况下尽可能长时间地读取/消费返回的流。我们的服务器会在没有服务端错误、过高的客户端延迟、网络问题、常规服务器维护或重复登录等情况的前提下无限期保持连接打开。对于连接到流式端点的场景，连接中断是常见且应当预期的情况，因此需要实现重连逻辑。

<div id="why-a-streaming-connection-might-be-disconnected">
  ## 流式连接可能断开的原因
</div>

你的流式连接可能由于多种原因而断开。检查流返回的错误信息，以了解失败的原因。可能导致断开的原因包括：

* 身份验证错误（例如使用了错误的 token 或错误的身份验证方式）。
* X 端的流式服务器被重启。这通常与代码部署相关，应视为预期情况并在设计中加以考虑。
* 你的客户端处理不过来流中传递的帖子量，或者读取数据的速度过慢。每个流式连接的后端都有一个要发送给客户端的消息队列。如果这个队列随着时间推移变得过大，连接将被关闭。
* 你的账户超过了每天/每月的帖子配额。
* 你有过多冗余的活动连接。
* 客户端突然停止读取数据。如果从流中读取帖子的速率突然下降，连接将被关闭。
* 服务器和客户端之间可能存在网络问题。
* 暂时性的服务器端问题、计划维护和更新。（请查看[状态页面](/zh/status)）

<div id="anticipating-disconnects-and-reconnecting">
  ## 预期断连并进行重连
</div>

在流式获取帖子时，目标是尽可能长时间保持连接，同时要认识到断连可能会发生。该 endpoint 会提供一个 20 秒的保活心跳信号（表现为一个换行符）。使用这个信号来检测你是否已被断开连接。

1. 你的代码应检测新内容和心跳何时停止到达。
2. 如果发生这种情况，你的代码应触发重连逻辑。一些客户端和语言允许你指定读取超时时间，你可以将其设置为 20 秒。
3. 你的服务应检测到这些断连并尽快重新连接。

一旦已建立的连接中断，应立即尝试重连。如果重连失败，应根据遇到的错误类型放缓重连尝试的频率：

* 对 TCP/IP 级别的网络错误采用线性退避。这类问题通常是暂时的，往往会很快恢复。每次重连尝试将延迟增加 250ms，最长到 16 秒。
* 对适合重连的 HTTP 错误采用指数退避。先等待 5 秒，每次尝试将等待时间加倍，最长到 320 秒。
* 对 HTTP 429 错误（超出速率限制）采用指数退避。先等待 1 分钟，每次尝试将等待时间加倍。请注意，每收到一次 HTTP 429，都会增加你必须等待的时间，直到你的账号不再受到速率限制的影响。
   

<div id="recovering-lost-data">
  ## 恢复丢失的数据
</div>

如果确实发生了断开连接，你可以采用多种策略，来确保获取到所有可能错过的数据。我们在集成指南中的[数据恢复](/zh/x-api/powerstream/recovery-and-redundancy)一节中介绍了一些关键步骤，你可以按照这些步骤来恢复遗漏的数据。 
 

<div id="rate-limits-and-usage">
  ## 速率限制和用量
</div>

要检查连接限制，响应会返回三个 header。这样有助于了解你可以使用规则端点的次数上限，以及流式端点允许的重连尝试次数。

* x-rate-limit-limit 表示在 15 分钟时间窗口内你的客户端被允许发起的最大请求数。

* x-rate-limit-remaining 表示在当前 15 分钟时间窗口内到目前为止已经发起的请求数量。

* x-rate-limit-reset 是一个 UNIX 时间戳，表示 15 分钟时间窗口何时重置，并将 x-rate-limit-remaining 重置为 0。

过滤流端点当前不会报告用量数据。要检查已传递了多少条帖子，你的代码可以实现计量逻辑，以便在需要时可以对消费量进行统计并暂停。 

在客户端一侧承载流的代码只需将收到的帖子插入到先进先出 (FIFO) 队列或类似的内存结构中；应由单独的进程/线程从该队列中消费帖子，以解析并准备内容进行存储。采用这种设计，当传入帖子量发生大幅变化时，你就可以实现一个能够高效扩展的服务。从概念上讲，你可以把这看作是通过 HTTP 下载一个无限长的文件。

<div id="reconnection-best-practices">
  ## 重连最佳实践
</div>

<div id="test-backoff-strategies">
  ### 测试退避策略
</div>

测试退避实现的一个好方法是使用无效的授权凭证，并观察重连尝试的情况。优秀的实现不会收到任何 429 响应。

<div id="issue-alerts-for-multiple-reconnects">
  ### 针对频繁重连发出告警
</div>

如果某个客户端的重连间隔时间达到了你设定的上限阈值，它应当向你发送通知，以便你对影响连接的问题进行排查。

<div id="handle-dns-changes">
  ### 处理 DNS 变更
</div>

测试你的客户端进程是否遵守 DNS 生存时间（TTL，Time To Live）。某些技术栈会在整个进程生命周期内缓存已解析的地址，并且不会在规定的 TTL 内检测到 DNS 变更。这种过于激进的缓存策略会在 X 在不同 IP 地址之间切换负载时，导致你的客户端发生服务中断。

<div id="user-agent">
  ### User Agent
</div>

请确保你的 user-agent HTTP 头中包含客户端的版本信息。这对于在 X 端诊断问题至关重要。如果你的运行环境无法设置 user-agent 头，则请改为设置 x-user-agent 头。