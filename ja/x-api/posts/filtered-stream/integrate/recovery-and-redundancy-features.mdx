---
title: 復旧と冗長性
sidebarTitle: 復旧と冗長性
keywords: ["復旧", "冗長性", "ストリーム復旧", "再接続", "フォールトトレランス", "ストリーム冗長性", "エラー復旧"]
---

<div id="introduction">
  #### はじめに
</div>

ストリーミングデータを利用する際には、接続時間を最大化し、一致したデータをすべて受信することが基本的な目標となります。そのためには、冗長接続を活用し、自動的に切断を検知してすばやく再接続し、失われたデータを復旧するための計画を用意しておくことが重要です。

このインテグレーションガイドでは、さまざまなリカバリおよび冗長化機能について説明します。具体的には、冗長接続、バックフィル、およびリカバリです。
 

**冗長接続**

冗長接続を利用すると、filtered stream に対して複数の同時接続を確立できます。これにより、2 つの別々のコンシューマーで同じストリームに接続し、両方の接続から同一のデータを受信することで冗長性が確保されます。したがって、1 つのストリームが切断された場合や、アプリケーションのプライマリサーバーが障害を起こした場合など、さまざまな状況に対して、アプリにはホットフェイルオーバー機能が備わることになります。

現在、filtered stream では Enterprise アクセスを持つプロジェクトのみが、最大 2 つまで冗長接続を確立できます。冗長ストリームを利用するには、プライマリ接続で使用しているものと同じ URL に接続するだけです。ストリームのデータは両方の接続を通じて送信されます。

<div id="recovering-missed-data-after-a-disconnection-backfill">
  #### 切断後の取りこぼしたデータの復旧: バックフィル
</div>

切断を検知したら、システムはストリームへ再接続できるようになっている必要があります。可能であれば、どれくらいの時間切断されていたかを記録し、その時間に応じて適切なリカバリ機能を使ってデータをバックフィルできるようにしてください。 

Enterprise アクセス権のあるプロジェクトを使用していて、切断が 5 分以内であったと判断できる場合は、バックフィル用パラメータ `backfill_minutes` を使用できます。 このパラメータを [GET /tweets/search/stream](/ja/x-api/posts/filtered-stream#get-2-tweets-search-stream) リクエストに付与すると、直近 1〜5 分以内にルールにマッチしたポストを受け取ることができます。通常、これらの古いポストは新たにマッチしたポストよりも先に配信され、またポストの重複排除は行われません。つまり、90 秒間切断していた状態で 2 分分のバックフィルデータを要求した場合、30 秒分の重複したポストを受け取ることになり、システム側がそれを許容できる必要があります。以下は、バックフィルパラメータを付与したリクエスト例です:

`curl 'https://api.x.com/2/tweets/search/stream?backfill_minutes=5' -H "Authorization: Bearer $ACCESS_TOKEN"`

Enterprise アクセス権がない場合、または切断時間が 5 分を超えていたと判定された場合は、取りこぼしたデータを取得するために [recent search endpoint](/ja/x-api/posts/search/introduction) またはリカバリ機能を利用できます。ただし、search ポストエンドポイントには `sample:`, `bio:`, `bio_name:`, `bio_location:` オペレーターが含まれておらず、キーワードおよび `#hashtag` オペレーターでアクセントやダイアクリティカルマークを使用した場合のマッチング挙動にもいくつか違いがあります。これらの違いにより、filtered stream エンドポイント経由で受信できていたはずのポストを、完全には復旧できない可能性があります。 

**切断後の取りこぼしたデータの復旧: リカバリ**

Enterprise アクセス権のあるプロジェクトを使用している場合、5 分間のバックフィルウィンドウ内に再接続できなかったときでも、Recovery 機能を利用して直近 24 時間以内の取りこぼしたデータを復旧できます。

ストリーミング向け Recovery 機能では、バックフィルウィンドウを 24 時間まで拡張できます。Recovery によって、取りこぼした期間のデータを「再生」することができます。Recovery ストリームは、`start_time` と `end_time` リクエストパラメータを使用して接続リクエストを行ったときに開始されます。接続が確立されると、Recovery は指定した時間範囲のデータを再ストリームし、その後切断します。  

Recovery には同時に 2 件までリクエスト（「2 つのリカバリジョブ」）を行うことができます。Recovery は、開始時刻と終了時刻が指定される点を除き、技術的にはバックフィルと同じ動作をします。1 つのリカバリ期間は、1 つの時間範囲のみを対象とします。

|     |     |     |
| :--- | :--- | :--- |
| **Name** | **Type** | **Description** |
| start&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />復旧の開始時刻を示す UTC の日時。 |
| end&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />復旧の終了時刻を示す UTC の日時。 |

リクエスト URL の例: [https://api.x.com/2/tweets/search/stream?start&#95;time=2022-07-12T15:10:00Z&amp;end&#95;time=2022-07-12T15:20:00Z](https://api.x.com/2/tweets/search/stream?start_time=1985-04-12T23:20:50.52Z\&end_time=1985-04-13T00:20:50.52Z)