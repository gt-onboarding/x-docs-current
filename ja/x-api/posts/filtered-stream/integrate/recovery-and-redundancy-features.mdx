---
title: 復旧と冗長性
sidebarTitle: 復旧と冗長性
keywords: ["復旧", "冗長性", "ストリームの復旧", "再接続", "フォールトトレランス", "ストリームの冗長化", "エラー復旧"]
---

<div id="introduction">
  #### はじめに
</div>

ストリーミングデータを利用する際には、接続時間を最大化し、一致したデータを漏れなく受信することが基本的な目標となります。つまり、冗長接続を活用し、自動的に切断を検知してすばやく再接続し、失われたデータを復旧するための計画を用意しておくことが重要です。

このインテグレーションガイドでは、さまざまな復旧および冗長性の機能について説明します。具体的には、冗長接続、バックフィル、および復旧機能です。
 

**冗長な接続**

冗長接続を利用すると、filtered stream への同時接続を複数確立できるようになります。これにより、2 つの別々のコンシューマーから同じストリームに接続し、両方の接続を通じて同じデータを受信することで、冗長性が確保されます。その結果、一方のストリームが切断された場合や、アプリケーションのプライマリサーバーに障害が発生した場合など、さまざまな状況に対してアプリでホットフェイルオーバーを実現できます。

filtered stream では現在、Enterprise アクセスを持つプロジェクトのみが、最大 2 つまでの冗長接続を確立できます。冗長なストリームを使用するには、プライマリ接続で使用しているのと同じ URL に接続するだけです。ストリームのデータは両方の接続を通じて送信されます。

<div id="recovering-missed-data-after-a-disconnection-backfill">
  #### 切断後の取り逃したデータの復旧: バックフィル
</div>

切断を検知したら、システムはストリームに再接続できるようになっている必要があります。可能であれば、適切な復旧機能を使ってデータをバックフィルできるように、切断がどのくらいの時間続いたかをシステム側で記録しておくべきです。 

Enterprise アクセス権を持つプロジェクトを使用していて、切断時間が 5 分以下であることがわかっている場合は、バックフィル用パラメータである `backfill_minutes` を使用できます。このパラメータを [GET /tweets/search/stream](/ja/x-api/posts/filtered-stream#get-2-tweets-search-stream) リクエストに付与すると、過去 1〜5 分間にルールにマッチしたポストを受信します。通常、これらの古いポストは新しくマッチしたポストより先に配信され、またポストの重複排除は行われません。つまり、90 秒間切断されていたにもかかわらず、2 分間分のバックフィルデータをリクエストした場合、30 秒分の重複したポストを受信することになり、システム側でそれを許容できる必要があります。以下は、バックフィルパラメータを指定したリクエスト例です。

`curl 'https://api.x.com/2/tweets/search/stream?backfill_minutes=5' -H "Authorization: Bearer $ACCESS_TOKEN"`

Enterprise アクセス権がない場合、または切断時間が 5 分を超えていたと判断した場合は、取り逃したデータをリクエストするために [recent search エンドポイント](/ja/x-api/posts/search/introduction) または Recovery 機能を利用できます。ただし、search Posts エンドポイントには `sample:`, `bio:`, `bio_name:`, `bio_location:` オペレーターが含まれておらず、さらに `keyword` および `#hashtag` オペレーターでアクセントやダイアクリティカルマークを使用した場合のマッチング動作にもいくつか異なる点があることに注意してください。これらの違いにより、filtered stream エンドポイント経由で本来受信されていたはずのすべてのポストを完全には復旧できない可能性があります。 

**切断後の取り逃したデータの復旧: リカバリ**

Enterprise アクセス権を持つプロジェクトを使用している場合、5 分間のバックフィルウィンドウ内に再接続できなかった場合でも、直近 24 時間以内の取り逃したデータを復旧するために Recovery 機能を使用できます。

ストリーミングのリカバリ機能により、バックフィルウィンドウを 24 時間まで拡張できます。Recovery を使うと、取り逃したデータの発生期間を「再生」できます。リカバリストリームは、`start_time` と `end_time` リクエストパラメータを使用して接続リクエストを行うと開始されます。接続が確立されると、Recovery は指定された期間のデータを再ストリームし、その後切断します。  

Recovery には同時に 2 件まで、つまり「2 つのリカバリジョブ」を並行してリクエストできます。Recovery は、開始時刻と終了時刻が定義される点を除き、技術的にはバックフィルと同じように動作します。1 つのリカバリ期間は、単一の時間範囲を対象とします。

|     |     |     |
| :--- | :--- | :--- |
| **Name** | **Type** | **Description** |
| start&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />復旧を開始する時刻を示す UTC の日時。 |
| end&#95;time | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />復旧を終了する時刻を示す UTC の日時。 |

リクエスト URL の例: [https://api.x.com/2/tweets/search/stream?start&#95;time=2022-07-12T15:10:00Z&amp;end&#95;time=2022-07-12T15:20:00Z](https://api.x.com/2/tweets/search/stream?start_time=1985-04-12T23:20:50.52Z\&end_time=1985-04-13T00:20:50.52Z)