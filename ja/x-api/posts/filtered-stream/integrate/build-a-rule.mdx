---
title: ルールを構築する
sidebarTitle: ルールを構築する
keywords: ["ルールの構築", "フィルター ルール", "ストリーム ルール", "ルール ビルダー", "filtered stream ルール", "ルールを作成", "ルール ガイド"]
---

<div id="building-rules-for-filtered-stream">
  ## filtered stream 用のルールを作成する
</div>

filtered stream エンドポイントは、ストリームに適用される一連のルールにマッチするポストのみを配信します。ルールは、さまざまなポスト属性に対してマッチングを行うために使用されるオペレーターで構成されます。

複数のルールは、[POST /tweets/search/stream/rules](/ja/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) エンドポイントを使用してストリームに適用できます。ルールを追加し、[GET /tweets/search/stream](/ja/x-api/posts/filtered-stream#get-2-tweets-search-stream) エンドポイントを使ってストリームに接続すると、そのルールにマッチするポストだけが、永続的なストリーミング接続を通じて配信されます。ルールを追加または削除するために、ストリームから切断する必要はありません。 

<div id="table-of-contents">
  ### 目次
</div>

* [ルールの作成](#building-a-rule)
  * [ルールの制限事項](#rule-limitations)
  * [オペレーターの利用可否](#operator-availability)
  * [オペレーターの種類: 単独使用可能と結合必須](#operator-types-standalone-and-conjunction-required)
  * [ブール演算子とグルーピング](#boolean-operators-and-grouping)
  * [演算の優先順位](#order-of-operations)
  * [句読点、ダイアクリティカルマーク、大文字小文字の区別](#punctuation-diacritics-and-case-sensitivity)
  * [具体性と効率性](#specificity-and-efficiency)
  * [ルールを段階的に構築する](#iteratively-building-a-rule)
  * [ルールの追加と削除](#adding-and-removing-rules)
  * [ルール例](#rule-examples)

<div id="building-a-rule">
  ### ルールの作成
</div>

<div id="rule-limitations">
  #### ルールの制限事項
</div>

ルール数の上限は、[プロジェクト](/ja/resources/fundamentals/projects)に適用されている[アクセスレベル](/ja/x-api/getting-started/about-x-api)によって異なります。

これらの上限がどのように適用されるかは、[filtered stream の概要](/ja/x-api/posts/filtered-stream)ページで確認できます。

<div id="operator-types-standalone-and-conjunction-required">
  #### 演算子の種類: スタンドアロンと結合必須
</div>

**スタンドアロン演算子** は、それ単体で、または他の任意の演算子（結合が必要な演算子を含む）と組み合わせて使用できます。

たとえば、次のルールはスタンドアロンである `#hashtag` 演算子を使っているため有効です:

`#xapiv2`

**結合必須** の演算子は、ルール内で単独では使用できません。ルール内に少なくとも 1 つのスタンドアロン演算子が含まれている場合にのみ使用できます。これは、これらの演算子を単独で使用すると条件があまりに一般的になり、非常に大量のポストにマッチしてしまうためです。

たとえば、次のルールは結合必須の演算子のみを含んでいるため、サポートされていません:

`has:media`

`has:links OR is:retweet`

スタンドアロン演算子として `"X data"` のようなフレーズを追加すると、そのルールは正しく動作するようになります。

`"X data" has:mentions (has:media OR has:links)`

<div id="boolean-operators-and-grouping">
  #### ブール演算子とグループ化
</div>

1 つのルール内で複数の演算子を組み合わせて使用したい場合は、次のような方法を利用できます。

|     |     |
| :--- | :--- |
| **AND ロジック** | 連続する演算子の**間にスペースがある**場合、ブールの「AND」ロジックとして扱われます。これは、両方の条件を満たした場合にのみポストがマッチすることを意味します。たとえば、`snow day #NoSchool` は、snow と day という語句、およびハッシュタグ #NoSchool を含むポストにマッチします。 |
| **OR ロジック** | 演算子同士の間に OR を挟んで連続させると、OR ロジックとして扱われます。これは、いずれか一方の条件を満たした場合にポストがマッチすることを意味します。たとえば、`grumpy OR cat OR #meme` と指定すると、grumpy または cat のいずれかの語句、もしくはハッシュタグ #meme のうち少なくとも 1 つを含むすべてのポストにマッチします。 |
| **NOT ロジック、否定** | キーワード（または任意の演算子）の前にダッシュ (-) を付けることで、それを否定（NOT）できます。たとえば、`cat #meme -grumpy` は、ハッシュタグ #meme と cat という語句を含み、かつ grumpy という語句を含まないポストにマッチします。よく使われるルール句の 1 つに `-is:retweet` があり、これはリツイートにはマッチせず、オリジナルのポスト、引用ポスト、および返信のみにマッチします。すべての演算子は否定できますが、否定された演算子だけを単独で使用することはできません。 |
| **グループ化** | かっこを使用して演算子をグループ化できます。たとえば、`(grumpy cat) OR (#meme has:images)` は、grumpy と cat という語句の両方を含むポスト、または画像を含み、かつハッシュタグ #meme を含むポストのいずれかを返します。AND が先に適用され、その後に OR が適用される点に注意してください。 |

<Note>
  **否定についての注意**

  `sample:` を除き、すべての演算子は否定できます。また、`-is:nullcast` は常に否定された形で使用しなければなりません。否定された演算子だけを単独で使用することはできません。

  かっこで 1 つのまとまりとしてグループ化した演算子の集合全体を否定しないでください。代わりに、各演算子を個別に否定してください。

  たとえば、`skiing -(snow OR day OR noschool)` を使用する代わりに、`skiing -snow -day -noschool` を使用することをおすすめします。 
</Note>

<div id="order-of-operations">
  #### 演算の順序
</div>

AND と OR を組み合わせる場合、次の演算の順序によってルールの評価方法が決まります。

1. AND ロジックで接続されたオペレーターが最初にまとめて評価されます
2. 次に、OR ロジックで接続されたオペレーターが適用されます

例：

* `apple OR iphone ipad` は `apple OR (iphone ipad)` として評価されます
* `ipad iphone OR android` は `(iphone ipad) OR android` として評価されます

曖昧さを排除し、ルールが意図したとおりに評価されるようにするために、適切な箇所ではかっこを使って語句をグループ化してください。 

例：

* `(apple OR iphone) ipad`
* `iphone (ipad OR android)`

<div id="punctuation-diacritics-and-case-sensitivity">
  #### 句読点、発音記号、大小文字の区別
</div>

アクセントや発音記号を含む文字でキーワードまたはハッシュタグのルールを指定した場合、そのルールは、アクセントや発音記号も含めて完全に一致する語を含むポストにはマッチしますが、文字は同じでもアクセントや発音記号が付いていない語にはマッチしません。

たとえば、キーワード `diacrítica` またはハッシュタグ `#cumpleaños` を含むルールは、アクセントまたは発音記号を含んでいるため、*diacrítica* や *#cumpleaños* を含むポストにはマッチします。しかし、これらのルールは、チルダ付きの í やエニェ（ñ）のない *Diacritica* や *#cumpleanos* を含むポストにはマッチしません。

アクセントや発音記号を含む文字は、通常の文字と同様に扱われ、単語の区切りとは見なされません。たとえば、キーワード *cumpleaños* を含むルールは、*cumpleaños* という単語を含むポストにのみマッチし、*cumplea*、*cumplean*、*os* を含むポストにはマッチしません。

すべてのオペレーターは、大文字と小文字を区別せずに評価されます。たとえば、ルール cat は、*cat*、*CAT*、*Cat* のすべてにマッチします。

<Note>
  [Search Posts](/ja/x-api/posts/search/introduction) のマッチング動作は、filtered stream とは異なります。[Search Posts クエリを構築する](/ja/x-api/posts/search/integrate/build-a-query)場合、アクセントや発音記号を含むキーワードやハッシュタグは、アクセントや発音記号付きの表記と、アクセントや発音記号のない表記の両方にマッチすることに注意してください。

  たとえば、キーワード `Diacrítica` またはハッシュタグ `#cumpleaños` を含む Search Posts クエリは、*Diacrítica* や *#cumpleaños* に加えて、チルダ付きの í やエニェ（ñ）のない *Diacritica* や *#cumpleanos* にもマッチします。
</Note>

<div id="specificity-and-efficiency">
  #### 精度と効率性
</div>

ルールの作成を始めるときは、いくつか注意すべき点があります。

* 単一のキーワードや #hashtag のように、広い範囲を対象とするオペレーターだけでルールを構成することは、一般的には推奨されません。そうしたルールは通常、膨大な件数のポストにマッチしてしまう可能性が高いためです。より堅牢なルールを作成することで、より対象を絞り込んだポストにだけマッチさせることができ、ペイロード内のノイズが減り、有用なインサイトを見つけるためにふるいにかける必要のあるデータ量を抑えられることが期待できます。 
  * 例えば、ルールが単にキーワード `happy` だけだった場合、1 日あたりおよそ 200,000〜300,000 件のポストが取得される可能性があります。
  * 追加の条件オペレーターを組み合わせることで検索結果を絞り込むことができます。例えば `(happy OR happiness) place_country:GB -birthday -is:retweet`
* 効率的なルールを書くことは、ルールの文字数制限内に収めるうえでも有益です。文字数には、スペースやオペレーターを含めたルール文字列全体がカウントされます。
  * 例えば、次のルールは 59 文字です: `(happy OR happiness) place_country:GB -birthday -is:retweet`

<div id="quote-tweet-matching-behavior">
  #### 引用ポストのマッチング動作
</div>

filtered stream エンドポイントを使用する場合、オペレーターは引用元のポストの内容と、引用ポスト内に含まれる内容の両方にマッチします。

ただし、[ポストを検索](/ja/x-api/posts/search/introduction) エンドポイントは、引用元のポストの内容にはマッチせず、引用ポストの内容にのみマッチする点に注意してください。

<div id="iteratively-building-a-rule">
  #### ルールを段階的に作成する
</div>

<div id="test-your-rule-early-and-often">
  ##### ルールは早い段階から頻繁にテストする
</div>

最初の試行で「正しい」結果を返すルールを作れることはほとんどありません。X 上には、最初は明らかでないものも含めて非常に多くのコンテンツがあり、上で説明したルール構文を意図した検索条件にうまく合致させるのは難しい場合があります。ルールを作成する際には、そのルールをストリームエンドポイントで定期的にテストし、どのようなデータが返ってくるかを確認することが重要です。使用しているオペレーターがそのエンドポイントでも利用可能であることを前提に、[ポスト検索](/ja/x-api/posts/search/introduction) エンドポイントのいずれかでテストすることもできます。 

このセクションでは、次のルールから開始し、テストで得られた結果に基づいて調整していきます。 

`happy OR happiness`

<div id="use-results-to-narrow-the-rule">
  ##### 結果を使ってルールを絞り込む
</div>

ルールをテストするときは、返ってきたポストを見て、期待しているデータが含まれているかどうかを確認する必要があります。最初は条件を広く設定したルールや、より大きなポスト集合を取得するルールから始めることで、結果をレビューし、望ましくない結果を除外するようにルールを絞り込むことができます。  

例のルールをテストしたところ、さまざまな言語のポストが返ってくることに気付きました。この状況では、英語のポストだけを受信したいので、`lang:` オペレーターを追加します:

`(happy OR happiness) lang:en`

テストでは、「誕生日おめでとう」という内容のポストが多数返ってきたため、否定キーワードオペレーターとして `-birthday` を追加します。また、オリジナルのポストだけを受信したいので、否定の `-is:retweet` オペレーターも追加しました:

`(happy OR happiness) lang:en -birthday -is:retweet`

<div id="adjust-for-inclusion-where-needed">
  ##### 必要に応じて取得対象を調整する
</div>

期待しているデータが返ってこず、実際には返ってくるはずの既存のポストがあると分かっている場合は、目的のデータをフィルタリングで除外してしまっている可能性のあるオペレーターを削除して、ルールを広げる必要があるかもしれません。 

この例では、探している感情を表現している他のポストが自分のタイムラインに存在するにもかかわらず、テスト結果には含まれていないことに気付きました。網羅性を高めるために、キーワード `excited` と `elated` を追加します。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet`

<div id="adjust-for-popular-trendsbursts-over-the-time-period">
  ##### 対象期間中のトレンドや急増（バースト）に合わせて調整する
</div>

X ではトレンドがすぐに移り変わります。ルールの管理は継続的なプロセスであるべきです。1 つのルールをしばらく使い続ける予定であれば、受信しているデータを定期的に確認し、調整が必要かどうかを判断することをおすすめします。

この例では、人々に「happy holidays」と伝えているポストを受信し始めたことに気付きました。これらのポストを結果に含めたくないので、除外用に `-holidays` キーワードを追加します。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet -holidays`

<div id="adding-and-removing-rules">
  #### ルールの追加と削除
</div>

ストリームにルールを追加および削除する場合は、[POST /2/tweets/search/stream/rules](/ja/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) エンドポイントを使用します。

1 つ以上のルールをストリームに追加するには、ルールを含む `value` パラメーターの配列を持つ `add` JSON ボディを送信します。任意で、フリーフォームテキストを含む `tag` パラメーターを指定できます。このテキストは、[どの返されるポストがこのルールにマッチしたかを識別する](/ja/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule) ために使用できます。 

たとえば、ストリームに一連のルールを追加しようとしている場合、cURL コマンドは次のようになります。

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
-H "Content-type: application/json" \
-H "Authorization: Bearer $ACCESS_TOKEN" -d \
'{
  "add": [
    {"value": "cat has:media", "tag": "cats with media"},
    {"value": "cat has:media -grumpy", "tag": "happy cats with media"},
    {"value": "meme", "tag": "funny things"},
    {"value": "meme has:images"}
  ]
}'
```

同様に、ストリームから 1 つ以上のルールを削除するには、削除したいルール ID を含む `id` パラメータの配列を指定した `delete` 用の JSON 本文を送信します。

たとえば、ストリームから一連のルールを削除しようとしている場合、cURL コマンドは次のようになります。

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
  -H "Content-type: application/json" \
  -H "Authorization: Bearer $ACCESS_TOKEN" -d \
  '{
    "delete": {
      "ids": [
        "1165037377523306498",
        "1165037377523306499"
      ]
    }
  }'
```

さまざまなプログラミング言語向けのサンプルコードを、[GitHub](https://github.com/xdevplatform/Twitter-API-v2-sample-code/tree/master/Filtered-Stream) で提供しています。

<div id="rule-examples">
  #### ルール例
</div>

<div id="tracking-a-natural-disaster">
  ##### 自然災害の追跡
</div>

次のルールは、2017 年にヒューストンを襲った Hurricane Harvey について述べている気象機関や観測機器から投稿されたポストにマッチするものです。[matching rules](/ja/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule) タグの使い方と、ルールを [POST /2/tweets/search/stream/rules endpoint](/ja/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) に送信する際に使用する必要がある JSON 形式に注目してください。

```json
{
    "value": "-is:retweet has:geo (from:NWSNHC OR from:NHC_Atlantic OR from:NWSHouston OR from:NWSSanAntonio OR from:USGS_TexasRain OR from:USGS_TexasFlood OR from:JeffLindner1)",
    "tag": "theme:info has:geo original from weather agencies and gauges"
}
```

<div id="reviewing-the-sentiment-of-a-conversation">
  ##### 会話のセンチメントを把握する
</div>

次のルールは、ハッシュタグ *#nowplaying* を中心に展開している会話のセンチメントをより深く理解するために使用できます。このルールは、北米内で公開されたポストのみを対象とします。

```json
{
    "value": "#nowplaying (happy OR exciting OR excited OR favorite OR fav OR amazing OR lovely OR incredible) (place_country:US OR place_country:MX OR place_country:CA) -horrible -worst -sucks -bad -disappointing",
    "tag": "#nowplaying positive"
},
{
    "value": "#nowplaying (horrible OR worst OR sucks OR bad OR disappointing) (place_country:US OR place_country:MX OR place_country:CA) -happy -exciting -excited -favorite -fav -amazing -lovely -incredible",
    "tag": "#nowplaying negative"
}
```

<div id="find-posts-that-relate-to-a-specific-post-annotation">
  ##### 特定のポストアノテーションに関連するポストを検索する
</div>

このルールは、ポストで判定された言語が日本語であり、猫ではないペットの画像を含むオリジナルのポストを検索するために構築されたものです。これを行うために、`context:` オペレーターを使用して [Post annotation](/ja/x-api/fundamentals/post-annotations) 機能を活用しました。まず、[Post lookup](/ja/x-api/posts/lookup/introduction) エンドポイントと `tweet.fields=context_annotations` フィールドパラメータを使用して、クエリで使用する必要がある domain.entity ID を特定しました。

* 猫に関連するポストは、`domain` 66（Interests and Hobbies カテゴリ）と `entity` 852262932607926273（Cats）を返します。 
* ペットに関連するポストは、`domain` 65（Interests and Hobbies Vertical）と `entity` 852262932607926273（Pets）を返します。 
   

ルールは次のようになります。

```json
{
    "value": "context:65.852262932607926273 -context:66.852262932607926273 -is:retweet has:images lang:ja",
    "tag": "Japanese pets with images - no cats"
}
```
