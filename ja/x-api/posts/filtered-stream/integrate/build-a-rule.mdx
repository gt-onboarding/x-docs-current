---
title: ルールを作成する
sidebarTitle: ルールを作成する
keywords: ["ルールを作成する", "フィルタールール", "ストリームルール", "ルールビルダー", "filtered stream のルール", "ルールを新規作成", "ルールガイド"]
---

<div id="building-rules-for-filtered-stream">
  ## filtered stream のルールを作成する
</div>

filtered stream エンドポイントは、ストリームに適用される一連のルールに基づいてフィルタリングされたポストを配信します。ルールは、さまざまなポスト属性にマッチさせるために使用されるオペレーターで構成されます。

複数のルールを、[POST /tweets/search/stream/rules](/ja/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) エンドポイントを使用して 1 つのストリームに適用できます。ルールを追加し、[GET /tweets/search/stream](/ja/x-api/posts/filtered-stream#get-2-tweets-search-stream) エンドポイントを使用してストリームに接続すると、設定したルールに一致するポストだけが、永続的なストリーミング接続を通じて配信されます。ルールを追加または削除するために、ストリームから切断する必要はありません。 

<div id="table-of-contents">
  ### 目次
</div>

* [ルールの作成](#building-a-rule)
  * [ルールの制限事項](#rule-limitations)
  * [演算子の利用可能性](#operator-availability)
  * [演算子の種類: 単独使用と論理結合が必須のもの](#operator-types-standalone-and-conjunction-required)
  * [ブール演算子とグループ化](#boolean-operators-and-grouping)
  * [演算の順序](#order-of-operations)
  * [句読点・ダイアクリティカルマーク・大文字小文字の区別](#punctuation-diacritics-and-case-sensitivity)
  * [絞り込み度と効率性](#specificity-and-efficiency)
  * [ルールを段階的に作成する](#iteratively-building-a-rule)
  * [ルールの追加と削除](#adding-and-removing-rules)
  * [ルールの例](#rule-examples)

<div id="building-a-rule">
  ### ルールを作成する
</div>

<div id="rule-limitations">
  #### ルールの制限事項
</div>

ルール数の上限は、[プロジェクト](/ja/resources/fundamentals/projects)に設定されている[アクセスレベル](/ja/x-api/getting-started/about-x-api)によって異なります。

これらの上限がどのように適用されるかは、[filtered stream の概要](/ja/x-api/posts/filtered-stream)ページで確認できます。

<div id="operator-types-standalone-and-conjunction-required">
  #### 演算子の種類：スタンドアロンと結合必須
</div>

**スタンドアロン演算子** は、それ単体でも、（結合が必要なものを含む）他の任意の演算子と組み合わせても使用できます。

たとえば、次のルールはスタンドアロンである `#hashtag` 演算子を使用しているため、有効です。

`#xapiv2`

**結合必須** 演算子は、ルール内でそれ単体では使用できません。少なくとも 1 つのスタンドアロン演算子と組み合わせて使用する必要があります。これは、これらの演算子だけを使用すると条件が広すぎて、極めて大量のポストにマッチしてしまうためです。

たとえば、次のルールは結合必須演算子のみを含んでいるため、使用できません。

`has:media`

`has:links OR is:retweet`

スタンドアロン演算子（たとえば `"X data"` というフレーズ）を追加すれば、そのルールは有効になります。 

`"X data" has:mentions (has:media OR has:links)`

<div id="boolean-operators-and-grouping">
  #### ブール演算子とグルーピング
</div>

1つのルール内で複数の演算子を組み合わせたい場合、次のような方法を利用できます。

|     |     |
| :--- | :--- |
| **AND ロジック** | **演算子同士の間にスペースを入れて連続させる**と、ブール演算の「AND」ロジックになります。これは、両方の条件を満たした場合にのみポストが一致することを意味します。例えば、`snow day #NoSchool` は、snow と day という語句と、ハッシュタグ #NoSchool を含むポストに一致します。 |
| **OR ロジック** | 演算子同士の間に OR を入れて連続させると OR ロジックになり、いずれか一方の条件が満たされればポストが一致します。例えば、`grumpy OR cat OR #meme` と指定すると、少なくとも grumpy または cat という語句、もしくはハッシュタグ #meme のいずれかを含むポストに一致します。 |
| **NOT ロジック、否定** | キーワード（または任意の演算子）の前にダッシュ (-) を付けることで、それを否定（NOT）できます。例えば、`cat #meme -grumpy` は、ハッシュタグ #meme と語句 cat を含むポストのうち、grumpy という語句を含まないものに一致します。よく使われるルール句の 1 つに `-is:retweet` があり、これはリツイートには一致せず、元のポスト、引用ポスト（Quote Tweets）、返信のみに一致します。すべての演算子は否定可能ですが、否定された演算子だけを単独で使うことはできません。 |
| **グルーピング** | 括弧を使用して演算子をグループ化できます。例えば、`(grumpy cat) OR (#meme has:images)` は、grumpy と cat という語句を含むポスト、または画像とハッシュタグ #meme を含むポストのいずれかを返します。AND が先に適用され、その後に OR が適用されることに注意してください。 |

<Note>
  **否定についての注意事項**

  `sample:` を除き、すべての演算子は否定できます。また、`-is:nullcast` は常にこの否定された形で使用しなければなりません。否定された演算子を単独で使うことはできません。

  括弧でひとまとめにした演算子群全体を否定しないでください。代わりに、各演算子を個別に否定してください。

  例えば、`skiing -(snow OR day OR noschool)` を使用する代わりに、`skiing -snow -day -noschool` を使用することをお勧めします。 
</Note>

<div id="order-of-operations">
  #### 演算の順序
</div>

AND と OR のロジックを組み合わせる場合、次の演算の順序によってルールの評価方法が決まります。

1. AND ロジックで接続された演算子が最初にまとめて評価される
2. 次に、OR ロジックで接続された演算子が適用される

例:

* `apple OR iphone ipad` は `apple OR (iphone ipad)` として評価されます
* `ipad iphone OR android` は `(iphone ipad) OR android` として評価されます

あいまいさをなくし、ルールが意図したとおりに評価されるようにするには、必要に応じてかっこを使って語句をグループ化してください。 

例:

* `(apple OR iphone) ipad`
* `iphone (ipad OR android)`

<div id="punctuation-diacritics-and-case-sensitivity">
  #### 句読点、ダイアクリティカルマーク、大文字と小文字の区別
</div>

アクセントやダイアクリティカルマークを含むキーワードまたはハッシュタグのルールを指定した場合、そのアクセントやダイアクリティカルマークを正しく含む単語が含まれるポストには一致しますが、同じ文字列でもアクセントやダイアクリティカルマークが付いていないポストには一致しません。

たとえば、キーワード `diacrítica` やハッシュタグ `#cumpleaños` を含むルールは、アクセントやダイアクリティカルマークを含んでいるため、*diacrítica* や *#cumpleaños* を含むポストには一致します。一方で、チルダ付きの í や eñe がない *Diacritica* や *#cumpleanos* を含むポストには一致しません。

アクセントやダイアクリティカルマーク付きの文字は、通常の文字と同じように扱われ、単語境界としては扱われません。たとえば、キーワード *cumpleaños* を含むルールは、単語 *cumpleaños* を含むポストにのみ一致し、*cumplea*、*cumplean*、*os* を含むポストには一致しません。

すべてのオペレーターは大文字と小文字を区別せずに評価されます。たとえば、ルール cat は、*cat*、*CAT*、*Cat* のすべてに一致します。

<Note>
  [Search Posts](/ja/x-api/posts/search/introduction) のマッチング動作は filtered stream とは異なります。[Search Posts クエリを作成する](/ja/x-api/posts/search/integrate/build-a-query) 場合、アクセントやダイアクリティカルマークを含むキーワードやハッシュタグは、アクセントやダイアクリティカルマーク付きの語と、アクセント等のない通常の文字のみの語の両方に一致することに注意してください。

  たとえば、キーワード `Diacrítica` やハッシュタグ `#cumpleaños` を含む Search Posts クエリは、*Diacrítica* や *#cumpleaños* に加えて、チルダ付きの í や eñe がない *Diacritica* や *#cumpleanos* にも一致します。
</Note>

<div id="specificity-and-efficiency">
  #### 具体性と効率性
</div>

ルールの作成を始める際には、いくつか意識しておくべき点があります。

* 単一のキーワードや #hashtag のような、広く汎用的なオペレーターだけをルールに使用することは、一般的には推奨されません。非常に大量のポストにマッチしてしまう可能性が高いためです。より堅牢なルールを作成することで、より的確なポストの集合にマッチさせることができ、ペイロード内のノイズを減らし、有益な洞察を得るために精査しなければならない量を減らせることが期待できます。 
  * たとえば、ルールがキーワード `happy` だけだった場合、1 日あたりおよそ 200,000〜300,000 ポストを取得する可能性があります。
  * さらに条件付きオペレーターを追加すると検索結果が絞り込まれます。例: `(happy OR happiness) place_country:GB -birthday -is:retweet`
* 効率的なルールを書くことは、ルールの文字数制限内に収めるうえでも有益です。文字数には、スペースやオペレーターを含むルール文字列全体がカウントされます。
  * たとえば、次のルールは 59 文字です: `(happy OR happiness) place_country:GB -birthday -is:retweet`

<div id="quote-tweet-matching-behavior">
  #### 引用ポストのマッチング動作
</div>

filtered stream エンドポイントを使用する場合、オペレーターは、引用元のポストのコンテンツと、引用ポストに含まれるコンテンツの両方にマッチします。

ただし、[Search Posts](/ja/x-api/posts/search/introduction) エンドポイントは、引用元のポストのコンテンツにはマッチせず、引用ポストのコンテンツにのみマッチします。

<div id="iteratively-building-a-rule">
  #### ルールを段階的に作成する
</div>

<div id="test-your-rule-early-and-often">
  ##### ルールは早い段階から、頻繁にテストする
</div>

一度の試行で「正しい」結果を返すルールを作成できることはほとんどありません。X 上には、最初は明らかでないことも多く、前述のルール構文も、目的の検索条件にうまく合致させるのが難しい場合があります。ルールを作成する際は、ストリームエンドポイントを使って、どのようなデータが返ってくるかを定期的にテストすることが重要です。使用しているオペレーターがそのエンドポイントでも利用可能であれば、[Search Post](/ja/x-api/posts/search/introduction) エンドポイントのいずれかでテストすることもできます。 

このセクションでは、次のルールから始め、テストで得られた結果に基づいて調整していきます。 

`happy OR happiness`

<div id="use-results-to-narrow-the-rule">
  ##### 結果を使ってルールを絞り込む
</div>

ルールをテストするときは、返されるポストを確認し、期待しているデータ、取得したいデータが含まれているかどうかを確認する必要があります。まずは条件を広めにとり、多くのポストがマッチするルールから始めることで、結果を見ながら不要な結果を除外するようにルールを絞り込むことができます。  

サンプルルールをテストしたところ、さまざまな言語のポストが取得されることに気づきました。この場合は、英語のポストだけを受け取りたいので、`lang:` オペレーターを追加します。

`(happy OR happiness) lang:en`

テストでは、「誕生日おめでとう」といった内容のポストが多く返ってきたため、否定キーワードオペレーターとして `-birthday` を追加します。また、オリジナルポストだけを受け取りたいので、否定オペレーターの `-is:retweet` も追加します。

`(happy OR happiness) lang:en -birthday -is:retweet`

<div id="adjust-for-inclusion-where-needed">
  ##### 必要に応じて対象範囲を調整する
</div>

期待しているデータが受信できておらず、実際には API から返されるはずの既存のポストがあると分かっている場合は、目的のデータを除外している可能性のあるオペレーターを削除して、ルールの対象範囲を広げる必要があるかもしれません。 

この例では、自分のタイムライン上に、求めている感情を表しているにもかかわらずテスト結果に含まれていない他のポストがあることに気付きました。より広くカバーできるようにするため、キーワード `excited` と `elated` を追加します。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet`

<div id="adjust-for-popular-trendsbursts-over-the-time-period">
  ##### 対象期間中の人気トレンドや急増に合わせて調整する
</div>

X ではトレンドがすぐに移り変わります。ルールは積極的にメンテナンスする必要があります。単一のルールをしばらく使う予定がある場合は、受信しているデータを定期的に確認し、調整が必要かどうかを見直すことをおすすめします。

この例では、人々に「happy holidays」とあいさつしているポストが混ざり始めていることに気付きます。これらのポストは結果に含めたくないため、否定の `-holidays` キーワードを追加します。

`(happy OR happiness OR excited OR elated) lang:en -birthday -is:retweet -holidays`

<div id="adding-and-removing-rules">
  #### ルールの追加と削除
</div>

ストリームにルールを追加および削除する際には、[POST /2/tweets/search/stream/rules](/ja/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) エンドポイントを使用します。

ストリームに 1 つ以上のルールを追加するには、`add` JSON ボディを送信します。この中の配列にルールを含む value パラメータを指定し、必要に応じて `tag` パラメータに任意のテキストを指定できます。`tag` は、[どの返されるポストがこのルールに一致したかを識別する](/ja/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule) ために使用できます。

たとえば、ストリームに一連のルールを追加する場合、cURL コマンドは次のようになります。

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
-H "Content-type: application/json" \
-H "Authorization: Bearer $ACCESS_TOKEN" -d \
'{
  "add": [
    {"value": "cat has:media", "tag": "cats with media"},
    {"value": "cat has:media -grumpy", "tag": "happy cats with media"},
    {"value": "meme", "tag": "funny things"},
    {"value": "meme has:images"}
  ]
}'
```

同様に、ストリームから 1 つ以上のルールを削除するには、削除したいルールの ID を `id` パラメータで配列として指定した `delete` JSON ボディを送信します。

たとえば、ストリームから複数のルールを削除しようとする場合、cURL コマンドは次のようになります。

```bash
curl -X POST 'https://api.x.com/2/tweets/search/stream/rules' \
  -H "Content-type: application/json" \
  -H "Authorization: Bearer $ACCESS_TOKEN" -d \
  '{
    "delete": {
      "ids": [
        "1165037377523306498",
        "1165037377523306499"
      ]
    }
  }'
```

さまざまなプログラミング言語向けのサンプルコードを [GitHub](https://github.com/xdevplatform/Twitter-API-v2-sample-code/tree/master/Filtered-Stream) で公開しています。

<div id="rule-examples">
  #### ルール例
</div>

<div id="tracking-a-natural-disaster">
  ##### 自然災害の追跡
</div>

次のルールは、2017 年にヒューストンを襲った Hurricane Harvey について述べている気象機関や観測機関からのポストにマッチします。[matching rules](/ja/x-api/posts/filtered-stream#matching-returned-posts-to-their-associated-rule) タグの使い方と、ルールを [POST /2/tweets/search/stream/rules エンドポイント](/ja/x-api/posts/filtered-stream#post-2-tweets-search-stream-rules) に送信する際に使用する必要がある JSON 形式に注目してください。

```json
{
    "value": "-is:retweet has:geo (from:NWSNHC OR from:NHC_Atlantic OR from:NWSHouston OR from:NWSSanAntonio OR from:USGS_TexasRain OR from:USGS_TexasFlood OR from:JeffLindner1)",
    "tag": "theme:info has:geo original from weather agencies and gauges"
}
```

<div id="reviewing-the-sentiment-of-a-conversation">
  ##### 会話のセンチメントを分析する
</div>

次のルールは、ハッシュタグ *#nowplaying* を中心に展開している会話のセンチメントを、北米で公開されたポストに限定してより深く理解するために使用できます。

```json
{
    "value": "#nowplaying (happy OR exciting OR excited OR favorite OR fav OR amazing OR lovely OR incredible) (place_country:US OR place_country:MX OR place_country:CA) -horrible -worst -sucks -bad -disappointing",
    "tag": "#nowplaying positive"
},
{
    "value": "#nowplaying (horrible OR worst OR sucks OR bad OR disappointing) (place_country:US OR place_country:MX OR place_country:CA) -happy -exciting -excited -favorite -fav -amazing -lovely -incredible",
    "tag": "#nowplaying negative"
}
```

<div id="find-posts-that-relate-to-a-specific-post-annotation">
  ##### 特定のポスト注釈に関連するポストを見つける
</div>

このルールは、ポスト内で識別された言語が日本語であり、猫ではないペットの画像を含むオリジナルのポストを検索するために作成したものです。これを行うために、`context:` オペレーターを使用して [Post annotation](/ja/x-api/fundamentals/post-annotations) 機能を活用しました。まず [Post lookup](/ja/x-api/posts/lookup/introduction) エンドポイントと `tweet.fields=context_annotations` フィールドパラメータを使用して、クエリで使用する必要がある domain.entity の ID を特定しました。

* 猫に関連するポストは、`domain` 66（Interests and Hobbies カテゴリ）と `entity` 852262932607926273（Cats）を返します。 
* ペットに関連するポストは、`domain` 65（Interests and Hobbies Vertical）と `entity` 852262932607926273（Pets）を返します。 
   

このルールは次のようになります。

```json
{
    "value": "context:65.852262932607926273 -context:66.852262932607926273 -is:retweet has:images lang:ja",
    "tag": "Japanese pets with images - no cats"
}
```
