---
title: 切断の処理
sidebarTitle: 切断の処理
keywords: ["powerstream disconnections", "handle disconnections", "reconnect powerstream", "stream disconnections", "powerstream errors"]
---

<div id="what-is-a-disconnection">
  ## 切断とは何ですか？
</div>

Streaming API への接続を確立するということは、非常に長時間維持される HTTPS リクエストを発行し、そのレスポンスを逐次的にパースすることを意味します。powerstream エンドポイントに接続する際には、HTTPS リクエストを送信し、可能な限り長くその結果のストリームを受信し続ける必要があります。サーバー側のエラー、クライアント側での過度な遅延、ネットワークの問題、定期的なサーバーメンテナンス、重複ログインが発生しない限り、当社サーバーは接続を無期限に維持します。Streaming エンドポイントへの接続では、切断が発生する可能性が高く、また発生することを前提とすべきであり、そのための再接続ロジックを実装しておく必要があります。

<div id="why-a-streaming-connection-might-be-disconnected">
  ## ストリーミング接続が切断される可能性がある理由
</div>

ストリームは、さまざまな理由で切断される可能性があります。障害の原因を把握するには、ストリームから返されるエラーメッセージを確認してください。切断される主な理由としては次のようなものがあります。

* 誤ったトークンや誤った認証方法の使用などによる認証エラー。
* X 側でストリーミングサーバーが再起動された場合。これは通常、コードのデプロイに関連しており、発生するものとしてあらかじめ想定し、その前提で設計しておく必要があります。
* クライアントがストリームから配信されるポストの量についていけない場合、またはデータの読み取りが遅すぎる場合。すべてのストリーミング接続には、クライアントに送信されるメッセージのキューがあります。このキューが時間の経過とともに大きくなりすぎると、接続は閉じられます。
* アカウントが 1 日または 1 か月あたりのポスト数のクォータを超過した場合。
* 冗長なアクティブ接続が多すぎる場合。
* クライアントが突然データの読み取りを停止した場合。ストリームから読み取られるポストの速度が急激に低下すると、接続は閉じられます。
* サーバーとクライアント間のネットワークに問題が発生している場合。
* 一時的なサーバー側の問題、計画メンテナンスやアップデートが行われている場合（[ステータスページ](/ja/status) を確認してください）。

<div id="anticipating-disconnects-and-reconnecting">
  ## 切断を見越した対策と再接続
</div>

ポストのストリーミング時は、切断が発生しうることを認識しつつ、できるだけ長く接続を維持することが目標です。エンドポイントは 20 秒ごとにキープアライブ用のハートビート（改行文字として現れます）を送信します。このシグナルを使って、切断されていないかどうかを検出してください。

1. 新しいポストとハートビートの両方が届かなくなったことを、コードで検出できるようにします。
2. その場合、コードは再接続ロジックを実行する必要があります。一部のクライアントや言語では read timeout を指定できるため、これを 20 秒に設定できます。
3. サービスはこれらの切断を検知し、可能な限り速やかに再接続する必要があります。

確立された接続が切れたら、すぐに再接続を試行してください。再接続に失敗した場合は、発生したエラーの種類に応じて、再接続の試行間隔を伸ばしてください。

* TCP/IP レベルのネットワークエラーの場合は線形バックオフを行います。これらの問題は一般的に一時的なもので、すぐに解消される傾向があります。再接続の待機時間を試行ごとに 250ms ずつ増やし、最大 16 秒までとします。
* 再接続が適切な HTTP エラーの場合は指数バックオフを行います。5 秒の待機から開始し、試行ごとに待機時間を 2 倍にし、最大 320 秒までとします。
* HTTP 429 エラー（レート制限超過）の場合も指数バックオフを行います。1 分の待機から開始し、試行ごとに待機時間を 2 倍にします。HTTP 429 を受信するたびに、アカウントに対するレート制限が解除されるまで待機しなければならない時間が増加する点に注意してください。
   

<div id="recovering-lost-data">
  ## 失われたデータの復旧
</div>

切断が発生した場合でも、取り逃した可能性のあるすべてのデータを確実に受信するために利用できる、いくつかの方法があります。取り逃したデータを復旧するために実行できる主な手順については、[データの復旧](/ja/x-api/powerstream/recovery-and-redundancy) に関する統合ガイドで説明しています。 
 

<div id="rate-limits-and-usage">
  ## レート制限と使用状況
</div>

接続に関するレート制限を確認するには、レスポンスに 3 つのヘッダーが含まれます。これは、ルール用エンドポイントを何回使用できるか、およびストリーミングエンドポイントに対して何回再接続試行が許可されているかを把握するのに役立ちます。

* x-rate-limit-limit は、15 分間の時間枠内でクライアントが実行できる割り当て済みリクエスト数を示します。

* x-rate-limit-remaining は、15 分間の時間枠内であと何回リクエストを実行できるか（残りのリクエスト数）を示します。

* x-rate-limit-reset は、15 分間の時間枠がいつ再開し、そのタイミングで x-rate-limit-remaining が 0 にリセットされるかを示す UNIX タイムスタンプです。

filter stream エンドポイントは現在、使用状況データを報告しません。配信されたポスト数を確認するには、コード側でメータリングロジックを実装し、必要に応じて消費量を計測して一時停止できるようにします。 

ストリームのクライアント側を担当するコードでは、受信したポストを単純に先入れ先出し (FIFO) キュー、または同様のメモリ構造に挿入します。別のプロセス／スレッドがそのキューからポストを取り出し、解析してストレージ用にコンテンツを準備する必要があります。この設計により、受信するポストの量が大きく変動した場合でも効率的にスケールできるサービスを実装できます。概念的には、HTTP 経由で無限に長いファイルをダウンロードしているようなイメージです。

<div id="reconnection-best-practices">
  ## 再接続に関するベストプラクティス
</div>

<div id="test-backoff-strategies">
  ### バックオフ戦略をテストする
</div>

バックオフ実装をテストする良い方法は、無効な認証情報を使用し、再接続試行を確認することです。適切な実装であれば、429 レスポンスが返されることはありません。

<div id="issue-alerts-for-multiple-reconnects">
  ### 再接続が複数回発生した場合のアラート
</div>

クライアントが再接続間隔の上限しきい値に達した場合は、接続に影響している問題を切り分けられるよう、通知を送信するようにしてください。

<div id="handle-dns-changes">
  ### DNS の変更への対応
</div>

クライアントプロセスが DNS の TTL (Time To Live) を正しく順守しているかテストしてください。一部のスタックでは、解決済みアドレスをプロセスの稼働中ずっとキャッシュしてしまい、指定された TTL 内の DNS 変更を反映しない場合があります。このような過度なキャッシュは、X が IP アドレス間で負荷を切り替える際に、クライアント側でサービス中断を引き起こす原因となります。

<div id="user-agent">
  ### User Agent
</div>

user-agent HTTP ヘッダーに、利用しているクライアントのバージョン情報を必ず含めてください。これは X 側で問題を診断するうえで重要です。環境の制約などで user-agent フィールドを設定できない場合は、代わりに x-user-agent ヘッダーを設定してください。