---
title: 切断時の処理
sidebarTitle: 切断時の処理
keywords: ["powerstream disconnections", "handle disconnections", "reconnect powerstream", "stream disconnections", "powerstream errors"]
---

<div id="what-is-a-disconnection">
  ## 切断とは何ですか？
</div>

ストリーミング API への接続を確立するとは、非常に長時間維持される HTTPS リクエストを発行し、そのレスポンスを逐次的に解析していくことを意味します。`powerstream` エンドポイントに接続する場合は、HTTPS リクエストを送信し、可能な限り長時間その結果として返されるストリームを受信し続ける必要があります。サーバー側のエラー、クライアント側の過度な遅延、ネットワークの問題、定期的なサーバーメンテナンス、または重複ログインが発生しない限り、当社のサーバーは接続を無期限に維持します。ストリーミングエンドポイントへの接続では、切断が発生する可能性が高く、その発生を前提としておく必要があり、切断に備えた再接続ロジックを実装しておく必要があります。

<div id="why-a-streaming-connection-might-be-disconnected">
  ## ストリーミング接続が切断される可能性がある理由
</div>

ストリームが切断される理由はいくつか考えられます。原因を把握するために、ストリームから返されるエラーメッセージを確認してください。切断される主な理由は次のとおりです。

* 認証エラー（誤ったトークンや誤った認証方法が使用されている場合など）。
* X 側でストリーミングサーバーが再起動された場合。これは通常、コードのデプロイに関連しており、一般的に発生しうる事象として想定し、それを前提に設計する必要があります。
* クライアントがストリームから配信されるポストの量に追いつけない、またはデータの読み取りが遅すぎる場合。すべてのストリーミング接続には、クライアントに送信されるメッセージのキューがあります。このキューが時間の経過とともに大きくなりすぎると、接続は閉じられます。
* アカウントが 1 日または 1 か月あたりのポスト数のクォータ（上限）を超過した場合。
* 冗長なアクティブ接続が多すぎる場合。
* クライアントが突然データの読み取りを停止した場合。ストリームから読み取られるポストのレートが急激に低下すると、接続は閉じられます。
* サーバーとクライアント間のネットワーク上の問題が発生している場合。
* 一時的なサーバー側の問題や、計画されたメンテナンスやアップデート。（[ステータスページ](/ja/status)を確認してください）

<div id="anticipating-disconnects-and-reconnecting">
  ## 切断を想定した設計と再接続
</div>

ポストをストリーミングする場合、切断が発生し得ることを認識しつつ、可能な限り長く接続を維持することが目標です。エンドポイントは 20 秒ごとにキープアライブのハートビート（改行文字として現れます）を送信します。この信号を利用して、切断されたかどうかを検出してください。

1. 新しいコンテンツとハートビートが届かなくなったことを、コードで検出できるようにします。
2. そのような状況になった場合、コードは再接続ロジックをトリガーする必要があります。一部のクライアントや言語では read timeout を指定できるため、これを 20 秒に設定できます。
3. サービスはこれらの切断を検出し、可能な限り早く再接続する必要があります。

確立済みの接続が切れたら、すぐに再接続を試みます。再接続に失敗した場合は、発生したエラーの種類に応じて、再接続の試行間隔を徐々に延ばしてください。

* TCP/IP レベルのネットワークエラーに対しては、線形にバックオフします。これらの問題は一般的に一時的で、すぐに解消される傾向があります。再接続の待ち時間を試行ごとに 250ms ずつ増やし、最大で 16 秒までとします。
* 再接続しても問題ない HTTP エラーに対しては、指数的にバックオフします。最初は 5 秒待機し、試行のたびに待ち時間を 2 倍にし、最大で 320 秒までとします。
* HTTP 429 エラー（レート制限超過）に対しては、指数的にバックオフします。最初は 1 分待機し、試行のたびに待ち時間を 2 倍にします。HTTP 429 を受信するたびに、アカウントに対するレート制限が解除されるまで待たなければならない時間が増加することに注意してください。
   

<div id="recovering-lost-data">
  ## 失われたデータの復旧
</div>

切断が発生した場合でも、取り逃した可能性のあるすべてのデータを確実に受信できるようにするための、いくつかの戦略があります。取り逃したデータを復旧するために実行できる主な手順については、[データの復旧](/ja/x-api/powerstream/recovery-and-redundancy)に関するインテグレーションガイドで説明しています。 
 

<div id="rate-limits-and-usage">
  ## レート制限と使用状況
</div>

接続に関する制限を確認するには、レスポンスで 3 つのヘッダーが返されます。これは、ルールエンドポイントを何回使用できるか、またストリーミングエンドポイントに対して何回再接続が許可されているかを把握するのに役立ちます。

* x-rate-limit-limit は、15 分間のウィンドウ内でクライアントが実行できる割り当て済みリクエスト数を示します。

* x-rate-limit-remaining は、15 分間のウィンドウ内で残っているリクエスト数を示します。

* x-rate-limit-reset は、15 分間のウィンドウが再開し、x-rate-limit-remaining が 0 にリセットされる時刻を示す UNIX タイムスタンプです。

filter stream エンドポイントは現在、使用状況データを報告しません。何件のポストが配信されたかを確認するには、アプリケーション側のコードでメータリングロジックを実装し、必要に応じて消費量を計測および一時停止できるようにします。 

ストリームのクライアント側をホストするコードは、受信したポストを単純に先入れ先出し (FIFO) キュー、または同様のメモリ構造に挿入します。別のプロセスやスレッドが、そのキューからポストを取り出して解析し、保存用にコンテンツを準備する必要があります。この設計により、受信するポスト量が劇的に変化した場合でも、効率的にスケールできるサービスを実装できます。概念的には、HTTP 経由で無限に長いファイルをダウンロードしていると考えることができます。

<div id="reconnection-best-practices">
  ## 再接続に関するベストプラクティス
</div>

<div id="test-backoff-strategies">
  ### バックオフ戦略をテストする
</div>

バックオフ処理の実装をテストするよい方法は、無効な認可用の認証情報を使用し、再接続の試行を確認することです。適切に実装されていれば、HTTP 429 応答を受け取ることはありません。

<div id="issue-alerts-for-multiple-reconnects">
  ### 複数回の再接続に関する問題アラート
</div>

クライアントが再接続間隔の上限値に達した場合は、接続に影響している問題を切り分けて対処できるように、通知を送信する必要があります。

<div id="handle-dns-changes">
  ### DNS の変更を処理する
</div>

利用しているクライアントプロセスが DNS の Time To Live (TTL) に従っているかテストしてください。一部のスタックでは、解決済みアドレスをプロセスの存続期間中キャッシュしてしまい、設定された TTL の範囲内で行われた DNS の変更を反映できない場合があります。このような過度なキャッシュは、X が IP アドレス間で負荷を切り替える際に、クライアント側でサービス中断を引き起こす原因となります。

<div id="user-agent">
  ### User Agent
</div>

`user-agent` HTTP ヘッダーには、使用しているクライアントのバージョン情報を必ず含めてください。これは X 側で問題を診断する際に極めて重要です。環境の制約により `user-agent` ヘッダーを設定できない場合は、代わりに `x-user-agent` ヘッダーを設定してください。