---
title: リカバリーと冗長性
sidebarTitle: リカバリーと冗長性
keywords: ["powerstream recovery", "powerstream redundancy", "recovery features", "redundancy features", "fault tolerance", "error recovery"]
---

ストリーミングデータを利用する際には、接続をできるだけ長く維持し、一致したすべてのデータを受信することが基本的な目標となります。つまり、冗長構成の接続を用意し、自動的に切断を検知してすばやく再接続し、失われたデータを復旧するための計画を立てておくことが重要です。

このインテグレーションガイドでは、冗長接続、バックフィル、リカバリーといった、さまざまなリカバリーおよび冗長性の機能について説明します。
 

<div id="redundant-connections">
  ## 冗長接続
</div>

冗長接続を使用すると、ストリームに対して複数の同時接続を確立できます。これにより、同じストリームに2つの別々のコンシューマーから接続し、両方の接続で同じデータを受信することで冗長性が確保されます。このようにして、1つのストリームが切断された場合やアプリケーションのプライマリサーバーが障害を起こした場合など、さまざまな状況においても、アプリはホットフェイルオーバーを行えるようになります。

冗長ストリームを使用するには、プライマリ接続で使用しているものと同じURLに接続するだけです。ストリームのデータは両方の接続を通じて送信されます。

<div id="backfill">
  ## バックフィル
</div>

切断を検知した後は、システムがストリームへ自動的に再接続できるようになっている必要があります。可能であれば、どのくらいの時間切断されていたかを記録し、その時間に応じて適切なリカバリ機能を利用してデータをバックフィルできるようにしてください。 

切断時間が5分以下であったと判別できる場合は、バックフィル用パラメータ `backfillMinutes` を使用できます。 このパラメータを `GET /powerstream` リクエストに付与すると、直近1～5分の間にルールにマッチしたポストを受け取ることができます。通常、これらの過去のポストは、新たにマッチしたポストよりも先に配信され、またポストの重複排除は行われません。つまり、90秒間切断されていたにもかかわらず、2分分のバックフィルデータをリクエストした場合、30秒分の重複したポストを受け取ることになりますが、システム側でこれを許容できるようにしておく必要があります。以下は、バックフィルパラメータを含むリクエスト例です。

`curl 'https://api.x.com/2/powerstream?backfillMinutes=5' -H "Authorization: Bearer $ACCESS_TOKEN"`

切断時間が5分を超えていたと判別できる場合は、[recent search エンドポイント](/ja/x-api/posts/search/introduction) またはリカバリ機能を利用して、欠損したデータをリクエストできます。 

<div id="recovery">
  ## リカバリー
</div>

5 分間のバックフィルウィンドウ内に再接続できない場合は、Recovery 機能を使用して、直近 24 時間以内に取り逃したデータを復旧できます。

ストリーミングのリカバリー機能により、バックフィルウィンドウを 24 時間まで延長できます。Recovery を使用すると、取り逃したデータの期間をリプレイできます。`startTime` と `endTime` リクエストパラメータを使用して接続リクエストを行うと、リカバリーストリームが開始されます。接続されると、Recovery は指定された期間のデータを再ストリーミングし、その後切断します。  

|     |     |     |
| :--- | :--- | :--- |
| **Name** | **Type** | **Description** |
| `startTime` | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />復旧を開始する時刻を示す UTC の日時。 |
| `endTime` | date (ISO 8601) | YYYY-MM-DDTHH:mm:ssZ (ISO 8601/RFC 3339)。<br /><br />復旧を終了する時刻を示す UTC の日時。 |

リクエスト URL の例: `https://api.x.com/2/powerstream?startTime=2022-07-12T15:10:00Z&endTime=2022-07-12T15:20:00Z`