---
title: "データエンリッチメント: Enterprise"
keywords: ["データエンリッチメント", "Enterprise エンリッチメント", "GNIP エンリッチメント", "データエンリッチメント", "エンリッチ済みデータ", "Enterprise データエンリッチメント"]
---

## はじめに

`Enterprise`

Enterprise のエンリッチメントは、一部のデータ API のレスポンス ペイロードに追加されるメタデータです。有料サブスクリプションプランでのみ利用できます。

以下の表では、各エンリッチメントの概要を説明します。

| Enrichment: | 説明: |
| :--- | :--- |
| Expanded and Enhanced URLs | ポスト本文に含まれる短縮 URL（例: bitly）を自動的に展開し、遷移先ページの HTML タイトルおよび説明のメタデータを提供します。 |
| Matching rules object | 受信したポストに、どのルール（複数可）がマッチしたかを示します。このオブジェクトは、レスポンス内で rule tag と rule ID を返します。 |
| Poll metadata | ポスト内に投票が存在することを示し、投票の選択肢の一覧に加えて、投票の継続時間と有効期限の両方を含みます。 |
| Profile geo | 可能な場合に [経度, 緯度] 座標と関連する場所メタデータを含む、ユーザープロフィールの位置情報データを推定して提供します。 |

<div id="expanded-and-enhanced-urls">
  ### 展開および拡張された URL
</div>

Expanded and Enhanced URL エンリッチメントは、ポスト本文に含まれている短縮 URL を自動的に展開し、その結果得られた URL をペイロード内のメタデータとして含めます。さらに、このエンリッチメントは、遷移先ページの `title` および `description` から取得した HTML ページのメタデータも提供します。

**重要な詳細:**

* 短縮リンクを展開するために、システムは指定された URL に対して HTTP HEAD リクエストを送信し、最終的な URL に到達するまでリダイレクトをたどります。この最終的な URL（ページコンテンツそのものではありません）がレスポンスペイロードに含まれます。

* URL エンリッチメントにより、リアルタイムストリームには 5〜10 秒程度のレイテンシーが追加されます。

* Full Archive Search API へのリクエストでは、展開された URL エンリッチメントデータは、過去 13 か月以内のポストに対してのみ利用可能です。

* URL エンリッチメントは、ポスト内に含まれるポストへのリンク（引用ポストを含む）、Moments へのリンク、およびプロフィールへのリンクには利用できません。 
   

#### ポストペイロード

Expanded and Enhanced URL エンリッチメントは、ポストペイロードの `entities` オブジェクト内、特に `entitites.urls.unwound` オブジェクトに含まれます。ここには次のメタデータフィールドが含まれます：

* 展開済み URL - `unwound.url`
* 展開済み HTTP ステータス - `unwound.status`
* 展開済み URL の HTML タイトル（最大 300 文字）- `unwound.title`
* 展開済み URL の HTML 説明（最大 1000 文字）- `unwound.description`

**これは、URL エンリッチメントを含む [entities オブジェクト](/ja/x-api/enterprise-gnip-2.0/fundamentals/data-dictionary#x-entities) の例です。**

```
"entities": {
    "hashtags": [

    ],
    "urls": [
      {
        "url": "https:\/\/t.co\/HkTkwFq8UT",
        "expanded_url": "http:\/\/bit.ly\/2wYTb9y",
        "display_url": "bit.ly\/2wYTb9y",
        "unwound": {
          "url": "https:\/\/www.forbes.com\/sites\/laurencebradford\/2016\/12\/08\/11-websites-to-learn-to-code-for-free-in-2017\/",
          "status": 200,
          "title": "11 Websites To Learn To Code For Free In 2017",
          "description": "It\u2019s totally possible to learn to code for free...but what are the best resources to achieve that? Here are 11 websites where you can get started."
        },
        "indices": [
          10,
          33
        ]
      }
    ],
    "user_mentions": [

    ],
    "symbols": [

    ]
  },
```

**これは、エンリッチされていないポストリンクを含む `entities` オブジェクトの例です。
**

```
"entities": {
  "urls": [{
    "url": "https://t.co/SywNbZdDmb",
    "expanded_url": "https://x.com/XDevelopers/status/1050118621198921728",
    "display_url": "x.com/XDevelopers/s…",
     "indices": [
        142,
        165
     ]
   }
  ]
}
```

<div id="filtering-operators">
  #### フィルタリング演算子
</div>

次の演算子は、URL メタデータの関連フィールドに対してフィルタリングを行い、トークン化された一致を提供します。

**url:**

* 例: “url:tennis”
* 単語 tennis を含む任意の Expanded URL に対するトークン化された一致
* “url:npr.org” のように記述することで、特定のウェブサイトのリンクを含めたり除外したりするためのフィルターとして使用することも可能です

**url&#95;title:**

* 例: “url&#95;title:tennis”
* 単語 tennis を含む任意の Expanded URL の HTML タイトルに対するトークン化された一致
* ペイロードに含まれる HTML タイトルデータに対する一致であり、タイトルは 300 文字に制限されています。

**url&#95;description:**

* 例: “url&#95;description:tennis”
* 単語 tennis を含む任意の Expanded URL の HTML 説明文に対するトークン化された一致
* ペイロードに含まれる HTML 説明文に対する一致であり、説明文は 1000 文字に制限されています。
   

<div id="http-status-codes">
  #### HTTP Status Codes
</div>

展開URLエンリッチメントでは、展開しようとしている最終URLに対するHTTPステータスコードも提供します。通常は 200 番台の値になります。その他の 400 番台の値は、URLの解決時に問題が発生したことを示します。

URLを展開しようとすると、さまざまなステータスコードが返される可能性があります。URLの展開処理の途中でリダイレクトが発生した場合は、次のいずれかの状況になるまでリダイレクトを辿り続けます。

* 200 番台のコードに到達した場合（成功）
* リダイレクト以外のコードに到達した場合（失敗）
* 最終URLが妥当な時間内に解決できずタイムアウトした場合（408 - timeout を返す）
* 何らかの例外が発生した場合
   

例外が発生した場合は、以下のように理由と返されるステータスコードを対応付けます。

| Reason | Status Code Returned |
| :--- | :--- |
| SSL Exceptions | 403 (Forbidden) |
| Unwinding not allowed by URL | 405 |
| Socket Timeout | 408 (Timeout) |
| Unknown Host Exception | 404 (Not Found) |
| Unsupported Operation | 404 (Not Found) |
| Connect Exception | 404 (Not Found) |
| Illegal Argument | 400 (Bad Request) |
| Everything else | 400 (Bad Request) |

<div id="matching-rules">
  ### 一致ルール
</div>

matching rules エンリッチメントは、受信したポストに対してどのルールが一致したかを示すメタデータオブジェクトです。これは主に PowerTrack ストリームで使用されます。

一致処理は、ルールに含まれるキーワードに対する完全一致で行われ、アクティビティのコンテンツを句読点の有無の両方でスキャンします。一致判定は大文字と小文字を区別しません。コンテンツ内にルールで定義されたすべてのキーワードが含まれていると判断された場合、一致の原因となったルールを示す、ルートレベルの matching&#95;rules オブジェクトが追加されます。

**PowerTrack**

PowerTrack（リアルタイム、Replay、Historical）を通じて配信されるポストには、次のように matching&#95;rules オブジェクトが含まれます。

```
"matching_rules": [{
        "tag": null,
        "id": 907728589029646336,
        "id_str": "907728589029646336"
    }]
```

PowerTrack では、`matching_rules` オブジェクトは、その結果にマッチしたルールを *すべて* 反映します。言い換えると、特定のポストに複数のルールがマッチした場合でも、そのポストは 1 回しか配信されませんが、`matching_rules` 要素にはマッチしたすべてのルールが含まれます。

<div id="poll-metadata">
  ### Poll metadata
</div>

Poll metadata は、ネイティブ形式でエンリッチされたペイロード内で、すべてのプロダクト（Realtime &amp; Historical APIs）において利用可能な無償のエンリッチメントです。このメタデータには、ポスト内に投票が存在することの情報、投票の選択肢のリストに加え、投票の継続時間と有効期限の両方が含まれます。このエンリッチメントにより、投票の有無を容易に把握できるようになり、表示用に投票を含むポストを適切にレンダリングすることが可能になります。

<div id="important-details">
  ##### 重要なポイント:
</div>

* すべての Enterprise API（PowerTrack、Replay、Search、Historical PowerTrack）で利用可能
  * *注記:* Replay および Historical PowerTrack では、このメタデータは 2017年2月22日に初めて利用可能になりました。
* 投票情報や投票結果は含まれません
* 現時点ではフィルター／オペレーターはサポートしていません
* **enriched native format** でのみ利用可能
  * Enriched native format はユーザーが管理できる設定で、Console からいつでも変更できます：*Select a Product (PowerTrack, Replay, Search) &gt; Settings タブ &gt; Output Format (Leave data in its original format)*

<div id="post-payload">
  #### ポストのペイロード
</div>

投票付きポストには、ペイロード内の「entities.polls」オブジェクトに、次のメタデータが含まれます。

* 最大 4 つまでの選択肢を含み、位置 (1–4) と選択肢テキストを持つ「options」配列
* 投票の終了日時
* 投票の継続時間

参考として、以下のサンプルペイロードを参照してください。

#### サンプルペイロード

以下は、追加された投票メタデータを示す、拡張ネイティブ形式ペイロードの抜粋です。

```json
"entities":{
          "hashtags":[],
          "urls":[],
          "user_mentions":[],
          "symbols":[],
          "polls":[
             {
                "options":[
                   {
                      "position":1,
                      "text":"The better answer"
                   },
                   {
                      "position":2,
                      "text":"The best answer"
                   }
                ],
                "end_datetime":"Sat Feb 04 15:33:11 +0000 2017",
                "duration_minutes":1440
             }
          ]
       },
```

<div id="profile-geo">
  ### Profile Geo（プロフィールジオ）
</div>

<div id="introduction">
  #### はじめに
</div>

多くの X ユーザープロフィールには、ユーザーが提供した公開位置情報が含まれています。このデータは、`user.location` に通常の文字列として返されます（[User object data dictionary](/ja/x-api/enterprise-gnip-2.0/fundamentals/data-dictionary#native-enriched-user-object) を参照）。Profile Geo Enrichment は、可能な場合に位置情報文字列をジオコーディングおよび正規化することで、`user.location` の値に関連する構造化されたジオデータを追加します。緯度/経度座標と関連するプレースに関するメタデータの両方が、Enterprise API 製品でポストのペイロードの一部として含まれている場合にのみ、`user.derived.locations` に追加されます。このデータは [enriched native format](/ja/x-api/enterprise-gnip-2.0/fundamentals/data-dictionary) を使用しているときに利用可能で、[PowerTrack rules](/ja/x-api/enterprise-gnip-2.0/fundamentals/rules-filtering#enterprise-operators) を組み合わせてフィルタリングできます。

<Note>
  **注:** Profile Geo Enrichment を作成するために使用される補助的なジオデータの一部は GeoNames.org に由来し、X はそれを [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/us/legalcode) の下で使用しています。
</Note>

Profile Geo データは、X の PowerTrack、Replay、Volume Stream、Search、および Historical PowerTrack API に含まれます。

<div id="profile-geo-data">
  #### プロフィール位置情報データ
</div>

| Enriched native field name | Example value | Description |
| :--- | :--- | :--- |
| user.derived.locations.country | United States | ポストを作成したユーザーの出身国を示す位置情報です。 |
| user.derived.locations.country&#95;code | US  | ポストを作成したユーザーの出身国の位置情報に対応する、2文字の ISO-3166 国コードです。 |
| user.derived.locations.locality | Birmingham | ポストを作成したユーザーの所在地（一般的に市区町村）を示す位置情報です。 |
| user.derived.locations.region | Alabama | ポストを作成したユーザーの地域（一般的に州／都道府県）を示す位置情報です。 |
| user.derived.locations.sub&#95;region | Jefferson County | ポストを作成したユーザーのサブリージョン（一般的に郡）を示す位置情報です。 |
| user.derived.locations.full&#95;name | Birmingham, Alabama, United States | ポストを作成したユーザーの所在地（サブリージョンを除く）のフル表記です。 |
| User.derived.locations.geo | See Below | ポストを作成したユーザーの所在地のうち、最も細かい粒度の位置情報に対応する座標について、緯度・経度の値を含む配列です。 |

Historical PowerTrack、Search、および PowerTrack API は、プロフィール位置情報データに基づいたフィルタリングをサポートします。プロフィール位置情報データに対して利用可能なフィルタリング用オペレーターの詳細については、該当するプロダクトドキュメントを参照してください。

<div id="sample-payload">
  #### ペイロードのサンプル
</div>

```
{
    "user": {
        "derived": {
            "locations": \[
                {
                    "country": "United States",
                    "country_code": "US",
                    "locality": "Birmingham",
                    "region": "Alabama",
                    "sub_region": "Jefferson County",
                    "full_name": "Birmingham, Alabama, United States",
                    "geo": {
                        "coordinates": \[
                            -86.80249,
                            33.52066
                        \],
                        "type": "point"
                    }
                }
            \]
        }
    }
}
```

<div id="limitations">
  #### 制限事項
</div>

* Profile Geo エンリッチメントは、プロフィールの location 文字列で記述されている地理的な場所について、最適と思われる候補を推定します。複数の場所が似た名称を持つ場合や、名称があいまいな場合などの要因により、結果が常に正確とは限りません。
* ユーザーのプロフィールの location フィールド（actor.location）に値が設定されていない場合は、分類は行いません。
* 精度レベル：Profile Geo エンリッチメントが国レベルまたは地域レベルでしか十分な確信をもって決定できない場合、subRegion や locality など、より下位の地理情報はペイロードから省略されます。
* Profile Geo エンリッチメントは、エンリッチメント結果の精度レベルに対応する緯度/経度座標（単一のポイント）を提供します。これらの座標は、エンリッチメントで特定された場所の地理的中心を表します。たとえば、精度レベルが国レベルの場合、その座標はその国の地理的中心に設定されます。
* アドレスプロパティ（locality/region/country/country code）に対して提供される PowerTrack 演算子は、多くのルールを組み合わせられるよう、意図的に粒度が細かくなっています。同じ名前を持つ別の場所と名称が重複している特定の場所をターゲットにする場合は、アドレスに関するルールを組み合わせることを検討してください。たとえば、次のようにすることで「San Francisco, Philippines」とのマッチを回避できます：profile&#95;locality:&quot;San Francisco&quot; profile&#95;region:California。個々の Profile Geo フィールドをターゲットにするルールを作成する際には、粒度を上げるほど取得できる結果が制限される点に留意してください。都市単位のデータを見ようとする場合でも、その都市と大きく重なる地域（region）がある場合は、地域に関するルールのみに依存した方がよいケースもあります。たとえば、スイスの都市 Zurich の場合、profile&#95;region:&quot;Zurich&quot; を使用することで、周辺地域も含めて効果的にターゲットにできます。
* ネイティブ Geo を持つポストとの併用：Profile Geo エンリッチメントは、ペイロード内のネイティブ geo 値とは異なる、ポストに対する別種の地理情報を提供します。これら 2 種類の地理情報は、特定のエリアに関連する可能性のあるすべてのポストを（利用可能な地理データに基づき）取得するために組み合わせて使用できますが、概念的に同一のものではありません。