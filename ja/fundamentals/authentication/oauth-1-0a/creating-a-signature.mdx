---
title: 署名の作成
sidebarTitle: 署名の作成
keywords: ["OAuth 署名", "署名の作成", "OAuth 1.0a 署名", "HMAC 署名", "署名の生成", "OAuth 署名処理"]
---

import { Button } from "/snippets/ja/button.mdx";

<div id="creating-a-signature">
  ### シグネチャの作成
</div>

このページでは、HTTP リクエストに対する OAuth 1.0a HMAC-SHA1 シグネチャの生成方法を説明します。このシグネチャは、[リクエストの認可](/ja/resources/fundamentals/authentication/oauth-1-0a/authorizing-a-request) で説明しているとおり、認可済みリクエストの一部として X API に渡すのに適しています。

署名方法の説明に用いるリクエストは、[https://api.x.com/1.1/statuses/update.json](https://api.x.com/1.1/statuses/update.json) への POST です。生の HTTP リクエストは次のようになります。

```
POST /1.1/statuses/update.json?include_entities=true HTTP/1.1
Accept: */*
Connection: close
User-Agent: OAuth gem v0.4.4
Content-Type: application/x-www-form-urlencoded
Content-Length: 76
Host: api.x.com

status=Hello%20Ladies%20%2b%20Gentlemen%2c%20a%20signed%20OAuth%20request%21
```

**リクエストメソッドと URL の取得**

署名を生成するには、まずリクエストの HTTP メソッドと URL を特定します。これら 2 つはリクエストを作成する時点で分かっているため、簡単に取得できます。

X API へのリクエストでは、リクエストメソッドはほとんど常に GET または POST になります。

|             |      |
| :---------- | :--- |
| HTTP Method | POST |

ベース URL は、クエリ文字列やハッシュパラメータを除いた、リクエストの送信先となる URL です。ここで正しいプロトコルを使用することが重要なため、URL の「https://」の部分が、API に送信される実際のリクエストと一致していることを確認してください。

|          |                                                                                          |
| :------- | :--------------------------------------------------------------------------------------- |
| Base URL | [https://api.x.com/1.1/statuses/update.json](https://api.x.com/1.1/statuses/update.json) |

<div id="collecting-parameters">
  #### パラメーターの収集
</div>

次に、リクエストに含まれるすべてのパラメーターを集めます。これらの追加パラメーターが存在し得る場所は 2 つあります。URL（クエリ文字列の一部）とリクエストボディです。サンプルリクエストには、両方の場所に 1 つずつパラメーターが含まれています。

```
POST /1.1/statuses/update.json?include_entities=true HTTP/1.1
Accept: */*
Connection: close
User-Agent: OAuth gem v0.4.4
Content-Type: application/x-www-form-urlencoded
Content-Length: 76
Host: api.x.com

status=Hello%20Ladies%20%2b%20Gentlemen%2c%20a%20signed%20OAuth%20request%21
```

HTTP リクエストには URL エンコードされたパラメータがありますが、生の値をそのまま取得する必要があります。リクエストパラメータに加えて、すべての `oauth_*` パラメータを署名に含める必要があるため、それらも同様に収集してください。[リクエストの認可](/ja/resources/fundamentals/authentication/oauth-1-0a/authorizing-a-request) から取得したパラメータは次のとおりです。

|                                |                                                    |
| :----------------------------- | :------------------------------------------------- |
| status                         | Hello Ladies + Gentlemen, a signed OAuth request!  |
| include&#95;entities           | true                                               |
| oauth&#95;consumer&#95;key     | xvz1evFS4wEEPTGEFPHBog                             |
| oauth&#95;nonce                | kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg         |
| oauth&#95;signature&#95;method | HMAC-SHA1                                          |
| oauth&#95;timestamp            | 1318622958                                         |
| oauth&#95;token                | 370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb |
| oauth&#95;version              | 1.0                                                |

これらの値は 1 つの文字列にエンコードする必要があり、この文字列は後で使用されます。文字列を構築する手順は非常に厳密に決められています。

1. 署名対象となるすべてのキーと値を [パーセントエンコード](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters) します。
2. エンコードされたキー [[2]](/ja/resources/fundamentals/authentication/oauth-1-0a/creating-a-signature) に基づき、パラメータのリストをアルファベット順 [[1]](/ja/resources/fundamentals/authentication/oauth-1-0a/creating-a-signature) にソートします。
3. 各キー/値のペアに対して:
4. エンコードされたキーを出力文字列に追加します。
5. 文字「=」を出力文字列に追加します。
6. エンコードされた値を出力文字列に追加します。
7. さらに残りのキー/値ペアがある場合は、文字「&amp;」を出力文字列に追加します。
    

[1] OAuth の仕様では、ソートは辞書式順 (lexicographically) で行うと定められており、これは多くのライブラリでのデフォルトのアルファベット順ソートです。

[2] 同じエンコード済みキーを持つ 2 つのパラメータがある場合、OAuth の仕様では値に基づいてソートを続けると定めています。ただし、X では API リクエスト内の重複キーは受け付けません。
 

**パラメータ文字列**

上記のパラメータを使ってこれらの手順を繰り返すと、次の *パラメータ文字列* が生成されます。

| status                   | Hello Ladies + Gentlemen, a signed OAuth request!  |
| :----------------------- | :------------------------------------------------- |
| `include_entities`       | true                                               |
| `oauth_consumer_key`     | xvz1evFS4wEEPTGEFPHBog                             |
| `oauth_nonce`            | kYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg         |
| `oauth_signature_method` | HMAC-SHA1                                          |
| `oauth_timestamp`        | 1318622958                                         |
| `oauth_token`            | 370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb |
| `oauth_version`          | 1.0                                                |

<div id="creating-the-signature-base-string">
  #### 署名ベース文字列の作成
</div>

ここまでに収集した 3 つの値は 1 つの文字列に結合し、その文字列から署名を生成します。OAuth 仕様では、これを **署名ベース文字列** と呼びます。

HTTP メソッド、ベース URL、およびパラメーター文字列を 1 つの文字列にエンコードするには、次の手順で行います。

1. HTTP メソッドを大文字に変換し、その値を出力文字列に設定します。
2. 出力文字列の末尾に ‘&amp;’ 文字を追加します。
3. URL を[パーセントエンコード](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)し、出力文字列の末尾に追加します。
4. 出力文字列の末尾に ‘&amp;’ 文字を追加します。
5. パラメーター文字列を[パーセントエンコード](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)し、出力文字列の末尾に追加します。
    

これにより、次の *署名ベース文字列* が生成されます。

```
POST&https%3A%2F%2Fapi.x.com%2F1.1%2Fstatuses%2Fupdate.json&include_entities%3Dtrue%26oauth_consumer_key%3Dxvz1evFS4wEEPTGEFPHBog%26oauth_nonce%3DkYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1318622958%26oauth_token%3D370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb%26oauth_version%3D1.0%26status%3DHello%2520Ladies%2520%252B%2520Gentlemen%252C%2520a%2520signed%2520OAuth%2520request%2521
```

パラメーター文字列は必ずパーセントエンコードしてください。signature base string には、アンパサンド ‘&amp;’ 文字がちょうど 2 個含まれていなければなりません。パラメーター文字列内のパーセント ‘%’ 文字は、signature base string では %25 にエンコードされている必要があります。

<div id="getting-a-signing-key">
  #### 署名キーの取得
</div>

収集すべき最後のデータは、リクエストを送信している [X アプリ](/ja/resources/fundamentals/developer-apps) を識別するためのシークレットと、そのリクエストが代理で実行されているユーザーを識別するためのシークレットです。これらの値は極めて機密性の高い情報であり、決して他者と共有してはならない点に十分注意してください。

あなたのアプリを X に対して識別する値は **consumer secret** と呼ばれ、[developer portal](/ja/resources/fundamentals/developer-portal) で [app details page](/ja/resources/fundamentals/developer-apps) を表示すると確認できます。これは、あなたの X アプリが送信するすべてのリクエストで同じ値になります。

|     |     |
| :--- | :--- |
| Consumer secret | kAcSOqF21Fu85e7zjz7ZN2U4ZRhfV3WpwPAoE3Z7kBw |

アプリケーションが代理で動作しているアカウントを識別する値は **OAuth token secret** と呼ばれます。この値を取得する方法はいくつかあり、そのすべては [obtaining access tokens](/ja/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens) で説明されています。

|     |     |
| :--- | :--- |
| OAuth token secret | LswwdoUaIvS8ltyTt5jkRh4J50vUPVVHtR2YPi5kE |

繰り返しになりますが、これらの値はアプリケーションだけが知っている状態に保つことが非常に重要です。これらの値が漏洩した可能性があると感じた場合は、トークンを再生成してください（このページに記載されているトークンは、実際のリクエストでは無効としてマークされています）。

これら 2 つの値は組み合わせて **署名キー (signing key)** を形成する必要があり、この署名キーを使って署名を生成します。署名キーは、単に [パーセントエンコードされた](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters) トークンシークレットです。

[request token](/ja/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens) を取得する場合など、トークンシークレットがまだ分からないフローもあることに注意してください。この場合、署名キーは、[パーセントエンコードされた](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters) **consumer secret** の後にアンパサンド文字「&amp;」を続けたものとします。

|     |     |
| :--- | :--- |
| Signing key | kAcSOqF21Fu85e7zjz7ZN2U4ZRhfV3WpwPAoE3Z7kBw&amp;LswwdoUaIvS8ltyTt5jkRh4J50vUPVVHtR2YPi5kE |

<div id="calculating-the-signature">
  #### シグネチャの計算
</div>

最後に、シグネチャベース文字列と署名キーを HMAC-SHA1 ハッシュアルゴリズムに渡してシグネチャを計算します。アルゴリズムの詳細については、hash&#95;hmac 関数の説明を参照してください。

HMAC 署名関数の出力はバイナリデータです。これを Base64 エンコードして、シグネチャ文字列を生成する必要があります。たとえば、このページで示したベース文字列と署名キーを使用した場合の出力は 2E CF 77 84 98 99 6D 0D DA 90 5D C7 17 7C 75 07 3F 3F CD 4E です。この値を Base64 エンコードすると、このリクエストの OAuth シグネチャになります。

|     |     |
| :--- | :--- |
| OAuth signature | Ls93hJiZbQ3akF3HF3x1Bz8/zU4= |