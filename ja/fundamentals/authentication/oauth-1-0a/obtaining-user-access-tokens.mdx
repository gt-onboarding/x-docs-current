---
title: 3-legged OAuth フローを使用したアクセストークンの取得
sidebarTitle: ユーザーアクセストークン（3-legged OAuth フロー）
keywords: ["3-legged OAuth", "ユーザーアクセストークン", "OAuth フロー", "アクセストークンの取得", "OAuth 1.0a フロー", "アクセストークンの生成"]
---

import { Button } from "/snippets/ja/button.mdx";

<div id="obtaining-access-tokens-using-3-legged-oauth-flow">
  ### 3-legged OAuth フローを使用してアクセストークンを取得する
</div>

他のユーザーに代わって操作を行うには、そのユーザーのアクセストークンを取得する必要があります。アクセストークンは、リクエストがどの X アカウントに代わって行われているかを指定するため、あなたがこれらを取得するには、まず相手ユーザーがあなたにアクセス権を付与する必要があります。これらのトークン自体には有効期限はありませんが、ユーザーがいつでも取り消すことができます。

X では 3-legged OAuth フローを通じてユーザーのアクセストークンを取得できます。このフローでは、ユーザーを X にリダイレクトしてアプリケーションを承認してもらうことで、アプリケーションが **access token** と access token secret を取得できます。このフローは、[implementing Log in with X](/ja/resources/fundamentals/authentication/guides/log-in-with-x) で説明しているフローとほぼ同じですが、次の 2 点が異なります。

* [GET oauth/authorize](/ja/resources/fundamentals/authentication/api-reference#get-oauth-authorize) エンドポイントを、[GET oauth/authenticate](/ja/resources/fundamentals/authentication/api-reference#get-oauth-authenticate) の代わりに使用します。
* 以前にアクセスが許可されていた場合でも、ユーザーには常にアプリケーションへのアクセス許可を求めるプロンプトが表示されます。
   

開始する前に、[アプリケーション](/ja/resources/fundamentals/developer-apps) の権限を確認し、コンシューマキーとコールバック URL を把握しておく必要があります。コールバック URL や外部からアクセス可能な UI がない場合は、[PIN-based authorization](/ja/resources/fundamentals/authentication/oauth-1-0a/pin-based-oauth) の利用を検討してください。これは、承認後にユーザーをリダイレクトするための Web ブラウザにアクセスできない、またはそれを埋め込めないアプリケーション向けに設計されています。 

3-legged サインイン処理における取りうる状態は、次のフローチャートで示されています。

![](https://cdn.cms-twdigitalassets.com/content/dam/developer-twitter/docs/obtaining-access-tokens.png.twimg.1920.png)

<div id="overview-of-the-process">
  #### プロセスの概要
</div>

大まかには、3-Legged OAuth プロセスは次のように動作します。

1. コンシューマーアプリケーションがリクエストトークンを取得できるように、リクエストを作成します。
2. ユーザーに認証を行わせ、コンシューマーアプリケーションにリクエストトークンを送信します。
3. リクエストトークンを、実際に利用可能なユーザーアクセストークンに変換します。

**用語の明確化**

以下のガイドでは、同じものを指すのに異なる用語が使われている場合があります。

**クライアント資格情報:**

* App Key === API Key === Consumer API Key === Consumer Key === Customer Key === `oauth_consumer_key`
* App Key Secret === API Secret Key === Consumer Secret === Consumer Key === Customer Key === `oauth_consumer_secret`
* Callback URL === `oauth_callback`
   

**一時的な資格情報:**

* Request Token === `oauth_token`
* Request Token Secret === `oauth_token_secret`
* oauth&#95;verifier
   

**トークン資格情報:**

* アクセストークン === Token === 結果として得られる `oauth_token`
* アクセストークンシークレット === Token Secret === 結果として得られる `oauth_token_secret`

<div id="walkthrough-steps">
  #### 手順のウォークスルー
</div>

**ステップ 1: [POST oauth/request&#95;token](/ja/resources/fundamentals/authentication/api-reference#post-oauth-request-token)**

コンシューマーアプリケーションがリクエストトークンを取得するためのリクエストを作成します。

このリクエストで固有のパラメータは `oauth_callback` のみであり、ステップ 2 完了時にユーザーをリダイレクトしたい URL を [URL エンコード](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters) した値である必要があります。残りのパラメータは OAuth 署名処理によって追加されます。

注意: [POST oauth/request&#95;token](/ja/resources/fundamentals/authentication/api-reference#post-oauth-request-token) エンドポイントで使用する任意のコールバック URL は、developer portal のアプリ詳細ページにある [開発者アプリ](/ja/resources/fundamentals/developer-apps) の設定内で事前に設定しておく必要があります。
 

**リクエストに含まれる内容:**

`oauth_callback="https%3A%2F%2FyourCallbackUrl.com"`

`oauth_consumer_key="cChZNFj6T5R0TigYB9yd1w" `

アプリはレスポンスの HTTP ステータスを確認する必要があります。200 以外の値は失敗を示します。レスポンスボディには `oauth_token`、`oauth_token_secret`、`oauth_callback_confirmed` パラメータが含まれます。アプリは `oauth_callback_confirmed` が true であることを検証し、残り 2 つの値を次のステップのために保存しておく必要があります。
 

**レスポンスに含まれる内容**

`oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0`

`oauth_token_secret=veNRnAWe6inFuo8o2u8SLLZLjolYDmDP7SzL0YfYI`

`oauth_callback_confirmed=true`

**ステップ 2: [GET oauth/authorize](/ja/resources/fundamentals/authentication/api-reference#get-oauth-authorize)**

ユーザーに認証を行ってもらい、コンシューマーアプリケーションにリクエストトークンを送信させます。
 

**ユーザーをリダイレクトするための URL の例:**

`https://api.x.com/oauth/authorize?oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0`

認証が成功すると、`callback_url` は `oauth_token` と `oauth_verifier` パラメータを含むリクエストを受信します。アプリケーションは、このトークンがステップ 1 で受信したリクエストトークンと一致することを確認する必要があります。
 

**クライアントのリダイレクトからのリクエスト:**

`https://yourCallbackUrl.com?oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0&oauth_verifier=uw7NjWHT6OJ1MpJOXsHfNxoAhPKpgI8BlYDhxEjIBY`

**ステップ 3: [POST oauth/access&#95;token](/ja/resources/fundamentals/authentication/api-reference#post-oauth-access-token)**

リクエストトークンを使用可能なアクセストークンに変換します。

リクエストトークンを使用可能なアクセストークンに変換するには、アプリケーションは [POST oauth/access&#95;token](/ja/resources/fundamentals/authentication/api-reference#post-oauth-access-token) エンドポイントに対して、ステップ 2 で取得した `oauth_verifier` の値を含むリクエストを送信する必要があります。リクエストトークンはヘッダー内の `oauth_token` 部分にも渡されますが、これは署名プロセスによって追加されます。
 

**リクエストに含まれる内容:**

`POST /oauth/access_token`

`oauth_consumer_key=cChZNFj6T5R0TigYB9yd1w`

`oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0`

`oauth_verifier=uw7NjWHT6OJ1MpJOXsHfNxoAhPKpgI8BlYDhxEjIBY`

成功したレスポンスには `oauth_token`、`oauth_token_secret` パラメータが含まれます。トークンとトークンシークレットは保存し、今後 X API への認証済みリクエストに使用する必要があります。ユーザーを特定するには、[GET account/verify&#95;credentials](/ja/resources/fundamentals/authentication/api-reference) を使用します。
 

**レスポンスに含まれる内容:**

`oauth_token=7588892-kagSNqWge8gB1WwE3plnFsJHAZVfxWD7Vb57p0b4`

`oauth_token_secret=PbKfYqSryyeKDWz4ebtY3o5ogNLG11WJuZBc9fQrQo`

**これらの認証情報を OAuth 1.0a（アプリケーション-ユーザー）を必要とするリクエストで使用する**

これでユーザーのアクセストークンを取得できたので、[POST statuses/update](/ja/x-api/posts/manage-tweets/introduction) などの特定のAPIを利用して、ユーザーに代わってポストを作成できるようになります。
 

**リクエストには次の項目が含まれます:**

`POST statuses/update.json`

`oauth_consumer_key=cChZNFj6T5R0TigYB9yd1w`

`oauth_token=7588892-kagSNqWge8gB1WwE3plnFsJHAZVfxWD7Vb57p0b4`

<div id="sample-use-case">
  #### サンプルユースケース
</div>

標準的なフローは Web ベースで、3-legged OAuth 認可フローを使用します。ここで示しているスクリーンショットは、[https://github.com/xdevplatform/twauth-web](https://github.com/xdevplatform/twauth-web) でソースコードを参照できるサンプルの一部です。

アプリケーション内のある時点で、アプリケーションを認可してもらうために X へリダイレクトする必要があります。

<Frame>
  <img src="/images/twauth-web-2.png" alt="" />
</Frame>

リクエストトークンを付けて X にリダイレクトすると、ユーザーはアプリケーションを認可するよう促されます。

<Frame>
  <img src="/images/twauth-web-3.png" alt="" />
</Frame>

ユーザーがアプリケーションを認可すると、リクエストトークンを生成した際に指定したコールバック URL にユーザーがリダイレクトされます。これを使用して、このユーザーの永続的なアクセストークンを取得し、ローカルに保存します。

<Frame>
  <img src="/images/twauth-web-4.png" alt="" />
</Frame>