---
title: OAuth エコー
sidebarTitle: OAuth エコー
keywords: ["OAuth エコー", "OAuth エコーテスト", "OAuth 検証", "エコーテスト", "OAuth 1.0a エコー", "OAuth の検証"]
---

import { Button } from "/snippets/ja/button.mdx";


<div id="oauth-echo">
  ### OAuth Echo
</div>

OAuth Echo は、API とやり取りする際に、OAuth 認可をサードパーティへ安全に委任するための仕組みです。

このやり取りには 4 つの主体が関わります。

* **ユーザー** — 特定の、認可された X アプリケーションを通じて X を利用している人
* **コンシューマー (Consumer)** — サードパーティのメディアプロバイダー（例: 写真共有サイト）とやり取りしようとしている X アプリケーション
* **デリゲーター (Delegator)** — サードパーティのメディアプロバイダー
* **サービスプロバイダー (Service Provider)** — いわゆる X 本体
     

基本的には、アプリケーションとユーザーを代表して、デリゲーターが X API に送信するリクエストを準備します。通常であれば署名付きの OAuth リクエストとなる内容を HTTP ヘッダーに入れ、デリゲーターに対し、中間処理を完了した後でそのリクエストを X に送信するよう依頼します。

例を挙げます。ユーザーが写真をアップロードしたいとします。コンシューマーは、POST でデリゲーターの upload を呼び出します。POST には画像を含める必要がありますが、加えて HTTP ヘッダーとして次の 2 つの項目も含める必要があります。

* `x-auth-service-provider` — 実質的には、アイデンティティ委譲を送信すべきレルムです。X の場合、これは https://api.x.com/1.1/account/verify_credentials.json に設定します。iOS5 ベースの X 連携では、この URL に追加の `application_id` パラメーターが付与され、`x-verify-credentials-authorization` で使用される `oauth_signature` の計算にも利用されます。
* `x-verify-credentials-authorization` — コンシューマーは、OAuth を使用して HTTP ヘッダー内から https://api.x.com/1.1/account/verify_credentials.json を呼び出せるように、必要なすべての OAuth パラメーターを作成します（例: `OAuth oauth_consumer_key=”...”, oauth_token=”...”, oauth_signature_method=”...”, oauth_signature=”...”, oauth_timestamp=”...”, oauth_nonce=”...”, oauth_version=”...”` のような形式になります）。
     

トランザクション全体が、`oauth_timestamp` が有効な時間内に完了する必要があることに注意してください。

また、これら 2 つのパラメーターをヘッダーではなく、POST 内で `x_auth_service_provider` および `x_verify_credentials_authorization` として送信することもできます。この場合、OAuth シグネチャのベース文字列に含めるため、これらのパラメーターをエスケープしたうえで含めることを忘れないでください。これは任意のリクエストでパラメーターをエンコードする場合と同様です。処理同士を可能な限り分離しておくためには、HTTP ヘッダーを使用するのが最善です。

この時点でのデリゲーターの目的は、メディアを保存する前に、ユーザーが申告どおりの本人であることを検証することです。デリゲーターは、upload メソッドを通じて上記すべてのデータを受信したら、画像を一時的に保存し、`x-auth-service-provider` ヘッダーで指定されたエンドポイント、つまり https://api.x.com/1.1/account/verify_credentials.json に対する呼び出しを構成します。この際、コンシューマーが `x-verify-credentials-authorization` ヘッダー内で提供したものと同じ OAuth 認証ヘッダーを使用します。
 

<div id="oauth-echo-best-practices">
  #### OAuth Echo のベストプラクティス
</div>

ルックアップを行う際は、ハードコードした値ではなく、`x-auth-service-provider` によって提供される URL を使用してください。たとえば Apple iOS では、すべての OAuth リクエストに追加の application_id パラメータが付与されますが、このパラメータは OAuth Echo の各段階で失われないように維持する必要があります。

OAuth 認可部分では、`x-verify-credentials-authorization` のヘッダー値を取得し、そのサービスプロバイダーへの呼び出し用に、独立した Authorization ヘッダーとして設定します。念のため、`x-auth-service-provider` の値が期待どおりであることも確認してください。

* Service Provider が HTTP 200 を返した場合は成功です。Delegator は画像を永続的に保存し、URL を生成して返却する必要があります。
* Service Provider が HTTP 200 を返さなかった場合は、画像を破棄し、Consumer にエラーを返却してください。