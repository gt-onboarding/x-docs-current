---
title: PKCE を用いた OAuth 2.0 認可コードフロー
sidebarTitle: PKCE を用いた OAuth 2.0 認可コードフロー
keywords: ["OAuth 2.0 PKCE", "認可コードフロー", "PKCE", "OAuth 2.0 フロー", "PKCE フロー", "OAuth 2.0 認可", "コードチャレンジ"]
---

<div id="oauth-20-authorization-code-flow-with-pkce">
  ### PKCE を利用した OAuth 2.0 認可コードフロー
</div>

<div id="introduction">
  #### はじめに
</div>

OAuth 2.0 は、アプリケーションのスコープや複数デバイス間での認可フローをより細かく制御できる、業界標準の認可プロトコルです。OAuth 2.0 を使用すると、ユーザーに代わって特定の権限を付与する細かなスコープを個別に選択できます。 

アプリで OAuth 2.0 を有効にするには、developer portal の App settings セクションにある authentication settings で OAuth 2.0 を有効にする必要があります。

<div id="how-long-will-my-credentials-stay-valid">
  #### 認証情報はどのくらいの期間有効ですか？
</div>

デフォルトでは、Authorization Code Flow with PKCE を通じて作成したアクセストークンは、`offline.access` スコープを使用していない限り、2時間のみ有効です。

<div id="refresh-tokens">
  #### リフレッシュトークン
</div>

リフレッシュトークンを使用すると、リフレッシュトークンフローを通じてユーザーに再度操作を求めることなく、アプリケーションが新しいアクセストークンを取得できます。

スコープ `offline.access` が付与されている場合、OAuth 2.0 のリフレッシュトークンが発行されます。このリフレッシュトークンを使用してアクセストークンを取得できます。このスコープが指定されていない場合、リフレッシュトークンは生成されません。

リフレッシュトークンを使用して新しいアクセストークンを取得する際に行うリクエストの例は次のとおりです。

```bash
POST 'https://api.x.com/2/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'refresh_token=bWRWa3gzdnk3WHRGU1o0bmRRcTJ5VUxWX1lZTDdJSUtmaWcxbTVxdEFXcW5tOjE2MjIxNDc3NDM5MTQ6MToxOnJ0OjE' \
--data-urlencode 'grant_type=refresh_token' \
--data-urlencode 'client_id=rG9n6402A3dbUJKzXTNX4oWHJ
```

<div id="app-settings">
  #### アプリの設定
</div>

アプリの認証設定として、OAuth 1.0a か OAuth 2.0 を選択できます。アプリで OAuth 1.0a と OAuth 2.0 の両方を有効にすることもできます。

OAuth 2.0 は X API v2 との組み合わせでのみ使用できます。OAuth 2.0 を選択した場合は、アプリの「Keys and Tokens」セクションに Client ID が表示されます。 

<div id="confidential-clients">
  #### 機密クライアント
</div>

[Confidential clients](https://datatracker.ietf.org/doc/html/rfc6749#section-2.1) は、認証されていない第三者にクレデンシャルを公開することなく安全に保持でき、認可サーバーに対して安全に認証を行うことができるため、client secret を安全に保持できます。一方、public client は通常ブラウザまたはモバイルデバイス上で動作しており、client secret を安全に扱うことができません。機密クライアントに該当する種類のアプリを選択した場合、client secret が発行されます。 

developer portal で機密クライアントに該当する種類のクライアントを選択した場合は、Client Secret も確認できます。選択可能な種類は Native App、Single page App、Web App、Automated App、または bot です。Native App と Single page App は public client、Web App と Automated App または bot は confidential client です。

有効な Authorization Header を使用する confidential client では、client id を指定する必要はありません。public client を用いたリクエストでは、引き続きリクエストボディに Client Id を含める必要があります。 

<div id="scopes">
  #### スコープ
</div>

スコープを使用すると、アプリに細かなアクセス権を設定し、アプリに本当に必要な権限だけを付与できます。各スコープがどのエンドポイントに対応しているかについては、[認証マッピングガイド](/ja/resources/fundamentals/authentication/guides/v2-authentication-mapping)をご覧ください。

|     |     |
| :--- | :--- |
| **Scope** | **説明** |
| tweet.read | あなたが閲覧できるすべてのポスト（保護されたアカウントのポストを含む）。 |
| tweet.write | あなたに代わってポストとリポストを行います。 |
| tweet.moderate.write | あなたのポストへの返信を非表示／再表示します。 |
| users.email | 認証済みユーザーのメールアドレス。 |
| users.read | あなたが閲覧できるすべてのアカウント（保護されたアカウントを含む）。 |
| follows.read | あなたをフォローしているアカウント、およびあなたがフォローしているアカウント。 |
| follows.write | あなたに代わってアカウントをフォロー／フォロー解除します。 |
| offline.access | あなたがアクセス権を取り消すまで、アカウントへの接続を維持します。 |
| space.read | あなたが閲覧できるすべてのSpace。 |
| mute.read | あなたがミュートしているアカウント。 |
| mute.write | あなたに代わってアカウントをミュート／ミュート解除します。 |
| like.read | あなたが「いいね」したポストおよび、あなたが閲覧できる「いいね」が付いたポスト。 |
| like.write | あなたに代わってポストに「いいね」／「いいね」解除を行います。 |
| list.read | あなたが作成した、またはメンバーになっているリストと、そのリストのメンバーおよびフォロワー（非公開リストを含む）。 |
| list.write | あなたに代わってリストを作成および管理します。 |
| block.read | あなたがブロックしているアカウント。 |
| block.write | あなたに代わってアカウントをブロック／ブロック解除します。 |
| bookmark.read | 認証済みユーザーのブックマークしたポストを取得します。 |
| bookmark.write | ポストをブックマークに追加し、ブックマークから削除します。 |
| media.write | メディアをアップロードします。 |

<div id="rate-limits">
  #### レート制限
</div>

ほとんどの場合、レート制限は OAuth 1.0a で認証する場合と同じですが、ポスト検索とユーザー検索のみ例外となります。OAuth 2.0 を使用したポスト検索およびユーザー検索では、アプリ単位の上限を 15 分あたり 300 リクエストから 900 リクエストへ引き上げています。詳しくは、[レート制限に関するドキュメント](/ja/resources/fundamentals/rate-limits)を必ずご確認ください。

<div id="grant-types">
  #### グラントタイプ
</div>

この初期リリースでは、サポートされる[グラントタイプ](https://oauth.net/2/grant-types/)として、[PKCE](https://oauth.net/2/pkce/) を用いた[認可コード](https://oauth.net/2/grant-types/authorization-code/)と[リフレッシュトークン](https://oauth.net/2/grant-types/refresh-token/)のみを提供しています。今後、追加のグラントタイプを提供する可能性があります。

<div id="oauth-20-flow">
  #### OAuth 2.0 フロー
</div>

OAuth 2.0 は、現在 OAuth 1.0a で使用しているものと似たフローを採用しています。このトピックに関する図や詳細な説明は、[こちらのドキュメント](/ja/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)を参照してください。 

<div id="glossary">
  #### 用語集
</div>

|     |     |
| :--- | :--- |
| **用語** | **説明** |
| Grant types | OAuth フレームワークでは、さまざまなユースケース向けに複数のグラントタイプを定義するとともに、新しいグラントタイプを作成するための枠組みも規定しています。例として、authorization code、client credentials、device code、refresh token などがあります。 |
| Confidential client | クライアントとは、たとえば登録済みの client secret を安全に保持するなど、認可サーバーに対して安全に認証できるアプリケーションのことです。 |
| Public client | ブラウザやモバイルデバイス上で動作するアプリケーションなど、登録済みの client secret を使用できないクライアントのことです。 |
| Authorization code flow | authorization code をアクセストークンと交換するために、confidential client と public client の両方で使用されます。 |
| PKCE | authorization code flow を拡張し、いくつかの攻撃手法を防ぎ、public client からも安全に OAuth のコード交換処理を行えるようにする仕組みです。 |
| Client ID | developer portal のキーとトークンのセクション内、「Client ID」という見出しの下にあります。これが表示されない場合は、弊社チームまで直接ご連絡ください。Client ID は authorize URL を生成する際に必要になります。 |
| Redirect URI | コールバック URL（リダイレクト先 URL）です。[exact match validation](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6) を満たしている必要があります。 |
| Authorization code | アプリケーションがユーザーに代わって API を呼び出せるようにするものです。auth&#95;code として知られています。ユーザーから承認済みの auth&#95;code をアプリ所有者が受け取ってから 30 秒間の有効期限があります。30 秒以内にアクセストークンと交換する必要があり、交換しない場合、auth&#95;code は失効します。 |
| Access token | アクセストークンは、アプリケーションがユーザーに代わって API リクエストを行うために使用するトークンです。 |
| Refresh token | refresh token flow を通じて、ユーザーに再度操作を求めることなく、新しいアクセストークンを取得できるようにします。 |
| Client Secret | confidential client である App タイプを選択している場合、App のキーとトークンのセクション内で、「Client ID」の下に「Client Secret」が付与されます。 |

<div id="parameters">
  #### パラメーター
</div>

OAuth 2.0 の authorize URL を構成するには、認可 URL に次のパラメーターが含まれていることを確認してください。 

|     |     |
| :--- | :--- |
| **Parameter** | **Description** |
| response&#95;type | この値がコードであることを示すため、文字列 `code` を指定する必要があります。 |
| client&#95;id | developer portal の「Client ID」欄で確認できます。 |
| redirect&#95;uri | コールバック URL です。この値は、アプリの設定で定義されている Callback URLs のいずれかと一致している必要があります。OAuth 2.0 では、コールバック URL に対して [exact match validation](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6) を行う必要があります。 |
| state | [CSRF 攻撃](https://auth0.com/docs/protocols/state-parameters) を防ぐために付与するランダムな文字列です。文字列の長さは最大 500 文字まで指定できます。 |
| code&#95;challenge | 各リクエストごとにランダムに生成する秘密値を表す [PKCE](https://www.oauth.com/oauth2-servers/pkce/authorization-request/) パラメーターです。 |
| code&#95;challenge&#95;method | 使用するメソッドを指定します（`S256` または `plain`）。 |

<div id="authorize-url">
  #### Authorize URL
</div>

OAuth 2.0 では、ユーザーが認証フローを通じてサインインできるようにするための authorize URL（認可 URL）を作成します。これは、X へのサインインと同様の動作です。 

作成する URL の例は次のとおりです。

```
https://x.com/i/oauth2/authorize?response_type=code&client_id=M1M5R3BMVy13QmpScXkzTUt5OE46MTpjaQ&redirect_uri=https://www.example.com&scope=tweet.read%20users.read%20account.follows.read%20account.follows.write&state=state&code_challenge=challenge&code_challenge_method=plain
```

このURLが正しく機能するには、適切なエンコードが必要です。[パーセントエンコーディング](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)に関するドキュメントを必ず確認してください。
