---
title: OAuth 2.0 認可コードフロー（PKCE）
sidebarTitle: OAuth 2.0 認可コードフロー（PKCE）
keywords: ["OAuth 2.0 PKCE", "認可コードフロー", "PKCE", "OAuth 2.0 フロー", "PKCE フロー", "OAuth 2.0 認可", "コードチャレンジ"]
---

<div id="oauth-20-authorization-code-flow-with-pkce">
  ### PKCE を用いた OAuth 2.0 認可コードフロー
</div>

<div id="introduction">
  #### はじめに
</div>

OAuth 2.0 は業界標準の認可プロトコルであり、アプリのスコープや複数デバイス間での認可フローを、より細かく制御できるようにします。OAuth 2.0 を使用すると、ユーザーに代わって特定の権限を付与する、きめ細かなスコープを選択できます。 

アプリで OAuth 2.0 を利用するには、developer portal の App 設定セクションにある認証設定でこれを有効化する必要があります。

<div id="how-long-will-my-credentials-stay-valid">
  #### クレデンシャルはどのくらいの期間有効ですか？
</div>

デフォルトでは、Authorization Code Flow with PKCE を通じて作成したアクセストークンは、`offline.access` スコープを使用していない限り、2時間のみ有効です。

<div id="refresh-tokens">
  #### リフレッシュトークン
</div>

リフレッシュトークンを使用すると、リフレッシュトークンフローを通じてユーザーに再度プロンプトを表示することなく、アプリケーションは新しいアクセストークンを取得できます。

スコープ `offline.access` が適用されている場合、OAuth 2.0 のリフレッシュトークンが発行されます。このリフレッシュトークンを使用してアクセストークンを取得します。このスコープが指定されていない場合、リフレッシュトークンは生成されません。

リフレッシュトークンを使用して新しいアクセストークンを取得するためのリクエスト例は、次のとおりです。

```bash
POST 'https://api.x.com/2/oauth2/token' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'refresh_token=bWRWa3gzdnk3WHRGU1o0bmRRcTJ5VUxWX1lZTDdJSUtmaWcxbTVxdEFXcW5tOjE2MjIxNDc3NDM5MTQ6MToxOnJ0OjE' \
--data-urlencode 'grant_type=refresh_token' \
--data-urlencode 'client_id=rG9n6402A3dbUJKzXTNX4oWHJ
```

<div id="app-settings">
  #### アプリ設定
</div>

アプリの認証設定として、OAuth 1.0a または OAuth 2.0 を選択できます。アプリで OAuth 1.0a と OAuth 2.0 の両方を利用できるように有効化することもできます。

OAuth 2.0 は X API v2 でのみ使用できます。OAuth 2.0 を選択した場合、アプリの「キーとトークン」セクションに Client ID が表示されます。 

<div id="confidential-clients">
  #### 機密クライアント
</div>

[Confidential clients](https://datatracker.ietf.org/doc/html/rfc6749#section-2.1) は、資格情報を不正な第三者にさらすことなく安全な方法で保持し、認可サーバーと安全に認証を行うことで client secret を保護できます。Public クライアントは通常ブラウザ上やモバイルデバイス上で動作するため、client secret を安全に利用・保持することができません。機密クライアントの種類のアプリを選択すると、client secret が提供されます。 

developer portal で機密クライアントに該当するクライアントの種類を選択した場合、client secret も表示されます。選択肢は、Native App、Single page App、Web App、Automated App、または bot です。Native App と Single page App は Public クライアントであり、Web App および Automated App または bot は機密クライアントです。

有効な Authorization ヘッダーを使用する機密クライアントでは、client id は不要です。Public クライアントによるリクエストでは、引き続きリクエストボディ内に client id を含める必要があります。 

<div id="scopes">
  #### スコープ
</div>

スコープを使用すると、アプリに必要な権限だけを持たせるように、アプリのアクセス権限をきめ細かく設定できます。どのスコープがどのエンドポイントに対応しているかの詳細については、[認証マッピングガイド](/ja/resources/fundamentals/authentication/guides/v2-authentication-mapping)を参照してください。

|     |     |
| :--- | :--- |
| **Scope** | **説明** |
| tweet.read | あなたが閲覧できるすべてのポスト（保護されたアカウントからのポストも含む）。 |
| tweet.write | あなたに代わってポストおよびリポストを行います。 |
| tweet.moderate.write | あなたのポストへの返信を非表示／再表示します。 |
| users.email | 認証されたユーザーのメールアドレス。 |
| users.read | あなたが閲覧できるすべてのアカウント（保護されたアカウントも含む）。 |
| follows.read | あなたをフォローしているアカウントおよびあなたがフォローしているアカウント。 |
| follows.write | あなたに代わってアカウントのフォロー／フォロー解除を行います。 |
| offline.access | あなたがアクセス権を取り消すまで、あなたのアカウントとの接続を維持します。 |
| space.read | あなたが閲覧できるすべてのスペース。 |
| mute.read | あなたがミュートしているアカウント。 |
| mute.write | あなたに代わってアカウントのミュート／ミュート解除を行います。 |
| like.read | あなたが「いいね」したポストおよびあなたが閲覧できる「いいね」。 |
| like.write | あなたに代わってポストへの「いいね」および「いいね」の取り消しを行います。 |
| list.read | あなたが作成した、またはメンバーになっているリスト、そのリストのメンバーおよびフォロワー（非公開リストを含む）。 |
| list.write | あなたに代わってリストの作成と管理を行います。 |
| block.read | あなたがブロックしているアカウント。 |
| block.write | あなたに代わってアカウントのブロック／ブロック解除を行います。 |
| bookmark.read | 認証されたユーザーのブックマーク済みポストを取得します。 |
| bookmark.write | ポストに対するブックマークの追加および削除を行います。 |
| media.write | メディアをアップロードします。 |

<div id="rate-limits">
  #### レート制限
</div>

ほとんどの場合、レート制限は OAuth 1.0a で認証する場合と同じですが、Tweets lookup と Users lookup は例外です。Tweets lookup と Users lookup に OAuth 2.0 を使用する場合、アプリごとの上限を 15 分あたり 300 リクエストから 900 リクエストに引き上げています。詳しくは、[レート制限に関するドキュメント](/ja/resources/fundamentals/rate-limits)をご覧ください。

<div id="grant-types">
  #### グラントタイプ
</div>

この初期リリースでは、サポートされる[グラントタイプ](https://oauth.net/2/grant-types/)として、[PKCE](https://oauth.net/2/pkce/) を用いた [authorization code](https://oauth.net/2/grant-types/authorization-code/) と、[refresh token](https://oauth.net/2/grant-types/refresh-token/) のみを提供しています。将来的には、他のグラントタイプも提供する可能性があります。

<div id="oauth-20-flow">
  #### OAuth 2.0 フロー
</div>

OAuth 2.0 のフローは、現在 OAuth 1.0a で使用しているものとよく似ています。このトピックに関する図と詳しい解説は、[こちらのドキュメント](/ja/resources/fundamentals/authentication/oauth-1-0a/obtaining-user-access-tokens)で確認できます。 

<div id="glossary">
  #### 用語集
</div>

|     |     |
| :--- | :--- |
| **Term** | **Description** |
| Grant types | OAuth フレームワークでは、さまざまなユースケースに対応する複数のグラントタイプと、新しいグラントタイプを作成するためのフレームワークが定義されています。例として、authorization code、client credentials、device code、refresh token などがあります。 |
| Confidential client | Confidential client とは、登録済みの client secret を安全に保持するなど、認可サーバーに対して安全に認証を行えるアプリケーションです。 |
| Public client | Public client は、ブラウザやモバイルデバイス上で動作するアプリケーションなど、登録済みの client secret を利用できないクライアントです。 |
| Authorization code flow | Confidential client と Public client の両方が、authorization code をアクセストークンに交換するために使用するフローです。 |
| PKCE | Authorization code flow を拡張し、複数の攻撃を防止するとともに、Public client から安全に OAuth のやり取りを行えるようにする仕組みです。 |
| Client ID | developer portal のキーとトークンセクション内の「Client ID」という見出しの下に記載されています。これが表示されない場合は、弊社チームまで直接お問い合わせください。Client ID は authorize URL を生成する際に必要となります。 |
| Redirect URI | あなたのコールバック URL です。[厳密一致検証](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6) を通過している必要があります。 |
| Authorization code | アプリケーションがユーザーに代わって API を呼び出すことを可能にします。auth&#95;code と呼ばれます。auth&#95;code は、アプリ所有者がユーザーから承認済みの auth&#95;code を受け取ってから 30 秒間の有効期限があります。30 秒以内にアクセストークンと交換する必要があり、そうしない場合は auth&#95;code は失効します。 |
| Access token | アクセストークンは、アプリケーションがユーザーに代わって API リクエストを行う際に使用するトークンです。 |
| Refresh token | Refresh token フローを通じて、ユーザーに再度プロンプトを表示することなく、新しいアクセストークンを取得できるようにします。 |
| Client Secret | Confidential client タイプのアプリを選択している場合は、developer portal のアプリのキーとトークンセクションにおいて、「Client ID」の下に「Client Secret」が表示されます。 |

<div id="parameters">
  #### パラメーター
</div>

OAuth 2.0 の authorize URL を構築するには、認可 URL に次のパラメーターが含まれている必要があります。 

|     |     |
| :--- | :--- |
| **Parameter** | **Description** |
| response&#95;type | これは認可コードであることを示すために、値として文字列 &quot;code&quot; を指定する必要があります。 |
| client&#95;id | developer portal の「Client ID」という見出しの下で確認できます。 |
| redirect&#95;uri | コールバック URL です。この値は、アプリの設定で定義されている Callback URLs のいずれかと一致している必要があります。OAuth 2.0 では、コールバック URL に対して [exact match validation](https://datatracker.ietf.org/doc/html/rfc6749#section-10.6) が必要です。 |
| state | ランダムな文字列で、[CSRF 攻撃](https://auth0.com/docs/protocols/state-parameters) を防ぐための検証に使用します。 この文字列の長さは最大 500 文字まで指定できます。 |
| code&#95;challenge | 各リクエストごとにランダムに生成するシークレットである、[PKCE](https://www.oauth.com/oauth2-servers/pkce/authorization-request/) パラメーターです。 |
| code&#95;challenge&#95;method | リクエストに使用しているメソッドを指定します (S256 または plain)。 |

<div id="authorize-url">
  #### 認可URL
</div>

OAuth 2.0 では、X の「ログイン」と同様の認証フローを通じてユーザーを認証するために使用する認可URLを作成します。 

作成するURLの例は次のとおりです。

```
https://x.com/i/oauth2/authorize?response_type=code&client_id=M1M5R3BMVy13QmpScXkzTUt5OE46MTpjaQ&redirect_uri=https://www.example.com&scope=tweet.read%20users.read%20account.follows.read%20account.follows.write&state=state&code_challenge=challenge&code_challenge_method=plain
```

このURLが正しく機能するには、適切にエンコードされている必要があります。[パーセントエンコーディング](/ja/resources/fundamentals/authentication/oauth-1-0a/percent-encoding-parameters)に関するドキュメントを必ず参照してください。
