---
title: R と X API v2 のはじめ方
mode: wide
keywords: ["R プログラミング", "R チュートリアル", "R API", "統計解析", "データ分析", "R 言語", "R 連携"]
---

<div id="introduction">
  ## はじめに
</div>

このチュートリアルでは、プログラミング言語 R と X API v2 を使い始めるために必要なことを、順を追って解説します。R を使って
[user lookup](/ja/x-api/users/lookup/introduction) エンドポイントに接続し、
X API から返される JSON をどのように扱うかを紹介します。user lookup は
GET メソッドであり、ユーザー ID またはユーザー名で指定された 1 人または複数のユーザーに関する情報を返します。

ご存じない方のために説明すると、R は時系列解析、モデリング、可視化、その他のデータ分析といった一般的なデータサイエンスのタスクで最もよく使われる言語の 1 つであり、X API と組み合わせて利用されることもよくあります。user
lookup エンドポイントを使うと、
[user object](/ja/x-api/fundamentals/data-dictionary#user) を利用して、ある人物のフォロワー数と、その人物の自己紹介文のセンチメントスコアとの相関関係を判定できます。user object はまた、プロフィールで公開されている所在地情報に基づいて、アカウントのグループをマッピングすることにも使えます。

<div id="getting-started-with-the-x-api">
  ### X API を使い始める
</div>

X API v2 を利用する前に、まず
[サインアップ](https://developer.x.com/en/portal/petition/essential/basic-info)
して開発者アカウントを取得する必要があります。

開発者アカウントが承認されたら、最初に
[プロジェクト](/ja/resources/fundamentals/projects)
を作成する必要があります。プロジェクトを使用すると、X API の利用目的に基づいて作業を整理できるため、API へのアクセスを効果的に管理し、利用状況を監視できます。

各プロジェクトには 1 つの
[App](/ja/resources/fundamentals/developer-apps)
が含まれており、これを使って X API を利用するために必要な認証情報を生成できます。X API のはじめ方について詳しくは、ドキュメント内の
[getting started](/ja/x-api/getting-started/about-x-api)
セクションを参照してください。

<div id="getting-your-r-environment-set-up">
  ### R 環境のセットアップ
</div>

まず、[R をダウンロード](https://cloud.r-project.org/)する必要があります。これは
[CRAN の Web サイト](https://cran.r-project.org/)から行えます。

その後、R を扱うための環境として、
[RStudio](https://www.rstudio.com/)、[Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=Ikuyadeu.r-pack) 向けの R 拡張機能パック、
あるいは Python を使ってきた方であれば
[Jupyter Notebook](https://docs.anaconda.com/anaconda/navigator/tutorials/r-lang/)
などを利用できます。

<div id="setting-up-your-environment-variable">
  ### 環境変数の設定
</div>

これから示すコード例では、Bearer Token 用の環境変数を作成しておく必要があります。Bearer Token は、X API への認証を行い、リクエストを送信できるようにするためのものです。まず、`your-bearer-token` を、developer portal の自分のアプリの「キーとトークン」セクションで取得できる自分の Bearer Token に置き換えてください。スクリプトを書き始める前に、このコード行をコンソールで実行しておく必要があります。

```r
Sys.setenv(BEARER_TOKEN = "your-bearer-token")
```

<div id="making-your-request">
  ### リクエストの送信
</div>

[httr](https://cran.r-project.org/web/packages/httr/index.html) パッケージを使用すると、X API に HTTP リクエストを送信できます。まだインストールしていない場合は、R コンソールでこのパッケージをインストールしてください。また、JSON データを扱うための
[jsonlite](https://cran.r-project.org/web/packages/jsonlite/index.html) と、データ操作用の [dplyr](https://dplyr.tidyverse.org/) もインストールしておく必要があります。

```r
install.packages("httr")
install.packages("jsonlite")
install.packages("dplyr")
```

API に接続するための R スクリプトの作成を開始できます。ファイルの先頭で、`httr`、`jsonlite`、`dplyr` パッケージを読み込みます。

```r
require(httr)
require(jsonlite)
require(dplyr)
```

コードサンプルの最初のステップは、X API への認証を行うための準備です。アプリから取得した
[Bearer Token](/ja/resources/fundamentals/authentication#using-and-generating-an-app-only-bearer-token)
を用意し、認証のためにヘッダーに渡します。以下の例では、$BEARER&#95;TOKEN を自身のトークンに置き換えてください。

```r
bearer_token <- Sys.getenv("$BEARER_TOKEN")
headers <- c(`Authorization` = sprintf('Bearer %s', bearer_token))
```

認証の設定が完了したら、リクエストのパラメータを定義します。
デフォルトでは、取得した各ユーザーについて id、name、username が返されます。
追加の[フィールド](/ja/x-api/fundamentals/fields)や
[expansions](/ja/x-api/fundamentals/expansions) を指定することで、このペイロードを調整できます。
この例では、ユーザーのプロフィールの自己紹介文を取得するために user.fields=description を指定し、
さらにユーザーのピン留めされたポストを含めるための expansion を指定します。

```r
params <- list(`user.fields` = 'description', `expansions` = 'pinned_tweet_id')
```

これで、詳細情報を取得したい X ハンドル（アカウントとも呼ばれます）を使って URL をフォーマットする準備ができました。`readline` メソッドを使用して、このサンプルを再利用可能にします。調べたいハンドルを入力したら、`$USERNAME` を目的の X ハンドルに置き換えて、指定したハンドルを含むように URL をフォーマットします。

```r
handle <- readline('$USERNAME')
url_handle <- sprintf('https://api.x.com/2/users/by?usernames=%s', handle)
```

ここまで来たら、先ほど作成した URL に対して httr パッケージを使って GET リクエストを送り、ヘッダーに認証情報を指定し、定義したパラメータを渡します。レスポンスはテキストオブジェクトとして変数 obj に保存し、これを出力して、送信したリクエストの結果を確認できます。

```r
response <-
  httr::GET(url = url_handle,
    httr::add_headers(.headers = headers),
    query = params)
obj <- httr::content(response, as = "text")
print(obj)
```

<div id="working-with-our-json-payload">
  ### JSON ペイロードの扱い方
</div>

JSON を扱う際に私がよく使う方法の1つは、データフレームを使うことです。データフレームを使うと、
複雑にネストされたデータに簡単にアクセスできます。これを行うには、jsonlite パッケージの fromJSON メソッドを使って
ファイルをフラット化し、フィールドが同じオブジェクト内に入るようにします。次に、そのオブジェクトをデータフレームに渡します。
これで、このデータフレームを確認する準備が整いました。

```
json_data <- fromJSON(obj, flatten = TRUE) %>% as.data.frame View(json_data)
```

データフレームからデータのフィールドにアクセスし、それらを使ってハンドル、ユーザー名、自己紹介文を含む文字列を作成することができます。

```r
final <-
  sprintf(
    "ハンドル: %s\n自己紹介: %s\n固定ポスト: %s",
    json_data$data.username,
    json_data$data.description,
    json_data$includes.tweets.text
  )
```

取得している各フィールドの間に改行を入れてオブジェクトを表示するには、`print` の代わりに `cat` を使用してください。

```r
cat(final)
```

複数のハンドルに対してリクエストを送信している場合は、ループを使えば各データフレームの要素に簡単にアクセスできます。

<div id="conclusion">
  ### まとめ
</div>

このチュートリアルが、R と X API を扱う際の出発点となれば幸いです。次のステップとして、最近検索、ポスト取得、ユーザー取得向けの R のサンプルコードがある
[v2 sample code](https://github.com/xdevplatform) をぜひご確認ください。途中で問題が発生した場合は
[forums](https://devcommunity.x.com/) でお知らせいただくか、このチュートリアルからインスピレーションを得て何かを作成された場合は [@XDevelopers](https://x.com/XDevelopers) へポストしてお知らせください。