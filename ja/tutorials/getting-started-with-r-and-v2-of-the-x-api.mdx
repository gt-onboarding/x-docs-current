---
title: R と X API v2 入門
mode: wide
keywords: ["R プログラミング", "R チュートリアル", "R API", "統計解析", "データ分析", "R 言語", "R 連携"]
---

<div id="introduction">
  ## はじめに
</div>

このチュートリアルでは、プログラミング言語 R と X API v2 を使い始めるために必要な手順を順を追って説明します。R を使用して
[user lookup](/ja/x-api/users/lookup/introduction) エンドポイントに接続し、
X API から返される JSON をどのように扱うかを示します。user lookup は
GET メソッドのエンドポイントであり、ユーザー ID またはユーザー名で指定された 1 人または複数のユーザーに関する情報を返します。

R は、時系列分析、モデリング、可視化、その他のデータ分析といった一般的なデータサイエンスのタスクで広く利用されている言語の 1 つであり、X API と組み合わせて使われることもよくあります。user
lookup エンドポイントを使用すると、
[user object](/ja/x-api/fundamentals/data-dictionary#user) を用いて、ある人物が持つフォロワー数と、その人の自己紹介文の感情スコアとの相関関係を判定できます。user object は、プロフィールに公開されている所在地にもとづいてアカウントのグループをマッピングする用途にも使用できます。

<div id="getting-started-with-the-x-api">
  ### X API を使い始める
</div>

X API v2 を使用する前に、
[サインアップ](https://developer.x.com/en/portal/petition/essential/basic-info)
して開発者アカウントを取得する必要があります。

開発者アカウントが承認されたら、まず
[プロジェクト](/ja/resources/fundamentals/projects) を作成する必要があります。プロジェクトを使用すると、X API の利用目的に応じて作業内容を整理できるため、API へのアクセスを効果的に管理し、利用状況を把握できます。

各プロジェクトには [App](/ja/resources/fundamentals/developer-apps) が含まれており、X API を利用するために必要な認証情報を生成できます。
X API の始め方の詳細については、ドキュメント内の
[getting started](/ja/x-api/getting-started/about-x-api)
セクションを参照してください。

<div id="getting-your-r-environment-set-up">
  ### R 環境のセットアップ
</div>

まず、[R をダウンロード](https://cloud.r-project.org/)する必要があります。これは
[CRAN のウェブサイト](https://cran.r-project.org/)から行えます。

その後、R で作業する環境を整えるには、
[RStudio](https://www.rstudio.com/)、R 拡張機能パックを備えた
[Visual Studio Code](https://marketplace.visualstudio.com/items?itemName=Ikuyadeu.r-pack)、
あるいは Python を利用してきた場合は
[Jupyter Notebook](https://docs.anaconda.com/anaconda/navigator/tutorials/r-lang/)
を使用できます。

<div id="setting-up-your-environment-variable">
  ### 環境変数の設定
</div>

これから紹介するコードサンプルを実行するにあたっては、Bearer Token 用の環境変数を作成しておく必要があります。Bearer Token は、X API に対して認証を行い、リクエストを送信できるようにするためのものです。まず最初に、`"your-bearer-token"` を、自分の Bearer Token（developer portal 上の App の「Keys and tokens」セクションで取得できます）に置き換えてください。スクリプトを書き始める前に、この1行のコードをコンソールで実行しておく必要があります。

```r
Sys.setenv(BEARER_TOKEN = "your-bearer-token")
```

<div id="making-your-request">
  ### リクエストの送信
</div>

[httr](https://cran.r-project.org/web/packages/httr/index.html) パッケージを使用して、
X API への HTTP リクエストを送信できます。まだインストールしていない場合は、
コンソールからこのパッケージをインストールしてください。あわせて、
JSON オブジェクトを扱うための
[jsonlite](https://cran.r-project.org/web/packages/jsonlite/index.html) と、
データ操作用の [dplyr](https://dplyr.tidyverse.org/) もインストールする必要があります。

```r
install.packages("httr")
install.packages("jsonlite")
install.packages("dplyr")
```

API に接続するための R スクリプトの記述を開始できます。ファイルの先頭で、`httr`、`jsonlite`、`dplyr` パッケージを読み込みます。

```r
require(httr)
require(jsonlite)
require(dplyr)
```

コードサンプルの最初のステップは、X API へ認証するための準備をすることです。アプリから取得した
[Bearer Token](/ja/resources/fundamentals/authentication#using-and-generating-an-app-only-bearer-token) を用意し、認証のためヘッダーに渡してください。以下の
例では、$BEARER&#95;TOKEN を自分のトークンに置き換えてください。

```r
bearer_token <- Sys.getenv("$BEARER_TOKEN")
headers <- c(`Authorization` = sprintf('Bearer %s', bearer_token))
```

認証の設定が完了したら、リクエストのパラメータを定義します。
デフォルトでは、返される各ユーザーの id、name、username が返却されます。
このペイロードは、追加の
[fields](/ja/x-api/fundamentals/fields) や
[expansions](/ja/x-api/fundamentals/expansions) を指定することでカスタマイズできます。
この例では、user.fields=description で指定されるユーザーのプロフィールの自己紹介文と、
ユーザーのピン留めされたポストを含む expansion が必要になります。

```r
params <- list(`user.fields` = 'description', `expansions` = 'pinned_tweet_id')
```

これで、より詳しい情報を取得したい X のハンドル（アカウント名）を使って、URL を組み立てる準備ができました。サンプルを再利用可能にするために、`readline` メソッドを使用します。調べたいハンドルを入力したら、`$USERNAME` を目的の X ハンドルに置き換えて、指定したハンドルを含むように URL を組み立てます。

```r
handle <- readline('$USERNAME')
url_handle <- sprintf('https://api.x.com/2/users/by?usernames=%s', handle)
```

ここまで来たら、先ほど作成した URL に対して `httr` パッケージを使って GET リクエストを行い、ヘッダーで認証情報を渡し、さらに定義したパラメータを指定します。レスポンスはテキストオブジェクトとして変数 obj に保存でき、これを出力してリクエスト結果を確認できます。

```r
response <-
  httr::GET(url = url_handle,
    httr::add_headers(.headers = headers),
    query = params)
obj <- httr::content(response, as = "text")
print(obj)
```

<div id="working-with-our-json-payload">
  ### JSON ペイロードの操作
</div>

JSON を扱う際に私が好んで使う方法の 1 つは、データフレームを利用することです。データフレームを使うと、複雑にネストされたデータに簡単にアクセスできます。これを行うには、`jsonlite` パッケージの `fromJSON` メソッドを使ってファイルをフラット化し、フィールドが同一のオブジェクト内に収まるようにします。その後、そのオブジェクトをデータフレームに変換します。これで、このデータフレームを表示する準備が整いました。

```
json_data <- fromJSON(obj, flatten = TRUE) %>% as.data.frame View(json_data)
```

データフレームからデータのフィールドにアクセスし、それらを使ってハンドル、ユーザー名、自己紹介文を含む文字列を作成できます。

```r
final <-
  sprintf(
    "ハンドル: %s\n自己紹介: %s\n固定ポスト: %s",
    json_data$data.username,
    json_data$data.description,
    json_data$includes.tweets.text
  )
```

取得している各フィールドの間に改行を挿入してオブジェクトを表示するには、`print` ではなく `cat` を使用してください。

```r
cat(final)
```

複数のハンドルに対してリクエストを送信している場合は、ループを使えば、各データフレームの要素に簡単にアクセスできます。

<div id="conclusion">
  ### 結論
</div>

このチュートリアルが、R と X API を扱い始めるための出発点となれば幸いです。次のステップとして、recent search、Post lookup、user lookup 用の R 向けサンプルについては、私たちの
[v2 sample code](https://github.com/xdevplatform) を参照してください。途中で何か問題があれば
[forums](https://devcommunity.x.com/) でお知らせいただくか、このチュートリアルから何かを作りたくなったら [@XDevelopers](https://x.com/XDevelopers) へポストしてください。