---
title: ストリーミング
sidebarTitle: ストリーミング
---

X API は、[Filtered Stream エンドポイント](https://docs.x.com/x-api/posts/filtered-stream/introduction) などのエンドポイントを通じてリアルタイムのデータをサポートしており、条件に合致するポストを発生次第配信します。これには永続的な HTTP 接続の確立が必要です。

<div id="setup-and-basic-streaming">
  ## セットアップと基本的なストリーミング
</div>

<div id="synchronous">
  ### 同期
</div>

```python
from xdk import Client
# Clientを初期化
client = Client(bearer_token="your_bearer_token")
# ポストをストリーミング（最初にルールを設定してください）
for post_response in client.stream.posts():
    data = post_response.model_dump() if hasattr(post_response, 'model_dump') else dict(post_response)
    if 'data' in data and data['data']:
        tweet = data['data']
        post_text = tweet.get('text', '') if isinstance(tweet, dict) else (tweet.text if hasattr(tweet, 'text') else '')
        print(f"Post: {post_text}")
```


<div id="async">
  ### 非同期
</div>

```python
import asyncio
from asyncio import Queue
import threading
from xdk import Client
async def stream_posts_async(client: Client):
    queue = Queue()
    loop = asyncio.get_event_loop()
    stop = threading.Event()
    def run_stream():
        for post in client.stream.posts():
            if stop.is_set():
                break
            asyncio.run_coroutine_threadsafe(queue.put(post), loop)
        asyncio.run_coroutine_threadsafe(queue.put(None), loop)
    threading.Thread(target=run_stream, daemon=True).start()
    while True:
        post = await queue.get()
        if post is None:
            break
        data = post.model_dump()
        if 'data' in data and data['data']:
            print(f"投稿: {data['data'].get('text', '')}")
    stop.set()
async def main():
    client = Client(bearer_token="your_bearer_token")
    await stream_posts_async(client)
asyncio.run(main())
```


<div id="rule-management">
  ## ルール管理
</div>

ルールは、取得したい特定のデータ（キーワード、ユーザーなど）に対するフィルター条件を定義します。ルールの作成方法については、[このガイド](https://docs.x.com/x-api/posts/filtered-stream/integrate/build-a-rule)を参照してください。
**ルールの追加**:

```python
from xdk.stream.models import UpdateRulesRequest
# ルールを追加する
add_rules = {
    "add": [
        {"value": "from:xdevelopers", "tag": "official_updates"}
    ]
}
request_body = UpdateRulesRequest(**add_rules)
response = client.stream.update_rules(body=request_body)
```

**ルールの削除**:

```python
from xdk.stream.models import UpdateRulesRequest
delete_rules = {
    "delete": {
        "ids": ["rule_id_1", "rule_id_2"]
    }
}
request_body = UpdateRulesRequest(**delete_rules)
response = client.stream.update_rules(body=request_body)
```

**ルール一覧**:

```python
# get_rules returns an Iterator, so iterate over it
for page in client.stream.get_rules():
    if page.data:
        for rule in page.data:
            # ルール属性にアクセス - Pydantic モデルは属性アクセスと辞書アクセスの両方をサポートします
            rule_id = rule.id if hasattr(rule, 'id') else rule.get('id', '')
            rule_value = rule.value if hasattr(rule, 'value') else rule.get('value', '')
            rule_tag = rule.tag if hasattr(rule, 'tag') else rule.get('tag', '')
            print(f"ID: {rule_id}, Value: {rule_value}, Tag: {rule_tag}")
    break  # Remove break to get all pages
```

ルール構文の詳細については、[X ストリーミングルールのドキュメント](https://developer.x.com/en/docs/twitter-api/tweets/filtered-stream/integrate/build-a-rule)を参照してください。


<div id="troubleshooting">
  ## トラブルシューティング
</div>

- **403 Forbidden**: 認証情報が無効であるか、権限が不足しています。
- **420 Enhance Your Calm**: レート制限に達しています。一定時間待ってから再試行してください。
- **No Data**: `get_rules()` でルールを確認し、一致するポストが存在することを確認してください。
Python XDK を使った詳しいコード例については、[コードサンプルの GitHub リポジトリ](https://github.com/xdevplatform/samples/tree/main/python)を参照してください。
さらに多くのサンプルや API リファレンスについては、インラインの docstring（例: `help(client.tweets.search_recent)`）やソースコード内の生成済みスタブを参照してください。[GitHub リポジトリ](https://github.com/xdevplatform/xdk/tree/main/xdk/python)からフィードバックをお寄せください。